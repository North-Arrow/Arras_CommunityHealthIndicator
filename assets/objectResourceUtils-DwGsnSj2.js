const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-WiGBionk.js","assets/MapPage-DkZzMXd_.js","assets/index-By_q5Om-.js","assets/index-DydP-41E.css","assets/themeLevelStore-BsK05iL2.js","assets/MapPage-ChSTdz8n.css","assets/Version-mSMb5vJv.js","assets/mat4-BsI5KmMu.js","assets/quat-BdbEWOCv.js","assets/quatf64-aQ5IuZRd.js","assets/vec32-qc_RA5DZ.js","assets/vec42-B8vqJCvy.js","assets/BufferView-Btk_1Rf8.js","assets/vec2f64-DCcDeJvX.js","assets/vec4f64-CvoGn1-Y.js","assets/resourceUtils-BglTqjf6.js","assets/enums-CVsE7NBb.js"])))=>i.map(i=>d[i]);
import{_ as wt}from"./index-By_q5Om-.js";import{H as bt,dU as Gt,s as at,eS as ot,a_ as Nt,d3 as ut,et as jt,fs as Z,dR as G,a7 as Xt,X as ct,hR as Wt,v as qt,u as Kt,hS as Zt,x as Yt,aZ as D,dN as ht,gZ as Qt,eT as st,bO as $t,he as mt,ee as dt,f as vt,U as Jt,hT as At,fE as Q,dL as te,bi as ee,hU as it,dE as re,dF as pt,dG as se}from"./MapPage-DkZzMXd_.js";import{a as ie}from"./devEnvironmentUtils-8WtPGj6h.js";import{h as ne}from"./mat4-BsI5KmMu.js";import{a as ae}from"./vec2f64-DCcDeJvX.js";import{o as P,u as R,g as O,W as oe,E as nt,c as le,i as gt,r as ue,A as ce,I as he}from"./vec32-qc_RA5DZ.js";import{A as Y,_ as me,h as de,S as pe,n as ge,a as fe,e as _e,b as xe,c as Te,P as J,d as ye,o as we,f as j,s as be,t as $e}from"./DefaultMaterial-CogR0S8e.js";import{s as Mt,o as Et,T as It,g as ve,M as Ae,O as Me,V as Ee}from"./BufferView-Btk_1Rf8.js";import{r as Ie,n as Ce,d as ft,l as _t}from"./vec3-C7B19UZm.js";import{o as Re,d as xt}from"./vec4-C-lN8Fui.js";import{l as Se,o as Fe,n as Pe}from"./indexUtils-CCBSf6rH.js";import{t as X}from"./resourceUtils-BglTqjf6.js";import{a as Oe,i as Be}from"./vec2f32-CaVKkSa6.js";import{_ as Ct}from"./asyncUtils-3yuXbjd8.js";import{u as De}from"./memoryEstimations-ChwxhUsA.js";import{r as Rt}from"./Version-mSMb5vJv.js";import{e as Le,A as St}from"./Indices-lbUMioNT.js";import{t as U}from"./orientedBoundingBox-t7-_aOom.js";import{r as He}from"./videoUtils-Cu9ILvA_.js";import{Y as V}from"./enums-CVsE7NBb.js";import"./themeLevelStore-BsK05iL2.js";import"./sphere-DxZLT2oO.js";import"./vec4f64-CvoGn1-Y.js";import"./vectorStacks-DrtKr5gA.js";import"./quatf64-aQ5IuZRd.js";import"./frustum-CoWmYjWY.js";import"./vec42-B8vqJCvy.js";import"./plane-D6JpyU-k.js";import"./InterleavedLayout-CWSqX_m1.js";import"./types-BKo2foNY.js";import"./VertexAttributeLocations-W6y2attr.js";import"./glsl-B5bJgrnA.js";import"./OperationalLayer-BXYCm5gU.js";import"./time-ClENgjgA.js";import"./Cyclical-BgwKYFlt.js";import"./projectionUtils-BWBV91Ee.js";import"./projectVectorToVector-BMW13iTP.js";import"./projectPointToVector-DookL0mt.js";import"./normalizeUtils-CMkvqFtC.js";import"./normalizeUtilsCommon-CPHtsH55.js";import"./quat-BdbEWOCv.js";import"./spatialReferenceEllipsoidUtils-DomXS16Q.js";import"./computeTranslationToOriginAndRotation-Zyj_XBgA.js";async function Ft(s,t){const{data:e}=await bt(s,{responseType:"image",...t});return e}function Ue(){return Tt??=(async()=>{const s=await wt(()=>import("./basis_transcoder-DuG70Smz.js"),[]),t=await s.default({locateFile:e=>Gt(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),Tt}let Tt,E=null,W=null;async function Pt(){return W==null&&(W=Ue(),E=await W),W}function Ve(s,t){if(E==null)return s.byteLength;const e=new E.BasisFile(new Uint8Array(s)),r=Bt(e)?Ot(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),r}function ke(s,t){if(E==null)return s.byteLength;const e=new E.KTX2File(new Uint8Array(s)),r=Dt(e)?Ot(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),r}function Ot(s,t,e,r,n){const o=me(t?V.COMPRESSED_RGBA8_ETC2_EAC:V.COMPRESSED_RGB8_ETC2),a=n&&s>1?(4**s-1)/(3*4**(s-1)):1;return Math.ceil(e*r*o*a)}function Bt(s){return s.getNumImages()>=1&&!s.isUASTC()}function Dt(s){return s.getFaces()>=1&&s.isETC1S()}async function ze(s,t,e){E==null&&(E=await Pt());const r=new E.BasisFile(new Uint8Array(e));if(!Bt(r))return null;r.startTranscoding();const n=Lt(s,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(o,a)=>r.getImageTranscodedSizeInBytes(0,o,a),(o,a,l)=>r.transcodeImage(l,0,o,a,0,0));return r.close(),r.delete(),n}async function Ge(s,t,e){E==null&&(E=await Pt());const r=new E.KTX2File(new Uint8Array(e));if(!Dt(r))return null;r.startTranscoding();const n=Lt(s,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(o,a)=>r.getImageTranscodedSizeInBytes(o,0,0,a),(o,a,l)=>r.transcodeImage(l,o,0,0,a,0,-1,-1));return r.close(),r.delete(),n}function Lt(s,t,e,r,n,o,a,l){const{compressedTextureETC:c,compressedTextureS3TC:i}=s.capabilities,[u,h]=c?r?[1,V.COMPRESSED_RGBA8_ETC2_EAC]:[0,V.COMPRESSED_RGB8_ETC2]:i?r?[3,V.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,V.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],g=t.hasMipmap?e:Math.min(1,e),m=[];for(let d=0;d<g;d++)m.push(new Uint8Array(a(d,u))),l(d,u,m[d]);return t.internalFormat=h,t.hasMipmap=m.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=n,t.height=o,new Y(s,t,{type:"compressed",levels:m})}const q=16;function yt(s,t){return t=Math.floor(t/q)*q,Math.min(Math.round(s/q)*q,t)}function Ne(s,t){const[e,r]=je(s,t);return s.width===e&&s.height===r?s:Ht(s,e,r)}function je({width:s,height:t},{maxPreferredTexturePixels:e,maxTextureSize:r}){const n=Math.max(s,t),o=s*t;if(n<=r&&o<=e)return[s,t];const a=Math.min(Math.sqrt(e/o),r/n);return[yt(Math.round(s*a),r),yt(Math.round(t*a),r)]}function Ht(s,t,e){if(s instanceof ImageData)return Ht(Xe(s),t,e);const r=document.createElement("canvas");return r.width=t,r.height=e,r.getContext("2d").drawImage(s,0,0,r.width,r.height),r}function Xe(s){const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");if(e==null)throw new at("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return e.putImageData(s,0,0),t}let Ut=class{constructor(t,e){this._data=t,this.id=ot(),this.events=new Nt,this._parameters={...qe,...e},this._startPreload(t)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(t){t instanceof HTMLVideoElement?(this.update=e=>this._update(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t)}_startPreloadVideoElement(t){if(!(ut(t.src)||t.preload==="auto"&&t.crossOrigin)&&(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src,t.paused&&t.autoplay)){const e=[];He(t,r=>e.push(r)).then(()=>{t.play()}).finally(()=>e.forEach(r=>r.remove()))}}_startPreloadImageElement(t){jt(t.src)||ut(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const e=new de;return e.wrapMode=this._parameters.wrap??10497,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?9987:9729,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e.dataType=this._parameters.dataType??e.dataType,e.pixelFormat=this._parameters.pixelFormat??e.pixelFormat,e.internalFormat=this._parameters.internalFormat??e.internalFormat,e}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||We(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const e=this._data;return e==null?(this._glTexture=new Y(t,this._createDescriptor(t),null),this._glTexture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):Z(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,e):G(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,new Uint8Array(e)):(G(e)||Z(e))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(t,e):(G(e)||Z(e))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(t,e):G(e)?this._loadFromPixelData(t,new Uint8Array(e)):Xt(e)?this._loadFromPixelData(t,e):null)}_update(t,e){return this._glTexture==null||t.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=pe(t,this._createDescriptor(t),e),this._emptyTexture=null,this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>Ge(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,e){return this._loadAsync(()=>ze(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,e){Mt(this._parameters.width>0&&this._parameters.height>0);const r=this._createDescriptor(t);return r.pixelFormat!==6407&&r.pixelFormat!==6408||(r.compress=this._parameters.compressionOptions),r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new Y(t,r,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(async r=>{const n=await Ft(e,{signal:r});return ct(r),this._loadFromImage(t,n)})}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(async r=>{const n=await Wt(e,e.src,!1,r);return ct(r),this._loadFromImage(t,n)})}_loadFromVideoElement(t,e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(r=>new Promise((n,o)=>{const a=()=>{e.removeEventListener("loadeddata",l),e.removeEventListener("error",c),Yt(i)},l=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(t,e)))},c=u=>{a(),o(u||new at("texture:load-error","Failed to load video"))};e.addEventListener("loadeddata",l),e.addEventListener("error",c);const i=qt(r,()=>c(Kt()))}))}_loadFromImage(t,e){let r=e;r instanceof HTMLVideoElement||(r=Ne(r,t.parameters));const n=Vt(r);this._parameters.width=n.width,this._parameters.height=n.height;const o=this._createDescriptor(t);return o.width=n.width,o.height=n.height,o.compress=this._parameters.compressionOptions,this._glTexture=new Y(t,o,r),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(t){const e=new AbortController;this._loadingController=e;const r=t(e.signal);this._loadingPromise=r;const n=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null),this._emptyTexture=null};return r.then(n,n),r}unload(){if(this._glTexture=Zt(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function We(s,t){if(s==null)return 0;if(G(s)||Z(s))return t.encoding==="image/ktx2"?ke(s,!!t.mipmap):t.encoding==="image/x.basis"?Ve(s,!!t.mipmap):s.byteLength;const{width:e,height:r}=s instanceof Image||s instanceof ImageData||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement?Vt(s):t,n=t.pixelFormat??6408,o=ge(n);return(t.mipmap?4/3:1)*e*r*o||0}function Vt(s){return s instanceof HTMLVideoElement?{width:s.videoWidth,height:s.videoHeight}:s}const qe={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};let Ke=class{constructor(t){this.id=ot(),this._attributes=new Map;for(const[e,r]of t)this._attributes.set(e,{...r,indices:Le(r.indices)})}get attributes(){return this._attributes}};function Ze(s,t){if(!s)return!1;const{size:e,data:r,indices:n}=s;P(t,0,0,0),P(A,0,0,0);let o=0,a=0;for(let l=0;l<n.length-2;l+=3){const c=n[l]*e,i=n[l+1]*e,u=n[l+2]*e;P(f,r[c],r[c+1],r[c+2]),P(S,r[i],r[i+1],r[i+2]),P(K,r[u],r[u+1],r[u+2]);const h=fe(f,S,K);h?(R(f,f,S),R(f,f,K),O(f,f,1/3*h),R(t,t,f),o+=h):(R(A,A,f),R(A,A,S),R(A,A,K),a+=3)}return(a!==0||o!==0)&&(o!==0?(O(t,t,1/o),!0):a!==0&&(O(t,A,1/a),!0))}function Ye(s,t){if(!s)return!1;const{size:e,data:r,indices:n}=s;P(t,0,0,0);let o=-1,a=0;for(let l=0;l<n.length;l++){const c=n[l]*e;o!==c&&(t[0]+=r[c],t[1]+=r[c+1],t[2]+=r[c+2],a++),o=c}return a>1&&O(t,t,1/a),a>0}function Qe(s,t,e){if(!s)return!1;P(e,0,0,0),P(A,0,0,0);let r=0,n=0;const{size:o,data:a,indices:l}=s,c=l.length-1,i=c+(t?2:0);for(let u=0;u<i;u+=2){const h=u<c?u+1:0,g=l[u<c?u:c]*o,m=l[h]*o;f[0]=a[g],f[1]=a[g+1],f[2]=a[g+2],S[0]=a[m],S[1]=a[m+1],S[2]=a[m+2],O(f,R(f,f,S),.5);const d=oe(f,S);d>0?(R(e,e,O(f,f,d)),r+=d):r===0&&(R(A,A,f),n++)}return r!==0?(O(e,e,1/r),!0):n!==0&&(O(e,A,1/n),!0)}const f=D(),S=D(),K=D(),A=D();let Je=class{constructor(){this.uid=ot()}};class tr extends Je{constructor(t){super(),this.highlightName=t,this.channel=0}}class tt extends Ke{constructor(t,e,r=null,n=0,o=null,a=-1,l){super(e),this.material=t,this.mapPositions=r,this.type=n,this.olidColor=o,this.edgeIndicesLength=a,this.baseGeometry=l,this._highlights=null,this._highlightOptionsCounts=null,this.visible=!0,this._boundingInfo=null;const c=this.positionAttribute;c!=null&&this.edgeIndicesLength<0&&(this.edgeIndicesLength=c.indices.length)}instantiate(t={}){const e=new tt(t.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength,this.baseGeometry);return this._attributes.forEach((r,n)=>{r.exclusive=!1,e._attributes.set(n,r)}),e._boundingInfo=this._boundingInfo,e.transformation=t.transformation||this.transformation,e}getMutableAttribute(t){let e=this._attributes.get(t);return e&&!e.exclusive&&(e={...e,exclusive:!0,data:_e(e.data)},this._attributes.set(t,e)),e}setAttributeData(t,e){const r=this._attributes.get(t);r?this._attributes.set(t,{...r,exclusive:!0,data:e}):xe()&&console.warn(`Setting undefined attribute ${t} data`)}get positionAttribute(){return this.attributes.get("position")??this.baseGeometry?.attributes.get("position")}get indexCount(){return this._attributes.values().next().value?.indices?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===0?this._computeAttachmentOriginTriangles(t):this.type===2?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&nt(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const e=this.positionAttribute;return Ze(e,t)}_computeAttachmentOriginLines(t){const e=this.positionAttribute;return Qe(e,er(this.material.parameters,e),t)}_computeAttachmentOriginPoints(t){const e=this.positionAttribute;return Ye(e,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.positionAttribute;if(!t||t.indices.length===0)return null;const e=this.type===0?3:1;Mt(t.indices.length%e===0,"Indexing error: "+t.indices.length+" not divisible by "+e);const r=St(t.indices.length/e);return new Te(r,e,t)}get transformation(){return this._transformation??ht}set transformation(t){this._transformation=t&&t!==ht?Qt(t):null}get highlights(){return this._highlights||rr}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(t){this._highlightOptionsCounts?.forEach((e,r)=>t(r))}allocateIdAndHighlight(t){const e=new tr(t);return this.addHighlight(e)}addHighlight(t){this._ensureHighlights().add(t);const{highlightName:e}=t,r=(this._highlightOptionsCounts?.get(e)??0)+1;return this._ensureHighlightOptionsCounts().set(e,r),t}_ensureHighlights(){let t=this._highlights;return t||(t=new Set,this._highlights=t),t}_ensureHighlightOptionsCounts(){let t=this._highlightOptionsCounts;return t||(t=new Map,this._highlightOptionsCounts=t),t}removeHighlight(t){if(this._highlights?.delete(t)){const{highlightName:e}=t,r=this._highlightOptionsCounts?.get(e)??0;r<=1?this._highlightOptionsCounts?.delete(e):this._ensureHighlightOptionsCounts().set(e,r-1)}}}function er(s,t){return!(!("isClosed"in s)||!s.isClosed)&&t.indices.length>2}const rr=new Set;function z(s){if(s==null)return null;const t=s.offset!=null?s.offset:Oe,e=s.rotation!=null?s.rotation:0,r=s.scale!=null?s.scale:Be,n=st(1,0,0,0,1,0,t[0],t[1],1),o=st(Math.cos(e),-Math.sin(e),0,Math.sin(e),Math.cos(e),0,0,0,1),a=st(r[0],0,0,0,r[1],0,0,0,1),l=$t();return mt(l,o,a),mt(l,n,l),l}class sr{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}let ir=class{constructor(t,e,r){this.name=t,this.lodThreshold=e,this.pivotOffset=r,this.stageResources=new sr,this.numberOfVertices=0}};class lt{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get outerSize(){return this._outer.size}get size(){let t=0;for(const e of this._outer.values())t+=e.size;return t}get(t,e){return this._outer.get(t)?.get(e)}getInner(t){return this._outer.get(t)}set(t,e,r){const n=this._outer.get(t);n?n.set(e,r):this._outer.set(t,new Map([[e,r]]))}delete(t,e){const r=this._outer.get(t);r&&(r.delete(e),r.size===0&&this._outer.delete(t))}pop(t,e){const r=this.get(t,e);return this.delete(t,e),r}*outerMap(){for(const t of this._outer)yield t}*values(){for(const t of this._outer.values())yield*t.values()}*[Symbol.iterator](){for(const[t,e]of this._outer)for(const[r,n]of e)yield[t,r,n]}forEach(t){this._outer.forEach((e,r)=>t(e,r))}forAll(t){this._outer.forEach((e,r)=>e.forEach((n,o)=>t(n,r,o)))}copy(){const t=new lt;return this.forAll((e,r,n)=>t.set(r,n,e)),t}}const C=()=>Jt.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class nr{constructor(t,e,r){this.resource=t,this.textures=e,this.usedMemory=r}}async function ar(s,t){const e=await or(s,t),r=await mr(e.textureDefinitions??{},t);let n=0;for(const o in r)if(r.hasOwnProperty(o)){const a=r[o];n+=a?.image?a.image.width*a.image.height*4:0}return new nr(e,r,n+De(e))}async function or(s,t){const e=t?.streamDataRequester;if(e)return lr(s,e,t);const r=await Ct(bt(s,t));if(r.ok===!0)return r.value.data;vt(r.error),kt(r.error)}async function lr(s,t,e){const r=await Ct(t.request(s,0,e));if(r.ok===!0)return r.value;vt(r.error),kt(r.error.details.url)}function kt(s){throw new at("",`Request for object resource failed: ${s}`)}function ur(s){const t=s.params,e=t.topology;let r=!0;switch(t.vertexAttributes||(C().warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const o=t.faces;if(o){if(t.vertexAttributes)for(const a in t.vertexAttributes){const l=o[a];l?.values?(l.valueType!=null&&l.valueType!=="UInt32"&&(C().warn(`Unsupported indexed geometry indices type '${l.valueType}', only UInt32 is currently supported`),r=!1),l.valuesPerElement!=null&&l.valuesPerElement!==1&&(C().warn(`Unsupported indexed geometry values per element '${l.valuesPerElement}', only 1 is currently supported`),r=!1)):(C().warn(`Indexed geometry does not specify face indices for '${a}' attribute`),r=!1)}}else C().warn("Indexed geometries must specify faces"),r=!1;break}default:C().warn(`Unsupported topology '${e}'`),r=!1}s.params.material||(C().warn("Geometry requires material"),r=!1);const n=s.params.vertexAttributes;for(const o in n)n[o].values||(C().warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function cr(s,t){const e=new Array,r=new Array,n=new Array,o=new lt,a=s.resource,l=Rt.parse(a.version||"1.0","wosr");pr.validate(l);const c=a.model.name,i=a.model.geometries,u=a.materialDefinitions??{},h=s.textures;let g=0;const m=new Map;for(let d=0;d<i.length;d++){const p=i[d];if(!ur(p))continue;const b=dr(p),y=p.params.vertexAttributes,$=[],T=_=>{if(p.params.topology==="PerAttributeArray")return null;const w=p.params.faces;for(const x in w)if(x===_)return w[x].values;return null},v=y.position,N=v.values.length/v.valuesPerElement;for(const _ in y){const w=y[_],x=w.values,rt=T(_)??St(N);$.push([_,new U(x,rt,w.valuesPerElement,!0)])}const M=b.texture,F=h&&h[M];if(F&&!m.has(M)){const{image:_,parameters:w}=F,x=new Ut(_,w);r.push(x),m.set(M,x)}const k=m.get(M),B=k?k.id:void 0,L=b.material;let I=o.get(L,M);if(I==null){const _=u[L.slice(L.lastIndexOf("/")+1)].params;_.transparency===1&&(_.transparency=0);const w=F?zt(F.alphaChannelUsage):void 0,x={ambient:dt(_.diffuse),diffuse:dt(_.diffuse),opacity:1-(_.transparency||0),textureAlphaMode:w,textureAlphaCutoff:.33,textureId:B,doubleSided:!0,cullFace:0,colorMixMode:_.externalColorMixMode||"tint",textureAlphaPremultiplied:F?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(x,t.materialParameters),I=new J(x,t),o.set(L,M,I)}n.push(I);const et=new tt(I,$);g+=$.find(_=>_[0]==="position")?.[1]?.indices.length??0,e.push(et)}return{engineResources:[{name:c,stageResources:{textures:r,materials:n,geometries:e},pivotOffset:a.model.pivotOffset,numberOfVertices:g,lodThreshold:null}],referenceBoundingBox:hr(e)}}function hr(s){const t=At();return s.forEach(e=>{const r=e.boundingInfo;r!=null&&(Q(t,r.bbMin),Q(t,r.bbMax))}),t}async function mr(s,t){const e=new Array;for(const o in s){const a=s[o],l=a.images[0].data;if(!l){C().warn("Externally referenced texture data is not yet supported");continue}const c=a.encoding+";base64,"+l,i="/textureDefinitions/"+o,u=a.channels==="rgba"?a.alphaChannelUsage||"transparency":"none",h={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:zt(u)!==1},g=t?.disableTextures?Promise.resolve(null):Ft(c,t);e.push(g.then(m=>({refId:i,image:m,parameters:h,alphaChannelUsage:u})))}const r=await Promise.all(e),n={};for(const o of r)n[o.refId]=o;return n}function zt(s){switch(s){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function dr(s){const t=s.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const pr=new Rt(1,2,"wosr");async function ps(s,t){const e=gr(ie(s));if(e.fileType==="wosr"){const h=await(t.cache?t.cache.loadWOSR(e.url,t):ar(e.url,t)),{engineResources:g,referenceBoundingBox:m}=cr(h,t);return{lods:g,referenceBoundingBox:m,isEsriSymbolResource:!1,isWosr:!0}}let r;if(t.cache)r=await t.cache.loadGLTF(e.url,t,!!t.usePBR);else{const{loadGLTF:h}=await wt(()=>import("./loader-WiGBionk.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]));r=await h(new Se(t.streamDataRequester),e.url,t,t.usePBR)}const n=r.model.meta?.ESRI_proxyEllipsoid,o=r.meta.isEsriSymbolResource&&n!=null&&r.meta.ESRI_webstyle==="EsriRealisticTreesStyle";o&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,yr(r,n));const a=!!t.usePBR,l=r.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:o,mrrFactors:be}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:$e},c={...t.materialParameters,treeRendering:o},{engineResources:i,referenceBoundingBox:u}=fr(r,l,c,t,e.specifiedLodIndex,o);return{lods:i,referenceBoundingBox:u,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}}function gr(s){const t=s.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:s.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:s,specifiedLodIndex:null}:{fileType:"unknown",url:s,specifiedLodIndex:null}}function fr(s,t,e,r,n,o){const a=s.model,l=new Array,c=new Map,i=new Map,u=a.lods.length,h=At();return a.lods.forEach((g,m)=>{const d=r.skipHighLods===!0&&(u>1&&m===0||u>3&&m===1)||r.skipHighLods===!1&&n!=null&&m!==n;if(d&&m!==0)return;const p=new ir(g.name,g.lodThreshold,[0,0,0]);g.parts.forEach(b=>{const y=d?new J({},r):_r(a,b,p,t,e,c,i,r,o),{geometry:$,vertexCount:T}=xr(b,y??new J({},r)),v=$.boundingInfo;v!=null&&m===0&&(Q(h,v.bbMin),Q(h,v.bbMax)),y!=null&&(p.stageResources.geometries.push($),p.numberOfVertices+=T)}),d||l.push(p)}),{engineResources:l,referenceBoundingBox:h}}function _r(s,t,e,r,n,o,a,l,c){const i=s.materials.get(t.material);if(i==null)return null;const{normal:u,color:h,texCoord0:g,tangent:m}=t.attributes,d=t.material+(u?"_normal":"")+(h?"_color":"")+(g?"_texCoord0":"")+(m?"_tangent":""),p=t.attributes.texCoord0!=null,b=t.attributes.normal!=null,y=Tr(i.alphaMode);if(!o.has(d)){if(p){const B=(I,et=!1,_=!1)=>{if(I!=null&&!a.has(I)){const w=s.textures.get(I);if(w){const x=w.data,rt=et&&!X(x)?l.compressionOptions:void 0;a.set(I,new Ut(X(x)?x.data:x,{...w.parameters,preMultiplyAlpha:!X(x)&&_,encoding:X(x)?x.encoding:void 0,compressionOptions:rt}))}}},L=y!==1&&!c;B(i.colorTexture,L,y!==1),B(i.normalTexture),B(i.occlusionTexture,!0),B(i.emissiveTexture),B(i.metallicRoughnessTexture,!0)}const T=it(i.color[0]),v=it(i.color[1]),N=it(i.color[2]),M=i.colorTexture!=null&&p?a.get(i.colorTexture):null,F=ye(i),k=i.normalTextureTransform?.scale!=null?i.normalTextureTransform?.scale:ae;o.set(d,new J({...r,customDepthTest:1,textureAlphaMode:y,textureAlphaCutoff:i.alphaCutoff,diffuse:[T,v,N],ambient:[T,v,N],opacity:i.alphaMode==="OPAQUE"?1:i.opacity,doubleSided:i.doubleSided,doubleSidedType:"winding-order",cullFace:i.doubleSided?0:2,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:b?0:2,castShadows:!0,receiveShadows:i.receiveShadows,receiveAmbientOcclusion:i.receiveAmbientOcclusion,textureId:M?.id,colorMixMode:i.colorMixMode,normalTextureId:i.normalTexture!=null&&p?a.get(i.normalTexture).id:void 0,textureAlphaPremultiplied:M!=null&&!!M.parameters.preMultiplyAlpha,occlusionTextureId:i.occlusionTexture!=null&&p?a.get(i.occlusionTexture).id:void 0,emissiveTextureId:i.emissiveTexture!=null&&p?a.get(i.emissiveTexture).id:void 0,metallicRoughnessTextureId:i.metallicRoughnessTexture!=null&&p?a.get(i.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[i.emissiveFactor[0],i.emissiveFactor[1],i.emissiveFactor[2]],mrrFactors:F?we:[i.metallicFactor,i.roughnessFactor,r.mrrFactors[2]],isSchematic:F,colorTextureTransformMatrix:z(i.colorTextureTransform),normalTextureTransformMatrix:z(i.normalTextureTransform),scale:[k[0],k[1]],occlusionTextureTransformMatrix:z(i.occlusionTextureTransform),emissiveTextureTransformMatrix:z(i.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:z(i.metallicRoughnessTextureTransform),...n},l))}const $=o.get(d);if(e.stageResources.materials.push($),p){const T=v=>{v!=null&&e.stageResources.textures.push(a.get(v))};T(i.colorTexture),T(i.normalTexture),T(i.occlusionTexture),T(i.emissiveTexture),T(i.metallicRoughnessTexture)}return $}function xr(s,t){const e=s.attributes.position.count,r=Fe(s.indices||e,s.primitiveType),n=j(3*e),{typedBuffer:o,typedBufferStride:a}=s.attributes.position;Ie(n,o,s.transform,3,a);const l=[["position",new U(n,r,3,!0)]];if(s.attributes.normal!=null){const i=j(3*e),{typedBuffer:u,typedBufferStride:h}=s.attributes.normal;re(H,s.transform),Ce(i,u,H,3,h),pt(H)&&ft(i,i),l.push(["normal",new U(i,r,3,!0)])}if(s.attributes.tangent!=null){const i=j(4*e),{typedBuffer:u,typedBufferStride:h}=s.attributes.tangent;se(H,s.transform),Re(i,u,H,4,h),pt(H)&&ft(i,i,4),l.push(["tangent",new U(i,r,4,!0)])}if(s.attributes.texCoord0!=null){const i=j(2*e),{typedBuffer:u,typedBufferStride:h}=s.attributes.texCoord0;Pe(i,u,2,h),l.push(["uv0",new U(i,r,2,!0)])}const c=s.attributes.color;if(c!=null){const i=new Uint8Array(4*e);c.elementCount===4?c instanceof It?xt(i,c,1,255):(c instanceof ve||c instanceof Ae)&&xt(i,c,1/255,255):(i.fill(255),c instanceof Et?_t(i,c.typedBuffer,1,255,4,c.typedBufferStride):(s.attributes.color instanceof Me||s.attributes.color instanceof Ee)&&_t(i,c.typedBuffer,1/255,255,4,s.attributes.color.typedBufferStride)),l.push(["color",new U(i,r,4,!0)])}return{geometry:new tt(t,l),vertexCount:e}}const H=$t();function Tr(s){switch(s){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function yr(s,t){for(let e=0;e<s.model.lods.length;++e){const r=s.model.lods[e];for(const n of r.parts){const o=n.attributes.normal;if(o==null)return;const a=n.attributes.position,l=a.count,c=D(),i=D(),u=D(),h=new Float32Array(4*l),g=new Float32Array(3*l),m=ne(te(),n.transform);let d=0,p=0;for(let b=0;b<l;b++){a.getVec(b,i),o.getVec(b,c),nt(i,i,n.transform),le(u,i,t.center),gt(u,u,t.radius);const y=u[2],$=ue(u),T=Math.min(.45+.55*$*$,1)**ee;gt(u,u,t.radius),m!==null&&nt(u,u,m),ce(u,u),e+1!==s.model.lods.length&&s.model.lods.length>1&&he(u,u,c,y>-1?.2:Math.min(-4*y-3.8,1)),g[d]=u[0],g[d+1]=u[1],g[d+2]=u[2],d+=3,h[p]=T,h[p+1]=T,h[p+2]=T,h[p+3]=1,p+=4}n.attributes.normal=new Et(g.buffer),n.attributes.color=new It(h.buffer)}}}export{ps as fetch,gr as parseUrl};
