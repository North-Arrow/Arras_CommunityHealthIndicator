import{c as m}from"./MapPage-DkZzMXd_.js";const a=-3,f=a-1,g=!!m("esri-tests-disable-gpu-memory-measurements");class y{get size(){return this._size}constructor(i=10485760){this._maxSize=i,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._users=new Map,this._sizeLimits=new Map}destroy(){this.clearAll(),this._sizeLimits.clear(),this._users.clear(),this._db=null}register(i){this._users.set(i.id.slice(0,-1),i)}deregister(i){this.clear(i),this._sizeLimits.delete(i),this._users.delete(i.id.slice(0,-1))}get maxSize(){return this._maxSize}set maxSize(i){this._maxSize=Math.max(i,-1),this._checkSize()}getSize(i,e){return this._db.get(i.id+e)?.size??0}put(i,e,t,h,o){e=i.id+e;const s=this._db.get(e);if(s&&(this._size-=s.size,i.size-=s.size,this._db.delete(e),s.entry!==t&&this._notifyRemove(e,s.entry,s.size,0)),h>this._maxSize)return void this._notifyRemove(e,t,h,0);if(t===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return g||console.warn(`Refusing to cache entry with size ${h} for key ${e}`),void this._notifyRemove(e,t,0,0);const r=1+Math.max(o,f)-a;this._db.set(e,new b(t,h,r)),this._size+=h,i.size+=h,this._checkSize()}updateSize(i,e){e=i.id+e;const t=this._db.get(e);if(!t)return;this._size-=t.size,i.size-=t.size;let h=t.entry.usedMemory;for(;h>this._maxSize;){const o=this._notifyRemove(e,t.entry,h,1);if(!(o!=null&&o>0))return void this._db.delete(e);h=o}t.size=h,this._size+=h,i.size+=h,this._checkSize()}pop(i,e){e=i.id+e;const t=this._db.get(e);if(t)return this._size-=t.size,i.size-=t.size,this._db.delete(e),++this._hit,t.entry;++this._miss}get(i,e){e=i.id+e;const t=this._db.get(e);if(t!==void 0)return this._db.delete(e),t.lives=t.lifetime,this._db.set(e,t),++this._hit,t.entry;++this._miss}peek(i,e){const t=this._db.get(i.id+e);return t?++this._hit:++this._miss,t?.entry}get performanceInfo(){const i={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},e={},t=new Array;this._db.forEach((s,r)=>{const n=s.lifetime;t[n]=(t[n]||0)+s.size,this._users.forEach(d=>{const{id:l,name:z}=d;if(r.startsWith(l)){const u=e[z]||0;e[z]=u+s.size}})});const h={};this._users.forEach(s=>{const r=s.name;if("hitRate"in s&&typeof s.hitRate=="number"&&!isNaN(s.hitRate)&&s.hitRate>0){const n=e[r]||0;e[r]=n,h[r]=Math.round(100*s.hitRate)+"%"}else h[r]="0%"});const o=Object.keys(e);o.sort((s,r)=>e[r]-e[s]),o.forEach(s=>i[s]=Math.round(e[s]/2**20)+"MB / "+h[s]);for(let s=t.length-1;s>=0;--s){const r=t[s];r&&(i["Priority "+(s+a-1)]=Math.round(r/this._size*100)+"%")}return i}resetStats(){this._hit=this._miss=0,this._users.forEach(i=>i.resetHitRate())}clear(i){const e=i.id;this._db.forEach((t,h)=>{h.startsWith(e)&&(this._size-=t.size,this._db.delete(h),this._notifyRemove(h,t.entry,t.size,0))}),i.size=0}clearAll(){this._db.forEach((i,e)=>this._notifyRemove(e,i.entry,i.size,0)),this._users.forEach(i=>i.size=0),this._size=0,this._db.clear()}*values(i){for(const[e,t]of this._db)e.startsWith(i.id)&&(yield t.entry)}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(i,e,t,h){const o=this._users.get(i.split(_)[0])?.removeFunc,s=o?.(e,h,t);return typeof s=="number"?s:null}_checkSize(){this._sizeLimits.forEach((i,e)=>this._checkSizeLimits(i,e)),this._checkSizeLimits(this.maxSize)}setMaxSize(i,e){e==null||e<=0?this._sizeLimits.delete(i):this._sizeLimits.set(i,e)}_checkSizeLimits(i,e){const t=e??this;if(t.size<=i)return;const h=e?.id;let o=!0;for(;o;){o=!1;for(const[s,r]of this._db)if(r.lifetime===0&&(!h||s.startsWith(h))){const n=e??this._users.get(s.split(_)[0]);if(this._purgeItem(s,r,n),t.size<=.9*i)return;o||=this._db.has(s)}}for(const[s,r]of this._db)if(!h||s.startsWith(h)){const n=e??this._users.get(s.split(_)[0]);if(this._purgeItem(s,r,n),t.size<=.9*i)return}}_purgeItem(i,e,t){if(this._db.delete(i),e.lives<=1){this._size-=e.size,t&&(t.size-=e.size);const h=this._notifyRemove(i,e.entry,e.size,1);h!=null&&h>0&&(this._size+=h,t&&(t.size+=h),e.lives=e.lifetime,e.size=h,this._db.set(i,e))}else--e.lives,this._db.set(i,e)}}class b{constructor(i,e,t){this.entry=i,this.size=e,this.lifetime=t,this.lives=t}}const _=":";class p{constructor(i,e){this.removeFunc=e,this._storage=new y,this.id="",this.name="",this.size=0,this._storage.maxSize=i,this._storage.register(this)}destroy(){this._storage.deregister(this),this._storage.destroy(),this._storage=null}put(i,e,t=1){this._storage.put(this,i,e,t,1)}pop(i){return this._storage.pop(this,i)}get(i){return this._storage.get(this,i)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(i){this._storage.maxSize=i}resetHitRate(){}}export{p as e};
