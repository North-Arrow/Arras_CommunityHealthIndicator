import{i4 as Qe,gx as Xe,ao as Tt,eC as At,Y as yt}from"./MapPage-tXYKzu0N.js";import{i as C,s as qe,o as we,r as ge,a as Ze,f as gt,e as et,h as le,p as Se,d as Bt,c as Mt,n as Pt}from"./GeometryUtils-FQPw6Uhf.js";import{c as be,t as G,a as pe,V as Vt,T as Dt,l as kt}from"./StyleRepository-Ddic0PTd.js";import{t as tt,a as St,_ as vt,i as Ut}from"./TurboLine-wwpAA25T.js";import{n as Ft}from"./pbf-CQ1utGLJ.js";import{e as st}from"./earcut-D9gy186-.js";import"./index-BJdkyBTf.js";import"./themeLevelStore-BNTVideh.js";import"./enums-CVsE7NBb.js";import"./VertexAttributeLocations-W6y2attr.js";import"./colorUtils-B3-I5gKO.js";import"./vec42-AfVX9Jzj.js";import"./vec4f64-CvoGn1-Y.js";import"./definitions-HjZq38Cc.js";import"./memoryEstimations-DA3Qg7pf.js";const ve=[["(",")"],[")","("],["<",">"],[">","<"],["[","]"],["]","["],["{","}"],["}","{"],["«","»"],["»","«"],["‹","›"],["›","‹"],["⁽","⁾"],["⁾","⁽"],["₍","₎"],["₎","₍"],["≤","≥"],["≥","≤"],["〈","〉"],["〉","〈"],["﹙","﹚"],["﹚","﹙"],["﹛","﹜"],["﹜","﹛"],["﹝","﹞"],["﹞","﹝"],["﹤","﹥"],["﹥","﹤"]],me=["آ","أ","إ","ا"],Ct=["ﻵ","ﻷ","ﻹ","ﻻ"],Rt=["ﻶ","ﻸ","ﻺ","ﻼ"],Re=["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ی","ئ","ؤ"],$t=["ﺍ","ﺏ","ﺕ","ﺙ","ﺝ","ﺡ","ﺥ","ﺩ","ﺫ","ﺭ","ﺯ","ﺱ","ﺵ","ﺹ","ﺽ","ﻁ","ﻅ","ﻉ","ﻍ","ﻑ","ﻕ","ﻙ","ﻝ","ﻡ","ﻥ","ﻩ","ﻭ","ﻱ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯼ","ﺉ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺉ","ﺅ"],zt=["ﺎ","ﺐ","ﺖ","ﺚ","ﺞ","ﺢ","ﺦ","ﺪ","ﺬ","ﺮ","ﺰ","ﺲ","ﺶ","ﺺ","ﺾ","ﻂ","ﻆ","ﻊ","ﻎ","ﻒ","ﻖ","ﻚ","ﻞ","ﻢ","ﻦ","ﻪ","ﻮ","ﻲ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯽ","ﺊ","ﺆ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺊ","ﺆ"],Nt=["ﺎ","ﺒ","ﺘ","ﺜ","ﺠ","ﺤ","ﺨ","ﺪ","ﺬ","ﺮ","ﺰ","ﺴ","ﺸ","ﺼ","ﻀ","ﻄ","ﻈ","ﻌ","ﻐ","ﻔ","ﻘ","ﻜ","ﻠ","ﻤ","ﻨ","ﻬ","ﻮ","ﻴ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯿ","ﺌ","ﺆ","ﹱ","ﹲ","ﹴ","ﹷ","ﹹ","ﹻ","ﹽ","ﹿ","ﺀ","ﺌ","ﺆ"],Et=["ﺍ","ﺑ","ﺗ","ﺛ","ﺟ","ﺣ","ﺧ","ﺩ","ﺫ","ﺭ","ﺯ","ﺳ","ﺷ","ﺻ","ﺿ","ﻃ","ﻇ","ﻋ","ﻏ","ﻓ","ﻗ","ﻛ","ﻟ","ﻣ","ﻧ","ﻫ","ﻭ","ﻳ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯾ","ﺋ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺋ","ﺅ"],rt=["ء","آ","أ","ؤ","إ","ا","ة","د","ذ","ر","ز","و","ى"],Ot=["ً","ً","ٌ","؟","ٍ","؟","َ","َ","ُ","ُ","ِ","ِ","ّ","ّ","ْ","ْ","ء","آ","آ","أ","أ","ؤ","ؤ","إ","إ","ئ","ئ","ئ","ئ","ا","ا","ب","ب","ب","ب","ة","ة","ت","ت","ت","ت","ث","ث","ث","ث","ج","ج","ج","ج","ح","ح","ح","ح","خ","خ","خ","خ","د","د","ذ","ذ","ر","ر","ز","ز","س","س","س","س","ش","ش","ش","ش","ص","ص","ص","ص","ض","ض","ض","ض","ط","ط","ط","ط","ظ","ظ","ظ","ظ","ع","ع","ع","ع","غ","غ","غ","غ","ف","ف","ف","ف","ق","ق","ق","ق","ك","ك","ك","ك","ل","ل","ل","ل","م","م","م","م","ن","ن","ن","ن","ه","ه","ه","ه","و","و","ى","ى","ي","ي","ي","ي","ﻵ","ﻶ","ﻷ","ﻸ","ﻹ","ﻺ","ﻻ","ﻼ","؟","؟","؟"],it=["ء","ف"],Gt=["غ","ي"],Wt=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],Kt=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],i=0,b=1,S=2,E=3,e=4,re=5,Ce=6,t=7,j=8,H=9,X=10,U=11,x=12,jt=13,qt=14,Ht=15,Yt=16,Jt=17,V=18,Qt=["UBAT_L","UBAT_R","UBAT_EN","UBAT_AN","UBAT_ON","UBAT_B","UBAT_S","UBAT_AL","UBAT_WS","UBAT_CS","UBAT_ES","UBAT_ET","UBAT_NSM","UBAT_LRE","UBAT_RLE","UBAT_PDF","UBAT_LRO","UBAT_RLO","UBAT_BN"],se=100,Xt=[se+0,i,i,i,i,se+1,se+2,se+3,b,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,se+4,e,e,e,i,e,i,e,i,e,e,e,i,i,e,e,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,e,e,i,i,e,e,i,i,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,se+5,t,t,se+6,se+7],Zt=[[V,V,V,V,V,V,V,V,V,Ce,re,Ce,j,re,V,V,V,V,V,V,V,V,V,V,V,V,V,V,re,re,re,Ce,j,e,e,U,U,U,e,e,e,e,e,X,H,X,H,H,S,S,S,S,S,S,S,S,S,S,H,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,V,V,V,V,V,V,re,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,V,H,e,U,U,U,U,e,e,e,e,i,e,e,V,e,e,U,U,S,S,e,i,e,e,e,S,i,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i],[i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,i,i,i,i,i,i,i,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,i,e,e,e,e,e,e,e,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,b,x,b,x,x,b,x,x,b,x,e,e,e,e,e,e,e,e,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,e,e,e,e,e,b,b,b,b,b,e,e,e,e,e,e,e,e,e,e,e],[E,E,E,E,e,e,e,e,t,U,U,t,H,t,e,e,x,x,x,x,x,x,x,x,x,x,x,t,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,E,E,E,E,E,E,E,E,E,E,U,E,E,t,t,t,x,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,E,e,x,x,x,x,x,x,t,t,x,x,e,x,x,x,x,t,t,S,S,S,S,S,S,S,S,S,S,t,t,t,t,t,t],[t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,t,t,x,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,x,x,x,x,x,x,x,x,x,x,x,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,x,x,x,x,x,x,x,x,x,b,b,e,e,e,e,b,e,e,e,e,e],[j,j,j,j,j,j,j,j,j,j,j,V,V,V,i,b,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,j,re,jt,qt,Ht,Yt,Jt,H,U,U,U,U,U,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,H,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,j,V,V,V,V,V,e,e,e,e,e,V,V,V,V,V,V,S,i,e,e,S,S,S,S,S,S,X,X,e,e,e,i,S,S,S,S,S,S,S,S,S,S,X,X,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,U,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],[i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,e,e,e,e,e,b,x,b,b,b,b,b,b,b,b,b,b,X,b,b,b,b,b,b,b,b,b,b,b,b,b,e,b,b,b,b,b,e,b,e,b,b,e,b,b,e,b,b,b,b,b,b,b,b,b,b,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],[x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,x,x,x,x,x,x,x,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,H,e,H,e,e,H,e,e,e,e,e,e,e,e,e,U,e,e,X,X,e,e,e,e,e,U,U,e,e,e,e,e,t,t,t,t,t,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,e,V],[e,e,e,U,U,U,e,e,e,e,e,X,H,X,H,H,S,S,S,S,S,S,S,S,S,S,H,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,e,e,e,e,e,e,e,e,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,i,e,e,e,i,i,i,i,i,i,e,e,i,i,i,i,i,i,e,e,i,i,i,i,i,i,e,e,i,i,i,e,e,e,U,U,e,e,e,U,U,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]];class es{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(s,r,a){if(this.sourceToTarget=[],this.targetToSource=[],!s)return"";if(ps(this.sourceToTarget,this.targetToSource,s.length),!this.checkParameters(r,a))return s;r=this.inputFormat,a=this.outputFormat;let n=s;const o=_s,l=ot(r.charAt(1)),h=ot(a.charAt(1)),u=(r.startsWith("I")?"L":r.charAt(0))+l,f=(a.startsWith("I")?"L":a.charAt(0))+h,d=r.charAt(2)+a.charAt(2);o.defInFormat=u,o.defOutFormat=f,o.defSwap=d;const g=Le(s,u,f,d,o);let p=!1;return a.charAt(1)==="R"?p=!0:a.charAt(1)!=="C"&&a.charAt(1)!=="D"||(p=this.checkContextual(g)==="rtl"),this.sourceToTarget=J,this.targetToSource=ms(this.sourceToTarget),ze=this.targetToSource,n=r.charAt(3)===a.charAt(3)?g:a.charAt(3)==="S"?ss(p,g):ns(g,p,!0),this.sourceToTarget=J,this.targetToSource=ze,this.levels=Ne,n}_inputFormatSetter(s){if(!lt.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=s}_outputFormatSetter(s){if(!lt.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=s}checkParameters(s,r){return s?this._inputFormatSetter(s):s=this.inputFormat,r?this._outputFormatSetter(r):r=this.outputFormat,s!==r}checkContextual(s){let r=$e(s);if(r!=="ltr"&&r!=="rtl"){try{r=document.dir.toLowerCase()}catch{}r!=="ltr"&&r!=="rtl"&&(r="ltr")}return r}hasBidiChar(s){return bs.test(s)}}function Le(c,s,r,a,n){const o=ts(c,{inFormat:s,outFormat:r,swap:a},n);if(o.inFormat===o.outFormat)return c;s=o.inFormat,r=o.outFormat,a=o.swap;const l=s.slice(0,1),h=s.slice(1,4),u=r.slice(0,1),f=r.slice(1,4);if(n.inFormat=s,n.outFormat=r,n.swap=a,l==="L"&&r==="VLTR"){if(h==="LTR")return n.dir=xe,he(c,n);if(h==="RTL")return n.dir=Te,he(c,n)}if(l==="V"&&u==="V")return n.dir=h==="RTL"?Te:xe,We(c,n);if(l==="L"&&r==="VRTL")return h==="LTR"?(n.dir=xe,c=he(c,n)):(n.dir=Te,c=he(c,n)),We(c);if(s==="VLTR"&&r==="LLTR")return n.dir=xe,he(c,n);if(l==="V"&&u==="L"&&h!==f)return c=We(c),h==="RTL"?Le(c,"LLTR","VLTR",a,n):Le(c,"LRTL","VRTL",a,n);if(s==="VRTL"&&r==="LRTL")return Le(c,"LRTL","VRTL",a,n);if(l==="L"&&u==="L"){const d=n.swap;return n.swap=d.slice(0,1)+"N",h==="RTL"?(n.dir=Te,c=he(c,n),n.swap="N"+d.slice(1,3),n.dir=xe,c=he(c,n)):(n.dir=xe,c=he(c,n),n.swap="N"+d.slice(1,3),c=Le(c,"VLTR","LRTL",n.swap,n)),c}return c}function ts(c,s,r){if(s.inFormat===void 0&&(s.inFormat=r.defInFormat),s.outFormat===void 0&&(s.outFormat=r.defOutFormat),s.swap===void 0&&(s.swap=r.defSwap),s.inFormat===s.outFormat)return s;const a=s.inFormat.slice(0,1),n=s.outFormat.slice(0,1);let o,l=s.inFormat.slice(1,4),h=s.outFormat.slice(1,4);return l.startsWith("C")&&(o=$e(c),l=o==="ltr"||o==="rtl"?o.toUpperCase():s.inFormat.charAt(2)==="L"?"LTR":"RTL",s.inFormat=a+l),h.startsWith("C")&&(o=$e(c),o==="rtl"?h="RTL":o==="ltr"?(o=is(c),h=o.toUpperCase()):h=s.outFormat.charAt(2)==="L"?"LTR":"RTL",s.outFormat=n+h),s}function ss(c,s,r){if(s.length===0)return"";c===void 0&&(c=!0);const a=(s=String(s)).split("");let n=0,o=1,l=a.length;c||(n=a.length-1,o=-1,l=1);const h=rs(a,n,o,l);let u="";for(let f=0;f<a.length;f++)hs(h,h.length,f)>-1?(_t(ze,f,!c,-1),J.splice(f,1)):u+=a[f];return u}function rs(c,s,r,a,n){let o=0;const l=[];let h=0;for(let u=s;u*r<a;u+=r)if(mt(c[u])||Ae(c[u])){if(c[u]==="ل"&&cs(c,u+r,r,a)){c[u]=gs(c[u+r],o===0?Ct:Rt),u+=r,ys(c,u,r,a),l[h]=u,h++,o=0;continue}const f=c[u];o===1?c[u]=nt(c,u+r,r,a)?xs(c[u]):Ke(c[u],zt):nt(c,u+r,r,a)===!0?c[u]=Ke(c[u],Et):c[u]=Ke(c[u],$t),Ae(f)||(o=1),ds(f)===!0&&(o=0)}else o=0;return l}function $e(c){const s=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(c);return s?s[0]<="z"?"ltr":"rtl":""}function is(c){const s=c.split("");return s.reverse(),$e(s.join(""))}function ns(c,s,r){if(c.length===0)return"";s===void 0&&(s=!0);let a="";const n=(c=String(c)).split("");for(let o=0;o<c.length;o++){let l=!1;if(n[o]>="ﹰ"&&n[o]<"\uFEFF"){const h=c.charCodeAt(o);n[o]>="ﻵ"&&n[o]<="ﻼ"?(s?(o>0&&r&&n[o-1]===" "?a=a.slice(0,-1)+"ل":(a+="ل",l=!0),a+=me[(h-65269)/2]):(a+=me[(h-65269)/2],a+="ل",o+1<c.length&&r&&n[o+1]===" "?o++:l=!0),l&&(_t(ze,o,!0,1),J.splice(o,0,J[o]))):a+=Ot[h-65136]}else a+=n[o]}return a}function he(c,s){const r=c.split(""),a=[];return pt(r,a,s),os(r,a,s),at(2,r,a,s),at(1,r,a,s),Ne=a,r.join("")}function pt(c,s,r){const a=c.length,n=r.dir?Kt:Wt;let o=0,l=-1;const h=[],u=[];r.hiLevel=r.dir,r.lastArabic=!1,r.hasUbatAl=!1,r.hasUbatB=!1,r.hasUbatS=!1;for(let f=0;f<a;f++)h[f]=ls(c[f]);for(let f=0;f<a;f++){const d=o,g=us(c,h,u,f,r);u[f]=g,o=n[d][g];const p=240&o;o&=15;const y=n[o][Is];if(s[f]=y,p>0)if(p===16){for(let m=l;m<f;m++)s[m]=1;l=-1}else l=-1;if(n[o][ws])l===-1&&(l=f);else if(l>-1){for(let m=l;m<f;m++)s[m]=y;l=-1}h[f]===re&&(s[f]=0),r.hiLevel|=y}r.hasUbatS&&as(h,s,a,r)}function as(c,s,r,a){for(let n=0;n<r;n++)if(c[n]===Ce){s[n]=a.dir;for(let o=n-1;o>=0&&c[o]===j;o--)s[o]=a.dir}}function os(c,s,r){if(r.hiLevel!==0&&r.swap[0]!==r.swap[1])for(let a=0;a<c.length;a++)s[a]===1&&(c[a]=fs(c[a]))}function ls(c){const s=c.charCodeAt(0),r=Xt[s>>8];return r<se?r:Zt[r-se][255&s]}function We(c,s){const r=c.split("");if(s){const a=[];pt(r,a,s),Ne=a}return r.reverse(),J.reverse(),r.join("")}function hs(c,s,r){for(let a=0;a<s;a++)if(c[a]===r)return a;return-1}function mt(c){for(let s=0;s<it.length;s++)if(c>=it[s]&&c<=Gt[s])return!0;return!1}function nt(c,s,r,a){for(;s*r<a&&Ae(c[s]);)s+=r;return!!(s*r<a&&mt(c[s]))}function cs(c,s,r,a){for(;s*r<a&&Ae(c[s]);)s+=r;let n=" ";if(!(s*r<a))return!1;n=c[s];for(let o=0;o<me.length;o++)if(me[o]===n)return!0;return!1}function at(c,s,r,a){if(a.hiLevel<c)return;if(c===1&&a.dir===Te&&!a.hasUbatB)return s.reverse(),void J.reverse();const n=s.length;let o,l,h,u,f,d=0;for(;d<n;){if(r[d]>=c){for(o=d+1;o<n&&r[o]>=c;)o++;for(l=d,h=o-1;l<h;l++,h--)u=s[l],s[l]=s[h],s[h]=u,f=J[l],J[l]=J[h],J[h]=f;d=o}d++}}function us(c,s,r,a,n){const o=s[a];return{UBAT_L:()=>(n.lastArabic=!1,i),UBAT_R:()=>(n.lastArabic=!1,b),UBAT_ON:()=>e,UBAT_AN:()=>E,UBAT_EN:()=>n.lastArabic?E:S,UBAT_AL:()=>(n.lastArabic=!0,n.hasUbatAl=!0,b),UBAT_WS:()=>e,UBAT_CS:()=>{let l,h;return a<1||a+1>=s.length||(l=r[a-1])!==S&&l!==E||(h=s[a+1])!==S&&h!==E?e:(n.lastArabic&&(h=E),h===l?h:e)},UBAT_ES:()=>(a>0?r[a-1]:re)===S&&a+1<s.length&&s[a+1]===S?S:e,UBAT_ET:()=>{if(a>0&&r[a-1]===S)return S;if(n.lastArabic)return e;let l=a+1;const h=s.length;for(;l<h&&s[l]===U;)l++;return l<h&&s[l]===S?S:e},UBAT_NSM:()=>{if(n.inFormat==="VLTR"){const l=s.length;let h=a+1;for(;h<l&&s[h]===x;)h++;if(h<l){const u=c[a].charCodeAt(0),f=u>=1425&&u<=2303||u===64286,d=s[h];if(f&&(d===b||d===t))return b}}return a<1||s[a-1]===re?e:r[a-1]},UBAT_B:()=>(n.lastArabic=!0,n.hasUbatB=!0,n.dir),UBAT_S:()=>(n.hasUbatS=!0,e),UBAT_LRE:()=>(n.lastArabic=!1,e),UBAT_RLE:()=>(n.lastArabic=!1,e),UBAT_LRO:()=>(n.lastArabic=!1,e),UBAT_RLO:()=>(n.lastArabic=!1,e),UBAT_PDF:()=>(n.lastArabic=!1,e),UBAT_BN:()=>e}[Qt[o]]()}function fs(c){let s,r=0,a=ve.length-1;for(;r<=a;)if(s=Math.floor((r+a)/2),c<ve[s][0])a=s-1;else{if(!(c>ve[s][0]))return ve[s][1];r=s+1}return c}function ds(c){for(let s=0;s<rt.length;s++)if(rt[s]===c)return!0;return!1}function xs(c){for(let s=0;s<Re.length;s++)if(c===Re[s])return Nt[s];return c}function Ke(c,s){for(let r=0;r<Re.length;r++)if(c===Re[r])return s[r];return c}function Ae(c){return c>="ً"&&c<="ٕ"}function ot(c){return c==="L"?"LTR":c==="R"?"RTL":c==="C"?"CLR":c==="D"?"CRL":""}function ys(c,s,r,a){for(;s*r<a&&Ae(c[s]);)s+=r;return s*r<a&&(c[s]=" ",!0)}function gs(c,s){for(let r=0;r<me.length;r++)if(c===me[r])return s[r];return c}function ps(c,s,r){J=[],Ne=[];for(let a=0;a<r;a++)c[a]=a,s[a]=a,J[a]=a}function ms(c){const s=new Array(c.length);for(let r=0;r<c.length;r++)s[c[r]]=r;return s}function _t(c,s,r,a){for(let n=0;n<c.length;n++)(c[n]>s||!r&&c[n]===s)&&(c[n]+=a)}let J=[],ze=[],Ne=[];const _s={dir:0,defInFormat:"LLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,defOutFormat:""},Is=5,ws=6,xe=0,Te=1,lt=/^[(I|V)][(L|RCD)][(Y|N)][(S|N)]N$/,bs=/[\u0591-\u06ff\ufb1d-\ufefc]/;function Ls(c){return c===746||c===747||!(c<4352)&&(c>=12704&&c<=12735||c>=12544&&c<=12591||c>=65072&&c<=65103&&!(c>=65097&&c<=65103)||c>=63744&&c<=64255||c>=13056&&c<=13311||c>=11904&&c<=12031||c>=12736&&c<=12783||c>=12288&&c<=12351&&!(c>=12296&&c<=12305||c>=12308&&c<=12319||c===12336)||c>=13312&&c<=19903||c>=19968&&c<=40959||c>=12800&&c<=13055||c>=12592&&c<=12687||c>=43360&&c<=43391||c>=55216&&c<=55295||c>=4352&&c<=4607||c>=44032&&c<=55215||c>=12352&&c<=12447||c>=12272&&c<=12287||c>=12688&&c<=12703||c>=12032&&c<=12255||c>=12784&&c<=12799||c>=12448&&c<=12543&&c!==12540||c>=65280&&c<=65519&&!(c===65288||c===65289||c===65293||c>=65306&&c<=65310||c===65339||c===65341||c===65343||c>=65371&&c<=65503||c===65507||c>=65512&&c<=65519)||c>=65104&&c<=65135&&!(c>=65112&&c<=65118||c>=65123&&c<=65126)||c>=5120&&c<=5759||c>=6320&&c<=6399||c>=65040&&c<=65055||c>=19904&&c<=19967||c>=40960&&c<=42127||c>=42128&&c<=42191)}function Ts(c){return!(c<11904)&&(c>=12704&&c<=12735||c>=12544&&c<=12591||c>=65072&&c<=65103||c>=63744&&c<=64255||c>=13056&&c<=13311||c>=11904&&c<=12031||c>=12736&&c<=12783||c>=12288&&c<=12351||c>=13312&&c<=19903||c>=19968&&c<=40959||c>=12800&&c<=13055||c>=65280&&c<=65519||c>=12352&&c<=12447||c>=12272&&c<=12287||c>=12032&&c<=12255||c>=12784&&c<=12799||c>=12448&&c<=12543||c>=65040&&c<=65055||c>=42128&&c<=42191||c>=40960&&c<=42127)}function As(c){switch(c){case 10:case 32:case 38:case 40:case 41:case 43:case 45:case 47:case 173:case 183:case 8203:case 8208:case 8211:case 8231:return!0}return!1}function ht(c){switch(c){case 9:case 10:case 11:case 12:case 13:case 32:return!0}return!1}const ie=24,It=17;class wt{constructor(s,r,a,n,o,l,h){this._glyphItems=s,this._maxWidth=r,this._lineHeight=a,this._letterSpacing=n,this._hAnchor=o,this._vAnchor=l,this._justify=h}getShaping(s,r,a){const n=this._letterSpacing,o=this._lineHeight,l=this._justify,h=this._maxWidth,u=[];let f=0,d=0;for(const I of s){const A=I.codePointAt(0);if(A==null)continue;const P=a&&Ls(A);let L;for(const M of this._glyphItems)if(L=M[A],L)break;u.push({codePoint:A,x:f,y:d,vertical:P,glyphMosaicItem:L}),L&&(f+=L.metrics.advance+n)}let g=f;h>0&&(g=f/Math.max(1,Math.ceil(f/h)));const p=s.includes("​"),y=[],m=u.length;for(let I=0;I<m-1;I++){const A=u[I].codePoint,P=Ts(A);if(As(A)||P){let L=0;if(A===10)L-=1e4;else if(P&&p)L+=150;else{A!==40&&A!==65288||(L+=50);const M=u[I+1].codePoint;M!==41&&M!==65289||(L+=50)}y.push(this._buildBreak(I+1,u[I].x,g,y,L,!1))}}const w=this._optimalBreaks(this._buildBreak(m,f,g,y,0,!0));let B=0;const _=r?-o:o;let T=0;for(let I=0;I<w.length;I++){const A=w[I];let P=T;for(;P<A&&ht(u[P].codePoint);)u[P].glyphMosaicItem=null,++P;let L=A-1;for(;L>P&&ht(u[L].codePoint);)u[L].glyphMosaicItem=null,--L;if(P<=L){const M=u[P].x;for(let D=P;D<=L;D++)u[D].x-=M,u[D].y=d;let v=u[L].x;u[L].glyphMosaicItem&&(v+=u[L].glyphMosaicItem.metrics.advance),B=Math.max(v,B),l&&this._applyJustification(u,P,L)}T=A,d+=_}if(u.length>0){const I=w.length-1,A=(l-this._hAnchor)*B;let P=(-this._vAnchor*(I+1)+.5)*o;r&&I&&(P+=I*o);for(const L of u)L.x+=A,L.y+=P}return u.filter(I=>I.glyphMosaicItem)}static getTextBox(s,r){if(!s.length)return null;let a=1/0,n=1/0,o=0,l=0;for(const h of s){const u=h.glyphMosaicItem.metrics.advance,f=h.x,d=h.y-It,g=f+u,p=d+r;a=Math.min(a,f),o=Math.max(o,g),n=Math.min(n,d),l=Math.max(l,p)}return{x:a,y:n,width:o-a,height:l-n}}static getBox(s){if(!s.length)return null;let r=1/0,a=1/0,n=0,o=0;for(const l of s){const{height:h,left:u,top:f,width:d}=l.glyphMosaicItem.metrics,g=l.x,p=l.y-(h-Math.abs(f)),y=g+d+u,m=p+h;r=Math.min(r,g),n=Math.max(n,y),a=Math.min(a,p),o=Math.max(o,m)}return{x:r,y:a,width:n-r,height:o-a}}static addDecoration(s,r){const a=s.length;if(a===0)return;const n=3;let o=s[0].x+s[0].glyphMosaicItem.metrics.left,l=s[0].y;for(let u=1;u<a;u++){const f=s[u];if(f.y!==l){const d=s[u-1].x+s[u-1].glyphMosaicItem.metrics.left+s[u-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:l+r-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new tt(4,0,4,8),metrics:{width:d-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}}),l=f.y,o=f.x+f.glyphMosaicItem.metrics.left}}const h=s[a-1].x+s[a-1].glyphMosaicItem.metrics.left+s[a-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:l+r-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new tt(4,0,4,8),metrics:{width:h-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}})}_breakScore(s,r,a,n){const o=(s-r)*(s-r);return n?s<r?o/2:2*o:o+Math.abs(a)*a}_buildBreak(s,r,a,n,o,l){let h=null,u=this._breakScore(r,a,o,l);for(const f of n){const d=r-f.x,g=this._breakScore(d,a,o,l)+f.score;g<=u&&(h=f,u=g)}return{index:s,x:r,score:u,previousBreak:h}}_optimalBreaks(s){return s?this._optimalBreaks(s.previousBreak).concat(s.index):[]}_applyJustification(s,r,a){const n=s[a],o=n.vertical?ie:n.glyphMosaicItem?n.glyphMosaicItem.metrics.advance:0,l=(n.x+o)*this._justify;for(let h=r;h<=a;h++)s[h].x-=l}}const ct=!0,de=.5,je=2;class Ue{constructor(s,r,a=0,n=-1,o=de){this.x=s,this.y=r,this.angle=a,this.segment=n,this.minzoom=o}}class Fe{constructor(s,r,a,n,o,l=de,h=ge){this.anchor=s,this.labelAngle=r,this.glyphAngle=a,this.page=n,this.alternateVerticalGlyph=o,this.minzoom=l,this.maxzoom=h}}class ut{constructor(s,r,a,n,o,l,h,u,f,d,g,p){this.tl=s,this.tr=r,this.bl=a,this.br=n,this.mosaicRect=o,this.labelAngle=l,this.minAngle=h,this.maxAngle=u,this.anchor=f,this.minzoom=d,this.maxzoom=g,this.page=p}}let ft=class{constructor(s){this.shapes=s}};class Bs{getIconPlacement(s,r,a){const n=new C(s.x,s.y),o=a.rotationAlignment===0,l=a.keepUpright;let h=a.rotate*qe;o&&(h+=s.angle);const u=new ft([]);return a.allowOverlap&&a.ignorePlacement||!ct||(u.iconColliders=[]),this._addIconPlacement(u,n,r,a,h),o&&l&&this._addIconPlacement(u,n,r,a,h+we),u}_addIconPlacement(s,r,a,n,o){const l=a.rasterizationScale,h=a.width/l,u=a.height/l,f=n.offset;let d=f[0],g=f[1];switch(n.anchor){case 0:d-=h/2,g-=u/2;break;case 1:g-=u/2;break;case 2:d-=h,g-=u/2;break;case 3:d-=h/2;break;case 4:d-=h/2,g-=u;break;case 5:break;case 7:g-=u;break;case 6:d-=h;break;case 8:d-=h,g-=u}const p=a.rect,y=2/l,m=d-y,w=g-y,B=m+p.width/l,_=w+p.height/l,T=new C(m,w),I=new C(B,_),A=new C(m,_),P=new C(B,w);if(o!==0){const M=Math.cos(o),v=Math.sin(o);T.rotate(M,v),I.rotate(M,v),A.rotate(M,v),P.rotate(M,v)}const L=new ut(T,P,A,I,p,o,0,256,r,de,ge,0);if(s.shapes.push(L),(!n.allowOverlap||!n.ignorePlacement)&&ct){const M=n.size,v=n.padding,D={xTile:r.x,yTile:r.y,dxPixels:d*M-v,dyPixels:g*M-v,hard:!n.optional,partIndex:0,width:h*M+2*v,height:u*M+2*v,angle:o,minLod:de,maxLod:ge};s.iconColliders.push(D)}}getTextPlacement(s,r,a,n){const o=new C(s.x,s.y),l=n.rotate*qe,h=n.rotationAlignment===0,u=n.keepUpright,f=n.padding;let d=de;const g=h?s.angle:0,p=s.segment>=0&&h,y=n.allowOverlap&&n.ignorePlacement?null:[],m=[],w=4,B=!p;let _=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,I=_,A=T;const P=(p||h)&&u,L=n.size/ie;let M=!1;for(const k of r)if(k.vertical){M=!0;break}let v,D=0,F=0;if(!p&&M){const k=wt.getTextBox(r,n.lineHeight*ie);switch(n.anchor){case 1:D=k.height/2,F=-k.width/2;break;case 2:D=-k.height/2,F=k.width/2;break;case 3:D=k.height/2,F=k.width/2;break;case 4:D=-k.height/2,F=-k.width/2;break;case 5:D=k.height;break;case 7:F=-k.width;break;case 6:F=k.width;break;case 8:D=-k.height}}D+=n.offset[0]*ie,F+=n.offset[1]*ie;for(const k of r){const N=k.glyphMosaicItem;if(!N||N.rect.isEmpty)continue;const $=N.rect,z=N.metrics,W=N.page;if(y&&B){if(v!==void 0&&v!==k.y){let O,q,ee,te;M?(O=-A+D,q=_+F,ee=A-I,te=T-_):(O=_+D,q=I+F,ee=T-_,te=A-I);const ae={xTile:s.x,yTile:s.y,dxPixels:O*L-f,dyPixels:q*L-f,hard:!n.optional,partIndex:1,width:ee*L+2*f,height:te*L+2*f,angle:l,minLod:de,maxLod:ge};y.push(ae),_=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,I=_,A=T}v=k.y}const ce=[];if(p){const O=.5*N.metrics.width,q=(k.x+z.left-w+O)*L*be;if(d=this._placeGlyph(s,d,q,a,s.segment,1,k.vertical,W,ce),u&&(d=this._placeGlyph(s,d,q,a,s.segment,-1,k.vertical,W,ce)),d>=je)break}else ce.push(new Fe(o,g,g,W,!1)),h&&u&&ce.push(new Fe(o,g+we,g+we,W,!1));const Q=k.x+z.left,ne=k.y-It-z.top,ue=Q+z.width,Oe=ne+z.height;let K,Z,Be,Me,fe,Pe,Ye,Je;if(!p&&M)if(k.vertical){const O=(Q+ue)/2-z.height/2,q=(ne+Oe)/2+z.width/2;K=new C(-q-w+D,O-w+F),Z=new C(K.x+$.width,K.y+$.height),Be=new C(K.x,Z.y),Me=new C(Z.x,K.y)}else K=new C(-ne+w+D,Q-w+F),Z=new C(K.x-$.height,K.y+$.width),Be=new C(Z.x,K.y),Me=new C(K.x,Z.y);else K=new C(Q-w+D,ne-w+F),Z=new C(K.x+$.width,K.y+$.height),Be=new C(K.x,Z.y),Me=new C(Z.x,K.y);for(const O of ce){let q,ee,te,ae;if(O.alternateVerticalGlyph){if(!fe){const oe=(ne+Oe)/2+F;fe=new C((Q+ue)/2+D-z.height/2-w,oe+z.width/2+w),Pe=new C(fe.x+$.height,fe.y-$.width),Ye=new C(Pe.x,fe.y),Je=new C(fe.x,Pe.y)}q=fe,ee=Ye,te=Je,ae=Pe}else q=K,ee=Be,te=Me,ae=Z;const Ve=ne,Ge=Oe,De=O.glyphAngle+l;if(De!==0){const oe=Math.cos(De),ke=Math.sin(De);q=q.clone(),ee=ee?.clone(),te=te?.clone(),ae=ae?.clone(),q.rotate(oe,ke),ae?.rotate(oe,ke),ee?.rotate(oe,ke),te?.rotate(oe,ke)}let _e=0,Ie=256;if(p&&M?k.vertical?O.alternateVerticalGlyph?(_e=32,Ie=96):(_e=224,Ie=32):(_e=224,Ie=96):(_e=192,Ie=64),m.push(new ut(q,te,ee,ae,$,O.labelAngle,_e,Ie,O.anchor,O.minzoom,O.maxzoom,O.page)),y&&(!P||this._legible(O.labelAngle))){if(B)Q<_&&(_=Q),Ve<I&&(I=Ve),ue>T&&(T=ue),Ge>A&&(A=Ge);else if(O.minzoom<je){const oe={xTile:s.x,yTile:s.y,dxPixels:(Q+D)*L-f,dyPixels:(Ve+D)*L-f,hard:!n.optional,partIndex:1,width:(ue-Q)*L+2*f,height:(Ge-Ve)*L+2*f,angle:De,minLod:O.minzoom,maxLod:O.maxzoom};y.push(oe)}}}}if(d>=je)return null;if(y&&B){let k,N,$,z;M?(k=-A+D,N=_+F,$=A-I,z=T-_):(k=_+D,N=I+F,$=T-_,z=A-I);const W={xTile:s.x,yTile:s.y,dxPixels:k*L-f,dyPixels:N*L-f,hard:!n.optional,partIndex:1,width:$*L+2*f,height:z*L+2*f,angle:l,minLod:de,maxLod:ge};y.push(W)}const R=new ft(m);return y&&y.length>0&&(R.textColliders=y),R}_legible(s){const r=gt(s);return r<65||r>=193}_placeGlyph(s,r,a,n,o,l,h,u,f){let d=l;const g=d<0?Ze(s.angle+we,et):s.angle;let p=0;a<0&&(d*=-1,a*=-1,p=we),d>0&&++o;let y=new C(s.x,s.y),m=n[o],w=ge;if(n.length<=o)return w;for(;;){const B=m.x-y.x,_=m.y-y.y,T=Math.sqrt(B*B+_*_),I=Math.max(a/T,r),A=B/T,P=_/T,L=Ze(Math.atan2(P,A)+p,et);if(f.push(new Fe(y,g,L,u,!1,I,w)),h&&f.push(new Fe(y,g,L,u,!0,I,w)),I<=r)return I;y=m.clone();do{if(o+=d,n.length<=o||o<0)return I;m=n[o]}while(y.isEqual(m));let M=m.x-y.x,v=m.y-y.y;const D=Math.sqrt(M*M+v*v);M*=T/D,v*=T/D,y.x-=M,y.y-=v,w=I}}}let Ms=class{constructor(s,r,a=0){this.values={},this._geometry=void 0,this._pbfGeometry=null,this.featureIndex=a;const n=r.keys,o=r.values,l=s.asUnsafe();for(;l.next();)switch(l.tag()){case 1:this.id=l.getUInt64();break;case 2:{const h=l.getMessage().asUnsafe(),u=this.values;for(;!h.empty();){const f=h.getUInt32(),d=h.getUInt32();u[n[f]]=o[d]}h.release();break}case 3:this.type=l.getUInt32();break;case 4:this._pbfGeometry=l.getMessage();break;default:l.skip()}}getGeometry(s){if(this._geometry!==void 0)return this._geometry;if(!this._pbfGeometry)return null;const r=this._pbfGeometry.asUnsafe();let a,n;this._pbfGeometry=null,s?s.reset(this.type):a=[];let o,l=1,h=0,u=0,f=0;for(;!r.empty();){if(h===0){const d=r.getUInt32();l=7&d,h=d>>3}switch(h--,l){case 1:u+=r.getSInt32(),f+=r.getSInt32(),s?s.moveTo(u,f):a&&(n&&a.push(n),n=[],n.push(new C(u,f)));break;case 2:u+=r.getSInt32(),f+=r.getSInt32(),s?s.lineTo(u,f):n&&n.push(new C(u,f));break;case 7:s?s.close():n&&!n[0].equals(u,f)&&n.push(n[0].clone());break;default:throw r.release(),new Error("Invalid path operation")}}return s?o=s.result():a&&(n&&a.push(n),o=a),r.release(),this._geometry=o,o}},ye=class extends G{constructor(){super(12)}add(s,r,a){const n=this.array;n.push(s),n.push(r),n.push(a)}},Ps=class bt{constructor(s){this.extent=pe,this.keys=[],this.values=[],this._pbfLayer=s.clone();const r=s.asUnsafe();for(;r.next();)switch(r.tag()){case 1:this.name=r.getString();break;case 3:this.keys.push(r.getString());break;case 4:this.values.push(r.processMessage(bt._parseValue));break;case 5:this.extent=r.getUInt32();break;default:r.skip()}}getData(){return this._pbfLayer}static _parseValue(s){for(;s.next();)switch(s.tag()){case 1:return s.getString();case 2:return s.getFloat();case 3:return s.getDouble();case 4:return s.getInt64();case 5:return s.getUInt64();case 6:return s.getSInt64();case 7:return s.getBool();default:s.skip()}return null}},Vs=class extends G{constructor(s){super(s)}add(s,r,a,n,o,l,h,u,f,d,g,p){const y=this.array;let m=G.i1616to32(s,r);y.push(m);const w=31;m=G.i8888to32(Math.round(w*a),Math.round(w*n),Math.round(w*o),Math.round(w*l)),y.push(m),m=G.i8888to32(Math.round(w*h),Math.round(w*u),Math.round(w*f),Math.round(w*d)),y.push(m),m=G.i1616to32(g,0),y.push(m),p&&y.push(...p)}},Ds=class extends G{constructor(s){super(s)}add(s,r,a){const n=this.array;n.push(G.i1616to32(s,r)),a&&n.push(...a)}},ks=class extends G{constructor(s){super(s)}add(s,r,a,n,o,l,h){const u=this.array,f=this.index;let d=G.i1616to32(s,r);u.push(d);const g=15;return d=G.i8888to32(Math.round(g*a),Math.round(g*n),o,l),u.push(d),h&&u.push(...h),f}};class dt extends G{constructor(s){super(s)}add(s,r,a,n,o,l,h,u,f,d,g,p){const y=this.array;let m=G.i1616to32(s,r);y.push(m),m=G.i1616to32(Math.round(8*a),Math.round(8*n)),y.push(m),m=G.i8888to32(o/4,l/4,u,f),y.push(m),m=G.i8888to32(0,gt(h),10*d,Math.min(10*g,255)),y.push(m),p&&y.push(...p)}}class Ss extends G{constructor(s){super(s)}add(s,r,a,n,o){const l=this.array,h=G.i1616to32(2*s+a,2*r+n);l.push(h),o&&l.push(...o)}}class Ee{constructor(s,r,a){this.layerExtent=pe,this._features=[],this.layer=s,this.zoom=r,this._spriteInfo=a,this._filter=s.getFeatureFilter()}pushFeature(s){this._filter&&!this._filter.filter(s,this.zoom)||this._features.push(s)}hasFeatures(){return this._features.length>0}getResources(s,r,a){}}class vs extends Ee{constructor(s,r,a,n,o){super(s,r,a),this.type=4,this._circleVertexBuffer=n,this._circleIndexBuffer=o}get circleIndexStart(){return this._circleIndexStart}get circleIndexCount(){return this._circleIndexCount}processFeatures(s){const r=this._circleVertexBuffer,a=this._circleIndexBuffer;this._circleIndexStart=3*a.index,this._circleIndexCount=0;const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);for(const l of this._features){const h=l.getGeometry(s);if(!h)continue;const u=n.circleMaterial.encodeAttributes(l,o,n);for(const f of h)if(f)for(const d of f){const g=r.index;r.add(d.x,d.y,0,0,u),r.add(d.x,d.y,0,1,u),r.add(d.x,d.y,1,0,u),r.add(d.x,d.y,1,1,u),a.add(g,g+1,g+2),a.add(g+1,g+2,g+3),this._circleIndexCount+=6}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this._circleVertexBuffer.array.length,s+=this._circleIndexBuffer.array.length;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let o=0;o<this.layerUIDs.length;o++)r[n++]=this.layerUIDs[o];r[n++]=this._circleIndexStart,r[n++]=this._circleIndexCount,r[n++]=this._circleVertexBuffer.array.length;for(let o=0;o<this._circleVertexBuffer.array.length;o++)a[n++]=this._circleVertexBuffer.array[o];r[n++]=this._circleIndexBuffer.array.length;for(let o=0;o<this._circleIndexBuffer.array.length;o++)r[n++]=this._circleIndexBuffer.array[o];return r.buffer}}let Us=class Lt extends Ee{constructor(s,r,a,n,o,l,h){super(s,r,a),this.type=1,this._patternMap=new Map,this._fillVertexBuffer=n,this._fillIndexBuffer=o,this._outlineVertexBuffer=l,this._outlineIndexBuffer=h}get fillIndexStart(){return this._fillIndexStart}get fillIndexCount(){return this._fillIndexCount}get outlineIndexStart(){return this._outlineIndexStart}get outlineIndexCount(){return this._outlineIndexCount}getResources(s,r,a){const n=this.layer,o=this.zoom,l=n.getPaintProperty("fill-pattern");if(l)if(l.isDataDriven)for(const h of this._features)r(l.getValue(o,h),!0);else r(l.getValue(o),!0)}processFeatures(s){this._fillIndexStart=3*this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=3*this._outlineIndexBuffer.index,this._outlineIndexCount=0;const r=this.layer,a=this.zoom,{fillMaterial:n,outlineMaterial:o,hasDataDrivenFill:l,hasDataDrivenOutline:h}=r;s&&s.setExtent(this.layerExtent);const u=r.getPaintProperty("fill-pattern"),f=u?.isDataDriven;let d=!u&&r.getPaintValue("fill-antialias",a);if(r.outlineUsesFillColor){if(d&&!r.hasDataDrivenOpacity){const y=r.getPaintValue("fill-opacity",a),m=r.getPaintValue("fill-opacity",a+1);y<1&&m<1&&(d=!1)}if(d&&!r.hasDataDrivenColor){const y=r.getPaintValue("fill-color",a),m=r.getPaintValue("fill-color",a+1);y[3]<1&&m[3]<1&&(d=!1)}}const g=this._features,p=s?.validateTessellation;if(f){const y=[];for(const m of g){const w=u.getValue(a,m),B=this._spriteInfo[w];if(!B?.rect)continue;const _=n.encodeAttributes(m,a,r,B),T=d&&h?o.encodeAttributes(m,a,r):[],I=m.getGeometry(s);y.push({ddFillAttributes:_,ddOutlineAttributes:T,page:B.page,geometry:I}),y.sort((A,P)=>A.page-P.page);for(const{ddFillAttributes:A,ddOutlineAttributes:P,page:L,geometry:M}of y)this._processFeature(M,d,r.outlineUsesFillColor,A,P,p,L)}}else for(const y of g){const m=l?n.encodeAttributes(y,a,r):null,w=d&&h?o.encodeAttributes(y,a,r):null,B=y.getGeometry(s);this._processFeature(B,d,r.outlineUsesFillColor,m,w,p)}}serialize(){let s=10;s+=this.layerUIDs.length,s+=this._fillVertexBuffer.array.length,s+=this._fillIndexBuffer.array.length,s+=this._outlineVertexBuffer.array.length,s+=this._outlineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let h=0;h<this.layerUIDs.length;h++)r[n++]=this.layerUIDs[h];r[n++]=this._fillIndexStart,r[n++]=this._fillIndexCount,r[n++]=this._outlineIndexStart,r[n++]=this._outlineIndexCount;const o=this._patternMap,l=o.size;if(r[n++]=l,l>0)for(const[h,[u,f]]of o)r[n++]=h,r[n++]=u,r[n++]=f;r[n++]=this._fillVertexBuffer.array.length;for(let h=0;h<this._fillVertexBuffer.array.length;h++)a[n++]=this._fillVertexBuffer.array[h];r[n++]=this._fillIndexBuffer.array.length;for(let h=0;h<this._fillIndexBuffer.array.length;h++)r[n++]=this._fillIndexBuffer.array[h];r[n++]=this._outlineVertexBuffer.array.length;for(let h=0;h<this._outlineVertexBuffer.array.length;h++)a[n++]=this._outlineVertexBuffer.array[h];r[n++]=this._outlineIndexBuffer.array.length;for(let h=0;h<this._outlineIndexBuffer.array.length;h++)r[n++]=this._outlineIndexBuffer.array[h];return r.buffer}_processFeature(s,r,a,n,o,l,h){if(!s)return;const u=s.length,f=!o||o.length===0;if(r&&(!a||f))for(let p=0;p<u;p++)this._processOutline(s[p],o);const d=32;let g;for(let p=0;p<u;p++){const y=Lt._area(s[p]);y>d?(g!==void 0&&this._processFill(s,g,n,l,h),g=[p]):y<-d&&g!==void 0&&g.push(p)}g!==void 0&&this._processFill(s,g,n,l,h)}_processOutline(s,r){const a=this._outlineVertexBuffer,n=this._outlineIndexBuffer,o=n.index;let l,h,u;const f=new C(0,0),d=new C(0,0),g=new C(0,0);let p=-1,y=-1,m=-1,w=-1,B=-1,_=!1;const T=0;let I=s.length;if(I<2)return;const A=s[T];let P=s[I-1];for(;I&&P.isEqual(A);)--I,P=s[I-1];if(!(I-T<2)){for(let L=T;L<I;++L){L===T?(l=s[I-1],h=s[T],u=s[T+1],f.assignSub(h,l),f.normalize(),f.rightPerpendicular()):(l=h,h=u,u=L!==I-1?s[L+1]:s[T],f.assign(d));const M=this._isClipEdge(l,h);w===-1&&(_=M),d.assignSub(u,h),d.normalize(),d.rightPerpendicular();const v=f.x*d.y-f.y*d.x;g.assignAdd(f,d),g.normalize();const D=-g.x*-f.x+-g.y*-f.y;let F=Math.abs(D!==0?1/D:1);F>8&&(F=8),v>=0?(m=a.add(h.x,h.y,f.x,f.y,0,1,r),w===-1&&(w=m),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),y=a.add(h.x,h.y,F*-g.x,F*-g.y,0,-1,r),B===-1&&(B=y),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),p=y,y=m,m=a.add(h.x,h.y,g.x,g.y,0,1,r),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),y=a.add(h.x,h.y,d.x,d.y,0,1,r),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m)):(m=a.add(h.x,h.y,F*g.x,F*g.y,0,1,r),w===-1&&(w=m),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),y=a.add(h.x,h.y,-f.x,-f.y,0,-1,r),B===-1&&(B=y),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),p=y,y=m,m=a.add(h.x,h.y,-g.x,-g.y,0,-1,r),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m),p=a.add(h.x,h.y,-d.x,-d.y,0,-1,r),p>=0&&y>=0&&m>=0&&!M&&n.add(p,y,m))}p>=0&&y>=0&&w>=0&&!_&&n.add(p,y,w),p>=0&&w>=0&&B>=0&&!_&&n.add(p,B,w),this._outlineIndexCount+=3*(n.index-o)}}_processFill(s,r,a,n,o){n=!0;let l;r.length>1&&(l=[]);let h=0;for(const g of r)h!==0&&l.push(h),h+=s[g].length;const u=2*h,f=Qe.acquire();for(const g of r){const p=s[g],y=p.length;for(let m=0;m<y;++m)f.push(p[m].x,p[m].y)}const d=st(f,l,2);if(n&&st.deviation(f,l,2,d)>0){const g=r.map(m=>s[m].length),{buffer:p,vertexCount:y}=St(f,g);if(y>0){const m=this._fillVertexBuffer.index;for(let w=0;w<y;w++)this._fillVertexBuffer.add(p[2*w],p[2*w+1],a);for(let w=0;w<y;w+=3){const B=m+w;this._fillIndexBuffer.add(B,B+1,B+2)}if(o!==void 0){const w=this._patternMap,B=w.get(o);B?B[1]+=y:w.set(o,[this._fillIndexStart+this._fillIndexCount,y])}this._fillIndexCount+=y}}else{const g=d.length;if(g>0){const p=this._fillVertexBuffer.index;let y=0;for(;y<u;)this._fillVertexBuffer.add(f[y++],f[y++],a);let m=0;for(;m<g;)this._fillIndexBuffer.add(p+d[m++],p+d[m++],p+d[m++]);if(o!==void 0){const w=this._patternMap,B=w.get(o);B?B[1]+=g:w.set(o,[this._fillIndexStart+this._fillIndexCount,g])}this._fillIndexCount+=g}}Qe.release(f)}_isClipEdge(s,r){return s.x===r.x?s.x<=-64||s.x>=4160:s.y===r.y&&(s.y<=-64||s.y>=4160)}static _area(s){let r=0;const a=s.length-1;for(let n=0;n<a;n++)r+=(s[n].x-s[n+1].x)*(s[n].y+s[n+1].y);return r+=(s[a].x-s[0].x)*(s[a].y+s[0].y),.5*r}};const Fs=65535;class Cs extends Ee{constructor(s,r,a,n,o){super(s,r,a),this.type=2,this._tessellationOptions={pixelCoordRatio:8,halfWidth:0,offset:0},this._patternMap=new Map,this.tessellationProperties={_lineVertexBuffer:null,_lineIndexBuffer:null,_ddValues:null},this.tessellationProperties._lineVertexBuffer=n,this.tessellationProperties._lineIndexBuffer=o,this._lineTessellator=new vt(Rs(this.tessellationProperties),$s(this.tessellationProperties),s.canUseThinTessellation)}get lineIndexStart(){return this._lineIndexStart}get lineIndexCount(){return this._lineIndexCount}getResources(s,r,a){const n=this.layer,o=this.zoom,l=n.getPaintProperty("line-pattern"),h=n.getPaintProperty("line-dasharray"),u=n.getLayoutProperty("line-cap");if(!l&&!h)return;const f=u?.getValue(o)||0,d=u?.isDataDriven,g=l?.isDataDriven,p=h?.isDataDriven;if(g||p)for(const y of this._features)r(g?l.getValue(o,y):this._getDashArrayKey(y,o,n,h,d,u,f));else if(l)r(l.getValue(o));else if(h){const y=h.getValue(o);r(n.getDashKey(y,f))}}processFeatures(s){this._lineIndexStart=3*this.tessellationProperties._lineIndexBuffer.index,this._lineIndexCount=0;const r=this.layer,a=this.zoom,n=this._features,o=this._tessellationOptions,{hasDataDrivenLine:l,lineMaterial:h}=r;s&&s.setExtent(this.layerExtent);const u=r.getPaintProperty("line-pattern"),f=r.getPaintProperty("line-dasharray"),d=u?.isDataDriven,g=f?.isDataDriven;let p;p=r.getLayoutProperty("line-cap");const y=p?.isDataDriven?p:null,m=y?null:r.getLayoutValue("line-cap",a),w=m||0,B=!!y;p=r.getLayoutProperty("line-join");const _=p?.isDataDriven?p:null,T=_?null:r.getLayoutValue("line-join",a);p=r.getLayoutProperty("line-miter-limit");const I=p?.isDataDriven?p:null,A=I?null:r.getLayoutValue("line-miter-limit",a);p=r.getLayoutProperty("line-round-limit");const P=p?.isDataDriven?p:null,L=P?null:r.getLayoutValue("line-round-limit",a);p=r.getPaintProperty("line-width");const M=p?.isDataDriven?p:null,v=M?null:r.getPaintValue("line-width",a);p=r.getPaintProperty("line-offset");const D=p?.isDataDriven?p:null,F=D?null:r.getPaintValue("line-offset",a);if(d||g){const R=[];for(const k of n){const N=d?u.getValue(a,k):this._getDashArrayKey(k,a,r,f,B,y,w),$=this._spriteInfo[N];if(!$?.rect)continue;const z=h.encodeAttributes(k,a,r,$),W=k.getGeometry(s);R.push({ddAttributes:z,page:$.page,cap:y?y.getValue(a,k):m,join:_?_.getValue(a,k):T,miterLimit:I?I.getValue(a,k):A,roundLimit:P?P.getValue(a,k):L,halfWidth:.5*(M?M.getValue(a,k):v),offset:D?D.getValue(a,k):F,geometry:W})}R.sort((k,N)=>k.page-N.page),o.textured=!0;for(const{ddAttributes:k,page:N,cap:$,join:z,miterLimit:W,roundLimit:ce,halfWidth:Q,offset:ne,geometry:ue}of R)o.capType=$,o.joinType=z,o.miterLimit=W,o.roundLimit=ce,o.halfWidth=Q,o.offset=ne,this._processFeature(ue,k,N)}else{if(u){const R=u.getValue(a);if(!this._spriteInfo[R]?.rect)return}o.textured=!(!u&&!f),o.capType=m,o.joinType=T,o.miterLimit=A,o.roundLimit=L,o.halfWidth=.5*v,o.offset=F;for(const R of n){const k=l?h.encodeAttributes(R,a,r):null;y&&(o.capType=y.getValue(a,R)),_&&(o.joinType=_.getValue(a,R)),I&&(o.miterLimit=I.getValue(a,R)),P&&(o.roundLimit=P.getValue(a,R)),M&&(o.halfWidth=.5*M.getValue(a,R)),D&&(o.offset=D.getValue(a,R));const N=R.getGeometry(s);this._processFeature(N,k)}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this.tessellationProperties._lineVertexBuffer.array.length,s+=this.tessellationProperties._lineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const r=new Uint32Array(s),a=new Int32Array(r.buffer);let n=0;r[n++]=this.type,r[n++]=this.layerUIDs.length;for(let h=0;h<this.layerUIDs.length;h++)r[n++]=this.layerUIDs[h];r[n++]=this._lineIndexStart,r[n++]=this._lineIndexCount;const o=this._patternMap,l=o.size;if(r[n++]=l,l>0)for(const[h,[u,f]]of o)r[n++]=h,r[n++]=u,r[n++]=f;r[n++]=this.tessellationProperties._lineVertexBuffer.array.length;for(let h=0;h<this.tessellationProperties._lineVertexBuffer.array.length;h++)a[n++]=this.tessellationProperties._lineVertexBuffer.array[h];r[n++]=this.tessellationProperties._lineIndexBuffer.array.length;for(let h=0;h<this.tessellationProperties._lineIndexBuffer.array.length;h++)r[n++]=this.tessellationProperties._lineIndexBuffer.array[h];return r.buffer}_processFeature(s,r,a){if(!s)return;const n=s.length;for(let o=0;o<n;o++)this._processGeometry(s[o],r,a)}_processGeometry(s,r,a){if(s.length<2)return;const n=.001;let o,l,h=s[0],u=1;for(;u<s.length;)o=s[u].x-h.x,l=s[u].y-h.y,o*o+l*l<n*n?s.splice(u,1):(h=s[u],++u);if(s.length<2)return;const f=this.tessellationProperties._lineIndexBuffer,d=3*f.index;this._tessellationOptions.initialDistance=0,this._tessellationOptions.wrapDistance=Fs,this.tessellationProperties._ddValues=r,this._lineTessellator.tessellate(s,this._tessellationOptions);const g=3*f.index-d;if(a!==void 0){const p=this._patternMap,y=p.get(a);y?y[1]+=g:p.set(a,[d+this._lineIndexCount,g])}this._lineIndexCount+=g}_getDashArrayKey(s,r,a,n,o,l,h){const u=o?l.getValue(r,s):h,f=n.getValue(r,s);return a.getDashKey(f,u)}}const Rs=c=>(s,r,a,n,o,l,h,u,f,d,g)=>(c._lineVertexBuffer.add(s,r,h,u,a,n,o,l,f,d,g,c._ddValues),c._lineVertexBuffer.index-1),$s=c=>(s,r,a)=>{c._lineIndexBuffer.add(s,r,a)},xt=10;function zs(c,s){return c.iconMosaicItem&&s.iconMosaicItem?c.iconMosaicItem.page===s.iconMosaicItem.page?0:c.iconMosaicItem.page-s.iconMosaicItem.page:c.iconMosaicItem&&!s.iconMosaicItem?1:!c.iconMosaicItem&&s.iconMosaicItem?-1:0}const Y=class Y extends Ee{constructor(s,r,a,n,o,l,h,u,f){super(r,a,f.getSpriteItems()),this.type=3,this._markerMap=new Map,this._glyphMap=new Map,this._glyphBufferDataStorage=new Map,this._isIconSDF=!1,this._sourceTileKey=s,this._iconVertexBuffer=n,this._iconIndexBuffer=o,this._textVertexBuffer=l,this._textIndexBuffer=h,this._placementEngine=u,this._workerTileHandler=f}get markerPageMap(){return this._markerMap}get glyphsPageMap(){return this._glyphMap}get symbolInstances(){return this._symbolInstances}getResources(s,r,a){const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);const l=n.getLayoutProperty("icon-image"),h=n.getLayoutProperty("text-field");let u=n.getLayoutProperty("text-transform"),f=n.getLayoutProperty("text-font");const d=[];let g,p,y,m;l&&!l.isDataDriven&&(g=l.getValue(o)),h&&!h.isDataDriven&&(p=h.getValue(o)),u&&u.isDataDriven||(y=n.getLayoutValue("text-transform",o),u=null),f&&f.isDataDriven||(m=n.getLayoutValue("text-font",o),f=null);for(const w of this._features){const B=w.getGeometry(s);if(!B||B.length===0)continue;let _,T;l&&(_=l.isDataDriven?l.getValue(o,w):this._replaceKeys(g,w.values),_&&r(_));let I=!1;if(h&&(T=h.isDataDriven?h.getValue(o,w):this._replaceKeys(p,w.values),T)){switch(T=T.replaceAll("\\n",`
`),u&&(y=u.getValue(o,w)),y){case 2:T=T.toLowerCase();break;case 1:T=T.toUpperCase()}if(Y._bidiEngine.hasBidiChar(T)){let L;L=Y._bidiEngine.checkContextual(T)==="rtl"?"IDNNN":"ICNNN",T=Y._bidiEngine.bidiTransform(T,L,"VLYSN"),I=!0}if(T.length>0){f&&(m=f.getValue(o,w));for(const L of m){let M=a[L];M||(M=a[L]=new Set);for(const v of T){const D=v.codePointAt(0);D!=null&&M.add(D)}}}}if(!_&&!T)continue;const A=n.getLayoutValue("symbol-sort-key",o,w),P={feature:w,sprite:_,label:T,rtl:I,geometry:B,hash:(T?Xe(T):0)^(_?Xe(_):0),priority:A,textFont:m};d.push(P)}this._symbolFeatures=d}processFeatures(s){s&&s.setExtent(this.layerExtent);const r=this.layer,a=this.zoom,n=r.getLayoutValue("symbol-placement",a),o=n!==0,l=r.getLayoutValue("symbol-spacing",a)*be,h=r.getLayoutProperty("icon-image"),u=r.getLayoutProperty("text-field"),f=h?new Vt(r,a,o):null,d=u?new Dt(r,a,o):null,g=this._workerTileHandler;let p;h&&(p=g.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();const y=[];let m=1;d?.size&&(m=d.size/ie);const w=d?d.maxAngle*qe:0,B=d?d.size*be:0;for(const _ of this._symbolFeatures){let T;f&&p&&_.sprite&&(T=p[_.sprite],T&&T.sdf&&(this._isIconSDF=!0));let I;T&&f.update(a,_.feature);let A=0;const P=_.label;if(P){Tt(d),d.update(a,_.feature);const L=o&&d.rotationAlignment===0?d.keepUpright:d.writingMode&&d.writingMode.includes(1);let M=.5;switch(d.anchor){case 5:case 1:case 7:M=0;break;case 6:case 2:case 8:M=1}let v=.5;switch(d.anchor){case 5:case 3:case 6:v=0;break;case 7:case 4:case 8:v=1}let D=.5;switch(d.justify){case 0:D=M;break;case 1:D=0;break;case 3:D=1}const F=d.letterSpacing*ie,R=o?0:d.maxWidth*ie,k=d.lineHeight*ie,N=_.textFont.map($=>g.getGlyphItems($));if(I=new wt(N,R,k,F,M,v,D).getShaping(P,_.rtl,L),I&&I.length>0){let $=1e30,z=-1e30;for(const W of I)$=Math.min($,W.x),z=Math.max(z,W.x);A=(z-$+2*ie)*m*be}}for(let L of _.geometry){const M=[];if(n===1){if(I?.length&&d?.size){const v=d.size*be*(2+Math.min(2,4*Math.abs(d.offset[1])));L=Y._smoothVertices(L,v)}Y._pushAnchors(M,L,l,A)}else n===2?Y._pushCenterAnchor(M,L):_.feature.type===3?Y._pushCentroid(M,L):M.push(new Ue(L[0].x,L[0].y));for(const v of M){if(v.x<0||v.x>pe||v.y<0||v.y>pe||o&&A>0&&d?.rotationAlignment===0&&!Y._honorsTextMaxAngle(L,v,A,w,B))continue;const D={shaping:I,line:L,iconMosaicItem:T,anchor:v,symbolFeature:_,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};y.push(D),this._processFeature(D,f,d)}}}y.sort(zs),this._addPlacedGlyphs(),this._symbolInstances=y}serialize(){let s=14;s+=this.layerUIDs.length,s+=3*this.markerPageMap.size,s+=3*this.glyphsPageMap.size,s+=Y._symbolsSerializationLength(this._symbolInstances),s+=this._iconVertexBuffer.array.length,s+=this._iconIndexBuffer.array.length,s+=this._textVertexBuffer.array.length,s+=this._textIndexBuffer.array.length;const r=new Uint32Array(s),a=new Int32Array(r.buffer),n=new Float32Array(r.buffer),[o,l,h]=this._sourceTileKey.split("/");let u=0;r[u++]=this.type,r[u++]=this.layerUIDs.length;for(let f=0;f<this.layerUIDs.length;f++)r[u++]=this.layerUIDs[f];r[u++]=this._isIconSDF?1:0,r[u++]=parseFloat(o),r[u++]=parseFloat(l),r[u++]=parseFloat(h),r[u++]=this.markerPageMap.size;for(const[f,[d,g]]of this.markerPageMap)r[u++]=f,r[u++]=d,r[u++]=g;r[u++]=this.glyphsPageMap.size;for(const[f,[d,g]]of this.glyphsPageMap)r[u++]=f,r[u++]=d,r[u++]=g;r[u++]=this._iconVertexBuffer.index/4,r[u++]=this._textVertexBuffer.index/4,u=Y.serializeSymbols(r,a,n,u,this._symbolInstances),r[u++]=this._iconVertexBuffer.array.length;for(let f=0;f<this._iconVertexBuffer.array.length;f++)a[u++]=this._iconVertexBuffer.array[f];r[u++]=this._iconIndexBuffer.array.length;for(let f=0;f<this._iconIndexBuffer.array.length;f++)r[u++]=this._iconIndexBuffer.array[f];r[u++]=this._textVertexBuffer.array.length;for(let f=0;f<this._textVertexBuffer.array.length;f++)a[u++]=this._textVertexBuffer.array[f];r[u++]=this._textIndexBuffer.array.length;for(let f=0;f<this._textIndexBuffer.array.length;f++)r[u++]=this._textIndexBuffer.array[f];return r.buffer}static _symbolsSerializationLength(s){let r=0;r+=1;for(const a of s||[]){r+=5,r+=1;for(const n of a.textColliders)r+=xt;for(const n of a.iconColliders)r+=xt;r+=1,r+=2*a.textVertexRanges.length,r+=1,r+=2*a.iconVertexRanges.length}return r}static serializeSymbols(s,r,a,n,o){o=o||[],r[n++]=o.length;for(const l of o){r[n++]=l.anchor.x,r[n++]=l.anchor.y,r[n++]=l.symbolFeature.hash,r[n++]=l.symbolFeature.priority,r[n++]=l.symbolFeature.feature.featureIndex,r[n++]=l.textColliders.length+l.iconColliders.length;for(const h of l.textColliders)r[n++]=h.xTile,r[n++]=h.yTile,r[n++]=h.dxPixels,r[n++]=h.dyPixels,r[n++]=h.hard?1:0,r[n++]=h.partIndex,a[n++]=h.minLod,a[n++]=h.maxLod,r[n++]=h.width,r[n++]=h.height;for(const h of l.iconColliders)r[n++]=h.xTile,r[n++]=h.yTile,r[n++]=h.dxPixels,r[n++]=h.dyPixels,r[n++]=h.hard?1:0,r[n++]=h.partIndex,a[n++]=h.minLod,a[n++]=h.maxLod,r[n++]=h.width,r[n++]=h.height;r[n++]=l.textVertexRanges.length;for(const[h,u]of l.textVertexRanges)r[n++]=h,r[n++]=u;r[n++]=l.iconVertexRanges.length;for(const[h,u]of l.iconVertexRanges)r[n++]=h,r[n++]=u}return n}_replaceKeys(s,r){return s.replaceAll(/{([^{}]+)}/g,(a,n)=>n in r?r[n]:"")}_processFeature(s,r,a){const{line:n,iconMosaicItem:o,shaping:l,anchor:h}=s,u=this.zoom,f=this.layer,d=!!o;let g=!0;d&&(g=r?.optional||!o);const p=l&&l.length>0,y=!p||a?.optional;let m,w;if(d&&(m=this._placementEngine.getIconPlacement(h,o,r)),(m||g)&&(p&&(w=this._placementEngine.getTextPlacement(h,l,n,a)),w||y)){if(m&&w||(y||g?y||w?g||m||(w=null):m=null:(m=null,w=null)),w){const B=f.hasDataDrivenText?f.textMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._storePlacedGlyphs(s,w.shapes,u,a.rotationAlignment,B),w.textColliders){s.textColliders=w.textColliders;for(const _ of w.textColliders){_.minLod=Math.max(u+le(_.minLod),0),_.maxLod=Math.min(u+le(_.maxLod),25);const T=_.angle;if(T){const I=Math.cos(T),A=Math.sin(T),P=_.dxPixels*I-_.dyPixels*A,L=_.dxPixels*A+_.dyPixels*I,M=(_.dxPixels+_.width)*I-_.dyPixels*A,v=(_.dxPixels+_.width)*A+_.dyPixels*I,D=_.dxPixels*I-(_.dyPixels+_.height)*A,F=_.dxPixels*A+(_.dyPixels+_.height)*I,R=(_.dxPixels+_.width)*I-(_.dyPixels+_.height)*A,k=(_.dxPixels+_.width)*A+(_.dyPixels+_.height)*I,N=Math.min(P,M,D,R),$=Math.max(P,M,D,R),z=Math.min(L,v,F,k),W=Math.max(L,v,F,k);_.dxPixels=N,_.dyPixels=z,_.width=$-N,_.height=W-z}}}}if(m){const B=f.hasDataDrivenIcon?f.iconMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._addPlacedIcons(s,m.shapes,u,o.page,r.rotationAlignment===1,B),m.iconColliders){s.iconColliders=m.iconColliders;for(const _ of m.iconColliders){_.minLod=Math.max(u+le(_.minLod),0),_.maxLod=Math.min(u+le(_.maxLod),25);const T=_.angle;if(T){const I=Math.cos(T),A=Math.sin(T),P=_.dxPixels*I-_.dyPixels*A,L=_.dxPixels*A+_.dyPixels*I,M=(_.dxPixels+_.width)*I-_.dyPixels*A,v=(_.dxPixels+_.width)*A+_.dyPixels*I,D=_.dxPixels*I-(_.dyPixels+_.height)*A,F=_.dxPixels*A+(_.dyPixels+_.height)*I,R=(_.dxPixels+_.width)*I-(_.dyPixels+_.height)*A,k=(_.dxPixels+_.width)*A+(_.dyPixels+_.height)*I,N=Math.min(P,M,D,R),$=Math.max(P,M,D,R),z=Math.min(L,v,F,k),W=Math.max(L,v,F,k);_.dxPixels=N,_.dyPixels=z,_.width=$-N,_.height=W-z}}}}}}_addPlacedIcons(s,r,a,n,o,l){const h=Math.max(a-1,0),u=this._iconVertexBuffer,f=this._iconIndexBuffer,d=this._markerMap;for(const g of r){const p=o?0:Math.max(a+le(g.minzoom),h),y=o?25:Math.min(a+le(g.maxzoom),25);if(y<=p)continue;const m=g.tl,w=g.tr,B=g.bl,_=g.br,T=g.mosaicRect,I=g.labelAngle,A=g.minAngle,P=g.maxAngle,L=g.anchor,M=u.index,v=T.x,D=T.y,F=v+T.width,R=D+T.height,k=u.index;u.add(L.x,L.y,m.x,m.y,v,D,I,A,P,p,y,l),u.add(L.x,L.y,w.x,w.y,F,D,I,A,P,p,y,l),u.add(L.x,L.y,B.x,B.y,v,R,I,A,P,p,y,l),u.add(L.x,L.y,_.x,_.y,F,R,I,A,P,p,y,l),s.iconVertexRanges.length>0&&s.iconVertexRanges[0][0]+s.iconVertexRanges[0][1]===k?s.iconVertexRanges[0][1]+=4:s.iconVertexRanges.push([k,4]),f.add(M,M+1,M+2),f.add(M+1,M+2,M+3),d.has(n)?d.get(n)[1]+=6:d.set(n,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}}_addPlacedGlyphs(){const s=this._textVertexBuffer,r=this._textIndexBuffer,a=this._glyphMap;for(const[n,o]of this._glyphBufferDataStorage)for(const l of o){const h=s.index,u=l.symbolInstance,f=l.ddAttributes,d=s.index;s.add(l.glyphAnchor[0],l.glyphAnchor[1],l.tl[0],l.tl[1],l.xmin,l.ymin,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,f),s.add(l.glyphAnchor[0],l.glyphAnchor[1],l.tr[0],l.tr[1],l.xmax,l.ymin,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,f),s.add(l.glyphAnchor[0],l.glyphAnchor[1],l.bl[0],l.bl[1],l.xmin,l.ymax,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,f),s.add(l.glyphAnchor[0],l.glyphAnchor[1],l.br[0],l.br[1],l.xmax,l.ymax,l.labelAngle,l.minAngle,l.maxAngle,l.minLod,l.maxLod,f),u.textVertexRanges.length>0&&u.textVertexRanges[0][0]+u.textVertexRanges[0][1]===d?u.textVertexRanges[0][1]+=4:u.textVertexRanges.push([d,4]),r.add(h,h+1,h+2),r.add(h+1,h+2,h+3),a.has(n)?a.get(n)[1]+=6:a.set(n,[this._textIndexStart+this._textIndexCount,6]),this._textIndexCount+=6}this._glyphBufferDataStorage.clear()}_storePlacedGlyphs(s,r,a,n,o){const l=Math.max(a-1,0),h=n===1;let u,f,d,g,p,y,m,w,B,_,T;for(const I of r)u=h?0:Math.max(a+le(I.minzoom),l),f=h?25:Math.min(a+le(I.maxzoom),25),!(f<=u)&&(d=I.tl,g=I.tr,p=I.bl,y=I.br,m=I.labelAngle,w=I.minAngle,B=I.maxAngle,_=I.anchor,T=I.mosaicRect,this._glyphBufferDataStorage.has(I.page)||this._glyphBufferDataStorage.set(I.page,[]),this._glyphBufferDataStorage.get(I.page).push({glyphAnchor:[_.x,_.y],tl:[d.x,d.y],tr:[g.x,g.y],bl:[p.x,p.y],br:[y.x,y.y],xmin:T.x,ymin:T.y,xmax:T.x+T.width,ymax:T.y+T.height,labelAngle:m,minAngle:w,maxAngle:B,minLod:u,maxLod:f,placementLod:l,symbolInstance:s,ddAttributes:o}))}static _pushAnchors(s,r,a,n){a+=n;let o=0;const l=r.length-1;for(let p=0;p<l;p++)o+=C.distance(r[p],r[p+1]);let h=n||a;if(h*=.5,o<=h)return;const u=h/o;let f=0,d=-(a=o/Math.max(Math.round(o/a),1))/2;const g=r.length-1;for(let p=0;p<g;p++){const y=r[p],m=r[p+1],w=m.x-y.x,B=m.y-y.y,_=Math.sqrt(w*w+B*B);let T;for(;d+a<f+_;){d+=a;const I=(d-f)/_,A=Se(y.x,m.x,I),P=Se(y.y,m.y,I);T===void 0&&(T=Math.atan2(B,w)),s.push(new Ue(A,P,T,p,u))}f+=_}}static _pushCenterAnchor(s,r){let a=0;const n=r.length-1;for(let u=0;u<n;u++)a+=C.distance(r[u],r[u+1]);const o=a/2;let l=0;const h=r.length-1;for(let u=0;u<h;u++){const f=r[u],d=r[u+1],g=d.x-f.x,p=d.y-f.y,y=Math.sqrt(g*g+p*p);if(o<l+y){const m=(o-l)/y,w=Se(f.x,d.x,m),B=Se(f.y,d.y,m),_=Math.atan2(p,g);return void s.push(new Ue(w,B,_,u,0))}l+=y}}static _deviation(s,r,a){const n=(r.x-s.x)*(a.x-r.x)+(r.y-s.y)*(a.y-r.y),o=(r.x-s.x)*(a.y-r.y)-(r.y-s.y)*(a.x-r.x);return Math.atan2(o,n)}static _honorsTextMaxAngle(s,r,a,n,o){let l=0;const h=a/2;let u=new C(r.x,r.y),f=r.segment+1;for(;l>-h;){if(--f,f<0)return!1;l-=C.distance(s[f],u),u=s[f]}l+=C.distance(s[f],s[f+1]);const d=[];let g=0;const p=s.length;for(;l<h;){const y=s[f];let m,w=f;do{if(++w,w===p)return!1;m=s[w]}while(m.isEqual(y));let B,_=w;do{if(++_,_===p)return!1;B=s[_]}while(B.isEqual(m));const T=this._deviation(y,m,B);for(d.push({deviation:T,distToAnchor:l}),g+=T;l-d[0].distToAnchor>o;)g-=d.shift().deviation;if(Math.abs(g)>n)return!1;l+=C.distance(m,B),f=w}return!0}static _smoothVertices(s,r){if(r<=0)return s;let a=s.length;if(a<3)return s;const n=[];let o=0,l=0;n.push(0);for(let w=1;w<a;w++){const B=C.distance(s[w],s[w-1]);B>0&&(o+=B,n.push(o),l++,l!==w&&(s[l]=s[w]))}if(a=l+1,a<3)return s;r=Math.min(r,.2*o);const h=s[0].x,u=s[0].y,f=s[a-1].x,d=s[a-1].y,g=C.sub(s[0],s[1]);g.normalize(),s[0].x+=r*g.x,s[0].y+=r*g.y,g.assignSub(s[a-1],s[a-2]),g.normalize(),s[a-1].x+=r*g.x,s[a-1].y+=r*g.y,n[0]-=r,n[a-1]+=r;const p=[];p.push(new C(h,u));const y=1e-6,m=.5*r;for(let w=1;w<a-1;w++){let B=0,_=0,T=0;for(let I=w-1;I>=0;I--){const A=m+n[I+1]-n[w];if(A<0)break;const P=n[I+1]-n[I],L=n[w]-n[I]<m?1:A/P;if(L<y)break;const M=L*L,v=L*A-.5*M*P,D=L*P/r,F=s[I+1],R=s[I].x-F.x,k=s[I].y-F.y;B+=D/v*(F.x*L*A+.5*M*(A*R-P*F.x)-M*L*P*R/3),_+=D/v*(F.y*L*A+.5*M*(A*k-P*F.y)-M*L*P*k/3),T+=D}for(let I=w+1;I<a;I++){const A=m-n[I-1]+n[w];if(A<0)break;const P=n[I]-n[I-1],L=n[I]-n[w]<m?1:A/P;if(L<y)break;const M=L*L,v=L*A-.5*M*P,D=L*P/r,F=s[I-1],R=s[I].x-F.x,k=s[I].y-F.y;B+=D/v*(F.x*L*A+.5*M*(A*R-P*F.x)-M*L*P*R/3),_+=D/v*(F.y*L*A+.5*M*(A*k-P*F.y)-M*L*P*k/3),T+=D}p.push(new C(B/T,_/T))}return p.push(new C(f,d)),s[0].x=h,s[0].y=u,s[a-1].x=f,s[a-1].y=d,p}static _pushCentroid(s,r){const o=pe,l=pe,h=r.length-1;let u=0,f=0,d=0,g=r[0].x,p=r[0].y;g>o&&(g=o),g<0&&(g=0),p>l&&(p=l),p<0&&(p=0);for(let y=1;y<h;y++){let m=r[y].x,w=r[y].y,B=r[y+1].x,_=r[y+1].y;m>o&&(m=o),m<0&&(m=0),w>l&&(w=l),w<0&&(w=0),B>o&&(B=o),B<0&&(B=0),_>l&&(_=l),_<0&&(_=0);const T=(m-g)*(_-p)-(B-g)*(w-p);u+=T*(g+m+B),f+=T*(p+w+_),d+=T}u/=3*d,f/=3*d,isNaN(u)||isNaN(f)||s.push(new Ue(u,f))}};Y._bidiEngine=new es;let He=Y;class Ns{constructor(s,r,a,n,o,l){if(this._pbfTiles={},this._tileClippers={},this._client=a,this._tile=r,this._sourceDataMaxLOD=n,l){this._styleLayerUIDs=new Set;for(const g of l)this._styleLayerUIDs.add(g)}this._styleRepository=o,this._layers=this._styleRepository?.layers??[];const[h,u,f]=r.tileKey.split("/").map(parseFloat);this._level=h;const d=Bt(this._level);for(const g of Object.keys(s)){const p=s[g];if(this._pbfTiles[g]=new Ft(new Uint8Array(p.protobuff),new DataView(p.protobuff)),p.refKey){const[y]=p.refKey.split("/").map(parseFloat),m=h-y;if(m>0){const w=(1<<m)-1,B=u&w,_=f&w;this._tileClippers[g]=new Mt(m,B,_,8,d)}}this._tileClippers[g]||(this._tileClippers[g]=new Pt)}}_canParseStyleLayer(s){return!this._styleLayerUIDs||this._styleLayerUIDs.has(s)}async parse(s){const r=Ut(),a=this._initialize(s),{returnedBuckets:n}=a;this._processLayers(a),this._linkReferences(a),this._filterFeatures(a);const o=[],l=new Set,h=(d,g)=>{l.has(d)||(o.push({name:d,repeat:g}),l.add(d))},u={};for(const d of n)d.getResources(d.tileClipper,h,u);if(this._tile.status===4)return[];const f=this._fetchResources(o,u,s);return Promise.all([...f,r]).then(()=>this._processFeatures(a.returnedBuckets))}_initialize(s){return{signal:s?.signal,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}}_processLayers(s){const{sourceNameToTileData:r,zoom:a,layers:n,sourceNameToTileClipper:o,sourceNameToUniqueSourceLayerBuckets:l,sourceNameToUniqueSourceLayers:h,returnedBuckets:u,layerIdToBucket:f,referencerUIDToReferencedId:d}=s,g=this._sourceDataMaxLOD;for(let p=n.length-1;p>=0;p--){const y=n[p];if(a<g){if(y.minzoom&&a<Math.floor(y.minzoom)||y.maxzoom&&a>=y.maxzoom)continue}else if(y.maxzoom&&a>=y.maxzoom)continue;if(y.type===0||!this._canParseStyleLayer(y.uid)||!r[y.source]||!o[y.source])continue;const m=r[y.source],w=o[y.source],B=y.sourceLayer,_=m[B];if(_){let T=h[y.source];if(T||(T=h[y.source]=new Set),T.add(y.sourceLayer),y.refLayerId)d.set(y.uid,y.refLayerId);else{const I=this._createBucket(y);if(I){I.layerUIDs=[y.uid],I.layerExtent=_.extent,I.tileClipper=w;let A=l[y.source];A||(A=l[y.source]={});let P=A[B];P||(P=A[B]=[]),P.push(I),u.push(I),f[y.id]=I}}}}}_linkReferences(s){const{layerIdToBucket:r,referencerUIDToReferencedId:a}=s;a.forEach((n,o)=>{r[n]&&r[n].layerUIDs.push(o)})}_filterFeatures(s){const{signal:r,sourceNameToTileData:a,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o}=s,l=10*this._level,h=10*(this._level+1),u=[],f=[];for(const d of Object.keys(o))o[d].forEach(g=>{u.push(g),f.push(d)});for(let d=0;d<u.length;d++){const g=f[d],p=u[d];if(!a[g]||!n[g])continue;const y=a[g][p],m=n[g][p];if(!m||m.length===0)continue;if(At(r))return;let w=0;const B=y.getData();for(;B.nextTag(2);){const _=B.getMessage(),T=new Ms(_,y,w++);_.release();const I=T.values;if(I){const A=I._minzoom;if(A&&A>=h)continue;const P=I._maxzoom;if(P&&P<=l)continue}for(const A of m)A.pushFeature(T)}}}_fetchResources(s,r,a){const n=[],o=this._tile.getWorkerTileHandler();let l,h;s.length>0&&(l=o.fetchSprites(s,this._client,a),n.push(l));for(const u in r){const f=r[u];f.size>0&&(h=o.fetchGlyphs(this._tile.tileKey,u,f,this._client,a),n.push(h))}return n}_processFeatures(s){const r=s.filter(a=>a.hasFeatures()||this._canParseStyleLayer(a.layer.uid));for(const a of r)a.processFeatures(a.tileClipper);return r}_parseTileData(s){const r={};for(const a of Object.keys(s)){const n=s[a],o={};for(;n.next();)switch(n.tag()){case 3:{const l=n.getMessage(),h=new Ps(l);l.release(),o[h.name]=h;break}default:n.skip()}r[a]=o}return r}_createBucket(s){switch(s.type){case 0:return null;case 1:return this._createFillBucket(s);case 2:return this._createLineBucket(s);case 4:return this._createCircleBucket(s);case 3:return this._createSymbolBucket(s)}}_createFillBucket(s){return new Us(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Ds(s.fillMaterial.getStride()),new ye,new ks(s.outlineMaterial.getStride()),new ye)}_createLineBucket(s){return new Cs(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Vs(s.lineMaterial.getStride()),new ye)}_createCircleBucket(s){return new vs(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Ss(s.circleMaterial.getStride()),new ye)}_createSymbolBucket(s){const r=this._tile;return new He(r.tileKey,s,this._level,new dt(s.iconMaterial.getStride()),new ye,new dt(s.textMaterial.getStride()),new ye,r.placementEngine,r.getWorkerTileHandler())}}let Es=class{constructor(s,r,a,n){this.status=0,this.placementEngine=new Bs,this.tileKey=s,this.refKeys=r,this._workerTileHandler=a,this._styleRepository=n}release(){this.tileKey="",this.refKeys=null,this.status=0,this._workerTileHandler=null}async parse(s,r){const a=r?.signal;if(a!=null){const d=()=>{a.removeEventListener("abort",d),this.status=4};a.addEventListener("abort",d)}let n;const o={bucketsWithData:[],emptyBuckets:null};try{n=await this._parse(s,r)}catch(d){if(yt(d))throw d;return{result:o,transferList:[]}}this.status=2;const l=o.bucketsWithData,h=[];for(const d of n)if(d.hasFeatures()){const g=d.serialize();l.push(g)}else h.push(d.layer.uid);const u=[...l];let f=null;return h.length>0&&(f=Uint32Array.from(h),u.push(f.buffer)),o.emptyBuckets=f,{result:o,transferList:u}}setObsolete(){this.status=4}getLayers(){return this._workerTileHandler.getLayers()}getWorkerTileHandler(){return this._workerTileHandler}async _parse(s,r){const a=s.sourceName2DataAndRefKey;return Object.keys(a).length===0?[]:(this.status=3,new Ns(a,this,r.client,s.sourceDataMaxLOD,this._styleRepository,s.styleLayerUIDs).parse(r))}};const Os=25;class ur{constructor(){this._spriteInfo={},this._glyphInfo={},this._sourceDataMaxLOD=Os}reset(){return this._spriteInfo={},this._glyphInfo={},Promise.resolve()}getLayers(){return this._styleRepository?.layers??[]}async createTileAndParse(s,r){const{key:a}=s,n={};for(const l of Object.keys(s.sourceName2DataAndRefKey)){const h=s.sourceName2DataAndRefKey[l];n[l]=h.refKey}const o=new Es(a,n,this,this._styleRepository);try{return await o.parse({...s,sourceDataMaxLOD:this._sourceDataMaxLOD},r)}catch(l){if(o.setObsolete(),o.release(),!yt(l))throw l;return null}}updateStyle(s){if(!s||s.length===0||!this._styleRepository)return;const r=this._styleRepository;for(const a of s){const n=a.type,o=a.data;switch(n){case 0:r.setPaintProperties(o.layer,o.paint);break;case 1:r.setLayoutProperties(o.layer,o.layout);break;case 3:r.deleteStyleLayer(o.layer);break;case 2:r.setStyleLayer(o.layer,o.index);break;case 4:this._spriteInfo={}}}}setStyle(s){const{style:r,sourceDataMaxLOD:a}=s;this._styleRepository=new kt(r),this._sourceDataMaxLOD=a,this._spriteInfo={},this._glyphInfo={}}fetchSprites(s,r,a){const n=[],o=this._spriteInfo;for(const l of s)o[l.name]===void 0&&n.push(l);return n.length===0?Promise.resolve():r.invoke("getSprites",n,{signal:a?.signal}).then(l=>{for(const h in l){const u=l[h];o[h]=u}})}getSpriteItems(){return this._spriteInfo}fetchGlyphs(s,r,a,n,o){const l=[];let h=this._glyphInfo[r];return h?a.forEach(u=>{h[u]||l.push(u)}):(h=this._glyphInfo[r]=[],a.forEach(u=>l.push(u))),l.length===0?Promise.resolve():n.invoke("getGlyphs",{tileID:s,font:r,codePoints:l},o).then(u=>{for(let f=0;f<u.length;f++)u[f]&&(h[f]=u[f])})}getGlyphItems(s){return this._glyphInfo[s]}}export{ur as default};
