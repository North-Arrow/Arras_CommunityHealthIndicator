import{aE as J,B as se,_ as w,z as F,A as te,P as Ne,N as Te,b9 as $e,dp as Me,dr as Re,dq as Oe,H as Ge,gV as Ve,U as ze,ds as He,cf as L,ch as j,M as Ee,ac as We,gW as _e,cp as Be}from"./MapPage-CPF73lPx.js";import{m as Je}from"./TimeOnly-f3LpuYBu.js";import{t as Ke,I as qe,l as ue}from"./arcadeUtils-CHyZeHBv.js";import{o as D,E as Qe,D as de,B as C,p as R,g as k,Z as Ye,h as ve,A as De,X as ke,z as Z,V as K,H as ne,b as _,Y as Xe,L as et,S as q,a0 as tt,a1 as Se,a2 as ie,a3 as ce}from"./aiServices-Azz0FLYs.js";import{n as y,o as nt,t as it}from"./enum-C6z-cI83.js";import{v as rt,R as xe,y as ot,h as me,e as at,i as st,s as lt,F as oe,E as ut,k as dt,O as ct,a as W,I as mt,D as re,b as P,x as fe}from"./featureSetUtils-DywAnxAG.js";import{l as ft}from"./portalUtils-SYx1xxdM.js";import{s as pt,v as Ae}from"./SpatialFilter-C1lp2Cuv.js";import{L as v}from"./WhereClause-BP-FgR_r.js";import Le from"./FeatureLayer-chy9BDlc.js";import{m as $}from"./Field-pSRTj6wY.js";import"./index-7PPb1Lqt.js";import"./themeLevelStore-BEZZTr5D.js";import"./UnknownTimeZone-C7dv5FPZ.js";import"./featureConversionUtils-BogUblz-.js";import"./OptimizedFeature-CoPpekGu.js";import"./memoryEstimations-Zoxd2OM8.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./FieldsIndex-D-KPsL6T.js";import"./timeZoneUtils-CDYh9gPr.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-C7UnrpmM.js";import"./number-DbbXpnA3.js";import"./uuid-Br8ls8Db.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./rasterFieldUtils-DrARcF9a.js";import"./MD5-MtSiOt06.js";import"./labelingInfo-h5ZP-5S0.js";import"./asyncUtils-BrJ168g9.js";import"./Query-l9kmspG7.js";import"./SimpleRenderer-Bex_XKtx.js";import"./ClassBreaksRenderer-ghW4XW9M.js";import"./diffUtils-BN-Cu4ei.js";import"./RendererLegendOptions-CeICfgMe.js";import"./styleUtils-BVPbehzt.js";import"./colorRamps-EqBYyQvg.js";import"./OperationalLayer--tsDO1h0.js";import"./jsonUtils-DN6Zalqs.js";import"./defaults-TEI0g0pJ.js";import"./defaultsJSON-GKolV7NZ.js";import"./NormalizationBinParametersMixin-Cma6tqaF.js";import"./labelUtils-lmhPvxL7.js";import"./FeatureType-OpENXNni.js";import"./FeatureTemplate-BCT-GPxd.js";import"./PortalItem-TSgYYjyD.js";import"./operatorsWorkerConnection-BjUNCuoC.js";import"./workers-PlZuvTi_.js";import"./Queue-B8ScGny7.js";import"./MultiOriginJSONSupport-DT4dyYEI.js";import"./FormTemplate-Cf7I0E3u.js";import"./GraphicOrigin-CdpfQ1D2.js";import"./editsZScale-CVdZLSXq.js";import"./queryZScale-iAe8hVDP.js";import"./projectionUtils-dWs4JKMm.js";import"./FeatureSet-tpXm9IxM.js";import"./APIKeyMixin-jvWYUK2P.js";import"./ArcGISService-B-h6gmGz.js";import"./BlendLayer-DvnrReaK.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-BseGW36B.js";import"./CustomParametersMixin-CrTO1Zfp.js";import"./DisplayFilteredLayer-BbouYBBJ.js";import"./displayFilterUtils-DczWPtlq.js";import"./EditBusLayer-Cbebh3Fm.js";import"./FeatureEffectLayer-DAks6BFd.js";import"./FeatureLayerBase-CRp25XX8.js";import"./HeightModelInfo-szOcfKzV.js";import"./LayerFloorInfo-CZI9Dnro.js";import"./multiLayerServiceUtils-BcJPTDP3.js";import"./Relationship-B-5J2ls5.js";import"./serviceCapabilitiesUtils-CQM6e4VD.js";import"./infoFor3D-DhzudQro.js";import"./portalItemUtils-BFkQHJov.js";import"./FeatureReductionLayer-BtWDx0oZ.js";import"./FeatureReductionSelection-6ZVpcjZM.js";import"./jsonUtils-BjblnhAy.js";import"./typeUtils-DfpJhpzR.js";import"./LRUCache-DKQgJMRL.js";import"./DictionaryScriptEvaluator-7Apjt26H.js";import"./Version-CeECp8tc.js";import"./utils-CNckjA7H.js";import"./heatmapUtils-6ik_vxpl.js";import"./vec42-BnyrgOV-.js";import"./vec4f64-CvoGn1-Y.js";import"./OrderedLayer-BCF9w21T.js";import"./PortalLayer-BP_wc1oE.js";import"./RefreshableLayer-DOVfRid-.js";import"./ScaleRangeLayer-Ka2jF1gE.js";import"./TemporalLayer-BY6LxC_g.js";import"./TimeInfo-3kHvFuz4.js";import"./TrackableLayer-6IJURiiG.js";import"./fieldProperties-BKtFUDSu.js";import"./TitleCreator-DU36jVkC.js";import"./sanitizerUtils-DvKU1K2H.js";import"./versionUtils-CVa873ko.js";import"./styleUtils-BJBwVdCV.js";import"./popupUtils-BBnUHoct.js";import"./fieldType-BYpGaw7d.js";new J({Clean:"clean",Dirty:"dirty"});new J({Physical:"physical",Virtual:"virtual"});new J({"Start and end":"start-and-end",Start:"start",Midspan:"midspan",End:"end"});new J({startingPoint:"starting-point",barrier:"barrier",stoppingPoint:"stopping-point"});new J({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const je="{00000000-0000-0000-0000-000000000000}",O=new J({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new J({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let S=class extends se{constructor(l){super(l),this.type="networkElement",this.assetGroupCode=null,this.assetTypeCode=null,this.globalId=null,this.networkSourceId=null,this.objectId=null,this.positionFrom=null,this.positionTo=null,this.terminalId=null}};w([F({json:{write:!1}})],S.prototype,"type",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"assetGroupCode",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"assetTypeCode",void 0),w([F({type:String,json:{write:!0}})],S.prototype,"globalId",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"networkSourceId",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"objectId",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"positionFrom",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"positionTo",void 0),w([F({type:Number,json:{write:!0}})],S.prototype,"terminalId",void 0),S=w([te("esri.rest.networks.support.NetworkElement")],S);let B=class extends S{constructor(i){super(i),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};w([F({json:{write:!1}})],B.prototype,"type",void 0),w([F({json:{write:!0}})],B.prototype,"firstUnit",void 0),w([F({json:{write:!0}})],B.prototype,"numUnits",void 0),B=w([te("esri.rest.networks.support.TelecomNetworkElement")],B);let A=class extends se{constructor(l){super(l),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(l,t){return t.fromFirstUnit||t.fromNumUnits?new B({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId,firstUnit:t.fromFirstUnit,numUnits:t.fromNumUnits}):new S({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(l,t){if(l&&(t.fromGlobalId=l.globalId,t.fromNetworkSourceId=l.networkSourceId,t.fromTerminalId=l.terminalId,l.type==="telecomNetworkElement")){const r=l;t.fromFirstUnit=r.firstUnit,t.fromNumUnits=r.numUnits}}readToNetworkElement(l,t){return t.toFirstUnit||t.toNumUnits?new B({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId,firstUnit:t.toFirstUnit,numUnits:t.toNumUnits}):new S({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(l,t){if(l&&(t.toGlobalId=l.globalId,t.toNetworkSourceId=l.networkSourceId,t.toTerminalId=l.terminalId,l.type==="telecomNetworkElement")){const r=l;t.toFirstUnit=r.firstUnit,t.toNumUnits=r.numUnits}}equals(l){if(this.globalId===je&&l.globalId===je){let t=function(s,p){return s.networkSourceId===p.networkSourceId&&s.globalId===p.globalId&&s.terminalId===p.terminalId&&s.firstUnit===p.firstUnit&&s.numUnits===p.numUnits};const r=this.fromNetworkElement,I=this.toNetworkElement,g=l.fromNetworkElement,e=l.toNetworkElement,n=t(r,g),a=t(I,e);return n&&a&&this.associationType===l.associationType}return this.globalId!=null&&l.globalId!=null&&this.globalId===l.globalId}};w([F({type:String,json:{write:!0}})],A.prototype,"globalId",void 0),w([F({type:O.apiValues,json:{type:O.jsonValues,read:O.read,write:O.write}})],A.prototype,"associationType",void 0),w([F({type:S,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],A.prototype,"fromNetworkElement",void 0),w([Ne("fromNetworkElement")],A.prototype,"readFromNetworkElement",null),w([Te("fromNetworkElement")],A.prototype,"writeFromNetworkElement",null),w([F({type:S,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],A.prototype,"toNetworkElement",void 0),w([Ne("toNetworkElement")],A.prototype,"readToNetworkElement",null),w([Te("toNetworkElement")],A.prototype,"writeToNetworkElement",null),w([F({type:$e,json:{write:!0}})],A.prototype,"geometry",void 0),w([F({type:String,json:{write:!0}})],A.prototype,"errorMessage",void 0),w([F({type:Number,json:{write:!0}})],A.prototype,"percentAlong",void 0),w([F({type:Number,json:{write:!0}})],A.prototype,"errorCode",void 0),w([F({type:Boolean,json:{write:!0}})],A.prototype,"isContentVisible",void 0),w([F({type:Number,json:{write:!0}})],A.prototype,"status",void 0),A=w([te("esri.rest.networks.support.Association")],A);let ae=class extends se{constructor(l){super(l),this.associations=[]}};w([F({type:[A],json:{write:!0}})],ae.prototype,"associations",void 0),ae=w([te("esri.rest.networks.support.QueryAssociationsResult")],ae);function yt(i){const{returnDeletes:l,elements:t,gdbVersion:r,moment:I}=i.toJSON();return{returnDeletes:l,elements:JSON.stringify(t.map(g=>({globalId:g.globalId,networkSourceId:g.networkSourceId,terminalId:g.terminalId}))),types:JSON.stringify(i.types.map(g=>O.toJSON(g))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:r,moment:I??Date.now()}}async function wt(i,l,t){const r=Me(i),I={...yt(l),f:"json"},g=Re({...r.query,...I}),e=Oe(g,{...t,method:"post"}),n=`${r.path}/associations/query`,{data:a}=await Ge(n,e),s=ae.fromJSON(a);return l.types.includes("connectivity")&&Ve(ze.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),s}var ye;let z=ye=class extends se{static from(i){return He(ye,i)}constructor(i){super(i),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};w([F({type:Boolean,json:{write:!0}})],z.prototype,"returnDeletes",void 0),w([F({type:[S],json:{write:!0}})],z.prototype,"elements",void 0),w([F({type:[O.apiValues],json:{type:O.jsonValues,read:O.read,write:O.write}})],z.prototype,"types",void 0),w([F({type:String,json:{write:!0}})],z.prototype,"gdbVersion",void 0),w([F({type:Date,json:{type:Number,write:{writer:(i,l)=>{l.moment=i?.getTime()}}}})],z.prototype,"moment",void 0),z=ye=w([te("esri.rest.networks.support.QueryAssociationsParameters")],z);function It(i){if(i.length===1){if(j(i[0]))return ue("distinct",i[0],-1);if(_(i[0]))return ue("distinct",i[0].toArray(),-1)}return ue("distinct",i,-1)}function pe(i,l,t){const r=i.getVariables();if(r.length>0){const I={};for(const g of r)I[g]=l.evaluateIdentifier(t,{name:g});i.parameters=I}return i}function c(i,l,t=null){for(const r in i)if(r.toLowerCase()===l.toLowerCase())return i[r];return t}function Ce(i){if(i===null)return null;const l={type:c(i,"type",""),name:c(i,"name","")};if(l.type==="range")l.range=c(i,"range",[]);else{l.codedValues=[];for(const t of c(i,"codedValues",[]))l.codedValues.push({name:c(t,"name",""),code:c(t,"code",null)})}return l}function we(i){if(i===null)return null;const l={},t=c(i,"wkt");t!==null&&(l.wkt=t);const r=c(i,"wkid");return r!==null&&(l.wkid=r),l}function Ue(i){if(i===null)return null;const l={hasZ:c(i,"hasz",!1),hasM:c(i,"hasm",!1)},t=c(i,"spatialreference");t!=null&&(l.spatialReference=we(t));const r=c(i,"x",null);if(r!==null)return l.x=r,l.y=c(i,"y",null),l.hasZ&&(l.z=c(i,"z",null)),l.hasM&&(l.m=c(i,"m",null)),l;const I=c(i,"rings",null);if(I!==null)return l.rings=I,l;const g=c(i,"paths",null);if(g!==null)return l.paths=g,l;const e=c(i,"points",null);if(e!==null)return l.points=e,l;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=c(i,n,null);a!==null&&(l[n]=a)}return l}function gt(i,l){for(const t of l)if(t===i)return!0;return!1}function ht(i){return!!i.layerDefinition&&!!i.featureSet&&gt(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&j(i.layerDefinition.fields)!==!1&&j(i.featureSet.features)!==!1}function Q(i){return i?.toLowerCase()==="utc"?"UTC":i?.toLowerCase()==="unknown"?"Unknown":i}async function bt(i,l,t,r,I,g,e){const n=await i.getFeatureSetInfo();if((n?.layerId??null)===null||!I.layerIdLookup.get(n.layerId))return null;const a=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),s=[];switch(t){case"connected":s.push("connectivity"),s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity"),s.push("junction-edge-midspan-connectivity"),s.push("junction-junction-connectivity");break;case"container":case"content":s.push("containment");break;case"structure":case"attached":s.push("attachment");break;case"junctionedge":s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity");break;case"midspan":s.push("junction-edge-midspan-connectivity");break;default:throw new y(g,"InvalidParameter",e)}let p=null,m=!1;if(r!==null&&r!==""&&r!==void 0){for(const d of I.terminals)d.terminalName===r&&(p=d.terminalId);p===null&&(m=!0)}const u=[];if(!m){const d=new S({globalId:l.field(i.globalIdField),networkSourceId:I.layerIdLookup.get(n.layerId).sourceId,...p?{terminalId:p}:""}),f=await wt(a,new z({types:s,elements:[d]}));let x=0;for(const h of f.associations){let b=null,E="",M="";if(h.fromNetworkElement?.globalId===d.globalId?(b=h.toNetworkElement,M="to"):h.toNetworkElement?.globalId===d.globalId&&(b=h.fromNetworkElement,M="from"),!b)continue;switch(t){case"attached":if(h.associationType!=="attachment"||M!=="to")continue;break;case"structure":if(h.associationType!=="attachment"||M!=="from")continue;break;case"container":if(h.associationType!=="containment"||M!=="from")continue;break;case"content":if(h.associationType!=="containment"||M!=="to")continue;break;case"connected":break;case"junctionedge":h.associationType==="junction-edge-to-connectivity"?E="to":h.associationType==="junction-edge-from-connectivity"&&(E="from");break;case"midspan":if(h.associationType!=="junction-edge-midspan-connectivity")continue}const Y=I.sourceIdLookup.get(b.networkSourceId)?.className??"";u.push(new Be({geometry:null,attributes:{objectId:x++,globalId:b.globalId,percentAlong:h.percentAlong??0,isContentVisible:h.isContentVisible?0:1,className:Y,side:E}}))}}const o=new Le({source:u,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new $({name:"objectId",alias:"objectId",type:"oid"}),new $({name:"globalId",alias:"globalId",type:"global-id"}),new $({name:"percentAlong",alias:"percentAlong",type:"double"}),new $({name:"side",alias:"side",type:"string"}),new $({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new $({name:"className",alias:"className",type:"string"})]});return oe(o)}function wi(i){if(i.mode==="async"){i.functions.timezone=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,1,2,t,r),Qe(e[0])||de(e[0]))return"Unknown";if(C(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?Q("unknown"):Q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof R)||e[1].hasField("type")===!1)throw new y(t,"InvalidParameter",r);const s=e[1].field("type");if(L(s)===!1)throw new y(t,"InvalidParameter",r);switch(k(s).toLowerCase()){case"preferredtimezone":return Q(e[0].preferredTimeZone);case"editfieldsinfo":return Q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return Q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&L(e[1].field("fieldname")))return Q(e[0].fieldTimeZone(k(e[1].field("fieldname"))))}throw new y(t,"InvalidParameter",r)}const n=Ye(e[0],ve(t));if(n===null)return null;const a=n.timeZone;return a==="system"?Je.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},i.functions.sqltimestamp=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{D(e,1,3,t,r);const n=e[0];if(De(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(k(e[1])).toSQLWithKeyword();throw new y(t,"InvalidParameter",r)}if(de(n))return n.toSQLWithKeyword();if(C(n)){if(e.length!==3)throw new y(t,"InvalidParameter",r);await n.load();const a=k(e[1]);if(de(e[2]))return e[2].toSQLWithKeyword();if(De(e[2])===!1)throw new y(t,"InvalidParameter",r);const s=n.fieldTimeZone(a);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,r){return i.standardFunctionAsync(t,r,(I,g,e)=>{if(D(e,2,4,t,r),ke(e[0])){const n=k(e[1]);let a=Z(e[2],null);const s=K(Z(e[3],!0));if(a===null&&(a=["*"]),j(a)===!1)throw new y(t,"InvalidParameter",r);return e[0].featureSetById(n,s,a)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"featuresetbyid",min:2,max:4});const l=new nt(["datasource","parent","root"]);i.functions.getfeatureset=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,1,2,t,r),ne(e[0])){const n=e[1]==null?"datasource":l.lookup(k(e[1]));return rt(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,r){return i.standardFunctionAsync(t,r,(I,g,e)=>{if(D(e,2,5,t,r),e[0]===null)throw new y(t,"PortalRequired",r);if(e[0]instanceof Ke){const m=k(e[1]),u=k(e[2]);let o=Z(e[3],null);const d=K(Z(e[4],!0));if(o===null&&(o=["*"]),j(o)===!1)throw new y(t,"InvalidParameter",r);let f;return f=t.services?.portal?t.services.portal:Ee.getDefault(),f=ft(e[0],f),xe(m,u,t.spatialReference,o,d,f,t.lrucache,t.interceptor)}if(L(e[0])===!1)throw new y(t,"PortalRequired",r);const n=k(e[0]),a=k(e[1]);let s=Z(e[2],null);const p=K(Z(e[3],!0));if(s===null&&(s=["*"]),j(s)===!1)throw new y(t,"InvalidParameter",r);return xe(n,a,t.spatialReference,s,p,t.services?.portal??Ee.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,r){return i.standardFunctionAsync(t,r,(I,g,e)=>{if(D(e,2,4,t,r),ke(e[0])){const n=k(e[1]);let a=Z(e[2],null);const s=K(Z(e[3],!0));if(a===null&&(a=["*"]),j(a)===!1)throw new y(t,"InvalidParameter",r);return e[0].featureSetByName(n,s,a)}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,r){return i.standardFunction(t,r,(I,g,e)=>{D(e,1,1,t,r);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(L(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(n.layerDefinition=a.layerDefinition,n.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(n.featureSet.features=a.features,n.featureSet.geometryType=a.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=a.objectIdFieldName??"",n.layerDefinition.typeIdField=a.typeIdFieldName,n.layerDefinition.globalIdField=a.globalIdFieldName,n.layerDefinition.fields=a.fields,a.spatialReference&&(n.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof R))throw new y(t,"InvalidParameter",r);{const a=JSON.parse(e[0].castToText(!0)),s=c(a,"layerdefinition");if(s!==null){n.layerDefinition.geometryType=c(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=c(s,"globalidfield",""),n.layerDefinition.objectIdField=c(s,"objectidfield",""),n.layerDefinition.typeIdField=c(s,"typeidfield",""),n.layerDefinition.hasZ=c(s,"hasz",!1)===!0,n.layerDefinition.hasM=c(s,"hasm",!1)===!0;const p=c(s,"spatialreference");p&&(n.layerDefinition.spatialReference=we(p));const m=[];for(const o of c(s,"fields",[])){const d={name:c(o,"name",""),alias:c(o,"alias",""),type:c(o,"type",""),nullable:c(o,"nullable",!0),editable:c(o,"editable",!0),length:c(o,"length",null),domain:Ce(c(o,"domain"))};m.push(d)}n.layerDefinition.fields=m;const u=c(a,"featureset");if(u){const o={};for(const d of m)o[d.name.toLowerCase()]=d.name;for(const d of c(u,"features",[])){const f={},x=c(d,"attributes",{});for(const h in x)f[o[h.toLowerCase()]]=x[h];n.featureSet.features.push({attributes:f,geometry:Ue(c(d,"geometry"))})}}}else{n.layerDefinition.hasZ=c(a,"hasz",!1)===!0,n.layerDefinition.hasM=c(a,"hasm",!1)===!0,n.layerDefinition.geometryType=c(a,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=c(a,"objectidfieldname",""),n.layerDefinition.typeIdField=c(a,"typeidfieldname","");const p=c(a,"spatialreference");p&&(n.layerDefinition.spatialReference=we(p));const m=[],u=c(a,"fields",null);if(!j(u))throw new y(t,"InvalidParameter",r);for(const f of u){const x={name:c(f,"name",""),alias:c(f,"alias",""),type:c(f,"type",""),nullable:c(f,"nullable",!0),editable:c(f,"editable",!0),length:c(f,"length",null),domain:Ce(c(f,"domain"))};m.push(x)}n.layerDefinition.fields=m;const o={};for(const f of m)o[f.name.toLowerCase()]=f.name;let d=c(a,"features",null);if(j(d))for(const f of d){const x={},h=c(f,"attributes",{});for(const b in h)x[o[b.toLowerCase()]]=h[b];n.featureSet.features.push({attributes:x,geometry:Ue(c(f,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(ht(n)===!1)throw new y(t,"InvalidParameter",r);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),ot.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,2,2,t,r),j(e[0])||_(e[0])){const n=[];let a,s=e[0];if(s instanceof Xe&&(s=s.toArray()),!et(e[1]))throw new y(t,"InvalidParameter",r);a=e[1].createFunction(t);for(const p of s){const m=a(p);We(m)?await m===!0&&n.push(p):m===!0&&n.push(p)}return n}if(C(e[0])){const n=await e[0].load(),a=v.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=a.getVariables();if(s.length>0){const p={};for(const m of s)p[m]=i.evaluateIdentifier(t,{name:m});a.parameters=p}return new me({parentfeatureset:e[0],whereclause:a})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,2,2,t,r),C(e[0])){const n=new at(e[1]);return new st({parentfeatureset:e[0],orderbyclause:n})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,2,2,t,r),C(e[0]))return new lt({parentfeatureset:e[0],topnum:e[1]});if(j(e[0]))return q(e[1])>=e[0].length?e[0].slice():e[0].slice(0,q(e[1]));if(_(e[0]))return q(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,q(e[1]));throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,1,1,t,r),C(e[0])){const n=await e[0].first(I.abortSignal);if(n!==null){const a=qe.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return j(e[0])?e[0].length===0?null:e[0][0]:_(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{D(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof R){if(e[1].hasField("minsize")&&(n.minsize=q(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=K(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=q(e[1].field("maxsize"))),e[1].hasField("types")){const a=tt(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new y(t,"InvalidParameter",r)}if(ne(e[0])){const a=e[0]._layer;let s;if(C(a))s=a;else{if(a==null||!Se(a))return[];s=oe(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{D(e,2,4,t,r);const n=e[0],a=k(e[1]);let s=Z(e[2],null);const p=K(Z(e[3],!0));if(s===null&&(s=["*"]),j(s)===!1)throw new y(t,"InvalidParameter",r);if(e[0]===null)return null;if(!ne(e[0]))throw new y(t,"InvalidParameter",r);const m=n._layer;let u;if(C(m))u=m;else{if(m==null||!Se(m))return null;u=oe(m,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}u=await u.load();const o=u.relationshipMetaData().filter(b=>b.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return ut(u,o[0],n.field(u.objectIdField),u.spatialReference,s,p,t.lrucache,t.interceptor);let d=u.serviceUrl();if(!d)return null;d=d.endsWith("/")?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const f=await dt(d,u.spatialReference,s,p,t.lrucache,t.interceptor);await f.load();let x=f.relationshipMetaData();if(x=x.filter(b=>b.id===o[0].id),n.hasField(o[0].keyField)===!1||n.field(o[0].keyField)===null){const b=await u.getFeatureByObjectId(n.field(u.objectIdField),[o[0].keyField]);if(b){const E=v.create(x[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return E.parameters={id:b.attributes[o[0].keyField]},f.filter(E)}return new pt({parentfeatureset:f})}const h=v.create(x[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:n.field(o[0].keyField)},f.filter(h)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{D(e,2,3,t,r);const n=e[0],a=it(k(Z(e[1],""))),s=L(e[2])?k(e[2]):null;if(e[0]===null)return null;if(!ne(e[0]))throw new y(t,"InvalidParameter",r);let p=n._layer;if(p instanceof Le&&(p=oe(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||C(p)===!1)return null;await p.load();const m=p.serviceUrl(),u=await ct(m,t.spatialReference,!0);if(u.unVersion>=8)return await bt(p,n,a,s,u,t,r);const o=u.associations;let d=null,f=null,x=!1;if(s!==null&&s!==""&&s!==void 0){for(const T of u.terminals)T.terminalName===s&&(f=T.terminalId);f===null&&(x=!0)}const h=o.getFieldsIndex(),b=h.get("TOGLOBALID").name,E=h.get("FROMGLOBALID").name,M=h.get("TOTERMINALID").name,Y=h.get("FROMTERMINALID").name,X=h.get("FROMNETWORKSOURCEID").name,ee=h.get("TONETWORKSOURCEID").name,H=h.get("ASSOCIATIONTYPE").name,Ze=h.get("ISCONTENTVISIBLE").name,Pe=h.get("OBJECTID").name;for(const T of p.fields)if(T.type==="global-id"){d=n.field(T.name);break}let G=null,Ie=new W(new $({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new W(new $({name:"side",alias:"side",type:"string"}),v.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const U="globalid",he="globalId",be={};for(const T in u.lkp)be[T]=u.lkp[T].sourceId;const V=new mt(new $({name:"classname",alias:"classname",type:"string"}),null,be);let N="";switch(a){case"midspan":{N=`((${b}='${d}') OR ( ${E}='${d}')) AND (${H} IN (5))`,V.codefield=v.create(`CASE WHEN (${b}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const T=ce(P.findField(o.fields,E));T.name=U,T.alias=U,G=new W(T,v.create(`CASE WHEN (${E}='${d}') THEN ${b} ELSE ${E} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=u.unVersion>=4?new fe(P.findField(o.fields,h.get("PERCENTALONG").name)):new W(new $({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{N=`((${b}='${d}') OR ( ${E}='${d}')) AND (${H} IN (4,6))`,V.codefield=v.create(`CASE WHEN (${b}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const T=ce(P.findField(o.fields,E));T.name=U,T.alias=U,G=new W(T,v.create(`CASE WHEN (${E}='${d}') THEN ${b} ELSE ${E} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new W(new $({name:"side",alias:"side",type:"string"}),v.create(`CASE WHEN (${H}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let T=`${b}='@T'`,Fe=`${E}='@T'`;f!==null&&(T+=` AND ${M}=@A`,Fe+=` AND ${Y}=@A`),N="(("+T+") OR ("+Fe+"))",N=ie(N,"@T",d??""),T=ie(T,"@T",d??""),f!==null&&(T=ie(T,"@A",f.toString()),N=ie(N,"@A",f.toString())),V.codefield=v.create("CASE WHEN "+T+` THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const le=ce(P.findField(o.fields,E));le.name=U,le.alias=U,G=new W(le,v.create("CASE WHEN "+T+` THEN ${E} ELSE ${b} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":N=`${b}='${d}' AND ${H} = 2`,f!==null&&(N+=` AND ${M} = `+f.toString()),V.codefield=X,N="( "+N+" )",G=new re(P.findField(o.fields,E),U,U);break;case"content":N=`(${E}='${d}' AND ${H} = 2)`,f!==null&&(N+=` AND ${Y} = `+f.toString()),V.codefield=ee,N="( "+N+" )",G=new re(P.findField(o.fields,b),U,U);break;case"structure":N=`(${b}='${d}' AND ${H} = 3)`,f!==null&&(N+=` AND ${M} = `+f.toString()),V.codefield=X,N="( "+N+" )",G=new re(P.findField(o.fields,E),U,he);break;case"attached":N=`(${E}='${d}' AND ${H} = 3)`,f!==null&&(N+=` AND ${Y} = `+f.toString()),V.codefield=ee,N="( "+N+" )",G=new re(P.findField(o.fields,b),U,he);break;default:throw new y(t,"InvalidParameter",r)}return x&&(N="1 <> 1"),new P({parentfeatureset:o,adaptedFields:[new fe(P.findField(o.fields,Pe)),new fe(P.findField(o.fields,Ze)),G,ge,V,Ie],extraFilter:N?v.create(N,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,3,3,t,r),!C(e[0]))throw new y(t,"InvalidParameter",r);const n=await e[0].load(),a=[],s=[];let p=!1,m=[];if(L(e[1]))m.push(e[1]);else if(e[1]instanceof R)m.push(e[1]);else if(j(e[1]))m=e[1];else{if(!_(e[1]))throw new y(t,"InvalidParameter",r);m=e[1].toArray()}for(const u of m)if(L(u)){const o=v.create(k(u),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=Ae(o)===!0?k(u):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(u instanceof R))throw new y(t,"InvalidParameter",r);{const o=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",d=u.hasField("expression")?u.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new y(t,"InvalidParameter",r);a.push({name:o,expression:v.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(m=[],L(e[2]))m.push(e[2]);else if(j(e[2]))m=e[2];else if(_(e[2]))m=e[2].toArray();else{if(!(e[2]instanceof R))throw new y(t,"InvalidParameter",r);m.push(e[2])}for(const u of m){if(!(u instanceof R))throw new y(t,"InvalidParameter",r);{const o=u.hasField("name")?u.field("name"):"",d=u.hasField("statistic")?u.field("statistic"):"",f=u.hasField("expression")?u.field("expression"):"";if(!(o&&d&&L(d)&&f))throw new y(t,"InvalidParameter",r);s.push({name:o,statistic:d,expression:v.create(f,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const u={};for(const d of n.fields)u[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);for(const d of s)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;u["field_"+o.toString()]===1;)o++;u["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const u of a)pe(u.expression,i,t);for(const u of s)pe(u.expression,i,t);return e[0].groupby(a,s)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(C(e[0])){D(e,2,2,t,r);const n=await e[0].load(),a=[];let s=[];if(L(e[1]))s.push(e[1]);else if(e[1]instanceof R)s.push(e[1]);else if(j(e[1]))s=e[1];else{if(!_(e[1]))throw new y(t,"InvalidParameter",r);s=e[1].toArray()}let p=!1;for(const m of s)if(L(m)){const u=v.create(k(m),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=Ae(u)===!0?k(m):"%%%%FIELDNAME";a.push({name:o,expression:u}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(m instanceof R))throw new y(t,"InvalidParameter",r);{const u=m.hasField("name")?m.field("name"):"%%%%FIELDNAME",o=m.hasField("expression")?m.field("expression"):"";if(u==="%%%%FIELDNAME"&&(p=!0),!u)throw new y(t,"InvalidParameter",r);a.push({name:u,expression:v.create(o||u,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const m={};for(const o of n.fields)m[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(m[o.name.toLowerCase()]=1);let u=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;m["field_"+u.toString()]===1;)u++;m["field_"+u.toString()]=1,o.name="FIELD_"+u.toString()}}for(const m of a)pe(m.expression,i,t);return e[0].groupby(a,[])}return It(e)})},i.functions.getfeaturesetinfo=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,1,1,t,r),!C(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?R.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},ve(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,r){return i.standardFunctionAsync(t,r,async(I,g,e)=>{if(D(e,2,2,t,r),C(e[0])){const n=await e[0].load(),a=e[1];if(!_e(a))throw new y(t,"InvalidParameter",r);if(n.subtypeField){const p=v.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new me({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new y(t,"FeatureSetDoesNotHaveSubtypes",r);const s=v.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new me({parentfeatureset:e[0],whereclause:s})}throw new y(t,"InvalidParameter",r)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{wi as registerFunctions};
