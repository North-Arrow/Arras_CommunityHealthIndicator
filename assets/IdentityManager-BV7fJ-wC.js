const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/uuid-Cl_eusAm.js","assets/MapPage-B4quncaN.js","assets/index-BmYviIWw.js","assets/index-DydP-41E.css","assets/themeLevelStore-DZpgk8s7.js","assets/MapPage-KTQQIo0K.css","assets/index-DgleMY_-.js","assets/index-jXbTGo3b.js"])))=>i.map(i=>d[i]);
import{i7 as ft,bL as ge,dU as _t,bl as Z,i8 as gt,hQ as mt,i4 as xe,fH as vt,bj as me,fl as Fe,gN as yt,d$ as wt,i9 as St,ia as It,U as Pe,hb as $e,V as Oe,ib as kt,bk as At,fK as ze,en as Ut,g as bt,ic as Tt,hu as K,_ as f,z as _,dc as xt,A as V,id as Pt,ie as $t,H as O,B as We,ig as Ot,I as ne,eu as Je,$ as B,v as j,s as A,eC as Rt,b_ as R,ej as C,ih as H,ii as ae,db as Re,ij as Ct,gc as Ce,Z as le,a3 as Nt,hG as Dt,t as F,bM as Et,a as z,ik as jt}from"./MapPage-B4quncaN.js";import{_ as L}from"./index-BmYviIWw.js";import{n as Lt}from"./uuid-Cl_eusAm.js";import{t as Ge}from"./sanitizerUtils-DvKU1K2H.js";import"./themeLevelStore-DZpgk8s7.js";function qt(s){return typeof s=="string"?document.getElementById(s):s??null}const Ke="http://www.w3.org/",se=`${Ke}2000/svg`,Ye=`${Ke}1999/xlink`;let Ne=[],Ue=(s,e)=>{let r={};return Object.keys(s).forEach(t=>{r[t]=s[t]}),e&&Object.keys(e).forEach(t=>{r[t]=e[t]}),r},be=(s,e)=>s.vnodeSelector===e.vnodeSelector&&(s.properties&&e.properties?s.properties.key===e.properties.key&&s.properties.bind===e.properties.bind:!s.properties&&!e.properties),Qe=s=>{if(typeof s!="string")throw new Error("Style values must be strings")},Vt=(s,e,r)=>{if(e.vnodeSelector!==""){for(let t=r;t<s.length;t++)if(be(s[t],e))return t}return-1},he=(s,e,r,t)=>{let i=s[e];if(i.vnodeSelector==="")return;let o=i.properties;if(!(o&&(o.key===void 0?o.bind:o.key))){for(let a=0;a<s.length;a++)if(a!==e){let h=s[a];if(be(h,i))throw new Error(`${r.vnodeSelector} had a ${i.vnodeSelector} child ${t==="added"?t:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},Mt=s=>{if(s.properties){let e=s.properties.enterAnimation;e&&e(s.domNode,s.properties)}},ve=[],ye=!1,Xe=s=>{(s.children||[]).forEach(Xe),s.properties&&s.properties.afterRemoved&&s.properties.afterRemoved.apply(s.properties.bind||s.properties,[s.domNode])},De=()=>{ye=!1,ve.forEach(Xe),ve.length=0},Ee=s=>{ve.push(s),ye||(ye=!0,typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback(De,{timeout:16}):setTimeout(De,16))},je=s=>{let e=s.domNode;if(s.properties){let r=s.properties.exitAnimation;if(r)return e.style.pointerEvents="none",void r(e,()=>{e.parentNode&&(e.parentNode.removeChild(e),Ee(s))},s.properties)}e.parentNode&&(e.parentNode.removeChild(e),Ee(s))},Bt=(s,e,r)=>{if(!e)return;let t=r.eventHandlerInterceptor,i=Object.keys(e),o=i.length;for(let a=0;a<o;a++){let h=i[a],l=e[h];if(h==="className")throw new Error('Property "className" is not supported, use "class".');if(h==="class")Se(s,l,!0);else if(h==="classes"){let n=Object.keys(l),u=n.length;for(let c=0;c<u;c++){let d=n[c];l[d]&&s.classList.add(d)}}else if(h==="styles"){let n=Object.keys(l),u=n.length;for(let c=0;c<u;c++){let d=n[c],p=l[d];p&&(Qe(p),r.styleApplyer(s,d,p))}}else if(h!=="key"&&l!=null){let n=typeof l;n==="function"?(h.lastIndexOf("on",0)===0&&(t&&(l=t(h,l,s,e)),h==="oninput"&&(function(){let u=l;l=function(c){u.apply(this,[c]),c.target["oninput-value"]=c.target.value}})()),s[h]=l):r.namespace===se?h==="href"?s.setAttributeNS(Ye,h,l):s.setAttribute(h,l):n==="string"&&h!=="value"?h==="innerHTML"?s[h]=Ge.sanitize(l):we(s)&&h in s?s[h]=l:s.setAttribute(h,l):s[h]=l}}};function we(s){if(!(s instanceof Element&&s.tagName.includes("-")))return!1;const e=window.customElements.get(s.tagName.toLowerCase());return!!e&&s instanceof e}let ee,Ht=(s,e,r)=>{if(e)for(let t of e)q(t,s,void 0,r)},Ze=(s,e,r)=>{Ht(s,e.children,r),e.text&&(s.textContent=e.text),Bt(s,e.properties,r),e.properties&&e.properties.afterCreate&&e.properties.afterCreate.apply(e.properties.bind||e.properties,[s,r,e.vnodeSelector,e.properties,e.children])},q=(s,e,r,t)=>{let i,o=0,a=s.vnodeSelector,h=e.ownerDocument;if(a==="")i=s.domNode=h.createTextNode(s.text),r!==void 0?e.insertBefore(i,r):e.appendChild(i);else{for(let l=0;l<=a.length;++l){let n=a.charAt(l);if(l===a.length||n==="."||n==="#"){let u=a.charAt(o-1),c=a.slice(o,l);u==="."?i.classList.add(c):u==="#"?i.id=c:(c==="svg"&&(t=Ue(t,{namespace:se})),t.namespace!==void 0?i=s.domNode=h.createElementNS(t.namespace,c):(i=s.domNode=s.domNode||h.createElement(c),c==="input"&&s.properties&&s.properties.type!==void 0&&i.setAttribute("type",s.properties.type)),r!==void 0?e.insertBefore(i,r):i.parentNode!==e&&e.appendChild(i)),o=l+1}}Ze(i,s,t)}},Se=(s,e,r)=>{e&&e.split(" ").forEach(t=>{t&&s.classList.toggle(t,r)})},Ft=(s,e,r,t)=>{if(!r)return;let i=!1,o=Object.keys(r),a=o.length;for(let h=0;h<a;h++){let l=o[h],n=r[l],u=e[l];if(l==="class")u!==n&&(Se(s,u,!1),Se(s,n,!0));else if(l==="classes"){let c=s.classList,d=Object.keys(n),p=d.length;for(let g=0;g<p;g++){let m=d[g],y=!!n[m];y!==!!u[m]&&(i=!0,y?c.add(m):c.remove(m))}}else if(l==="styles"){let c=Object.keys(n),d=c.length;for(let p=0;p<d;p++){let g=c[p],m=n[g];m!==u[g]&&(i=!0,m?(Qe(m),t.styleApplyer(s,g,m)):t.styleApplyer(s,g,""))}}else if(n||typeof u!="string"||(n=""),l!=="value"||we(s)){if(n!==u){let c=typeof n;c==="function"&&t.eventHandlerInterceptor||(t.namespace===se?l==="href"?s.setAttributeNS(Ye,l,n):s.setAttribute(l,n):c==="string"?l==="innerHTML"?s[l]=Ge.sanitize(n):l==="role"&&n===""?s.removeAttribute(l):we(s)&&l in s?s[l]=n:s.setAttribute(l,n):s[l]!==n&&(s[l]=n),i=!0)}}else{let c=s[l];c!==n&&(s["oninput-value"]?c===s["oninput-value"]:n!==u)&&(s[l]=n,s["oninput-value"]=void 0),n!==u&&(i=!0)}}return i},zt=(s,e,r,t,i)=>{if(r===t)return!1;t=t||Ne;let o,a=(r=r||Ne).length,h=t.length,l=0,n=0,u=!1;for(;n<h;){let c=l<a?r[l]:void 0,d=t[n];if(c!==void 0&&be(c,d))u=ee(c,d,i)||u,l++;else{let p=Vt(r,d,l+1);if(p>=0){for(o=l;o<p;o++)je(r[o]),he(r,o,s,"removed");u=ee(r[p],d,i)||u,l=p+1}else q(d,e,l<a?r[l].domNode:void 0,i),Mt(d),he(t,n,s,"added")}n++}if(a>l)for(o=l;o<a;o++)je(r[o]),he(r,o,s,"removed");return u};ee=(s,e,r)=>{let t=s.domNode,i=!1;if(s===e)return!1;let o=!1;if(e.vnodeSelector===""){if(e.text!==s.text){let a=t.ownerDocument.createTextNode(e.text);return t.parentNode.replaceChild(a,t),e.domNode=a,i=!0,i}e.domNode=t}else e.vnodeSelector.lastIndexOf("svg",0)===0&&(r=Ue(r,{namespace:se})),s.text!==e.text&&(o=!0,e.text===void 0?t.removeChild(t.firstChild):t.textContent=e.text),e.domNode=t,o=zt(e,t,s.children,e.children,r)||o,o=Ft(t,s.properties,e.properties,r)||o,e.properties&&e.properties.afterUpdate&&e.properties.afterUpdate.apply(e.properties.bind||e.properties,[t,r,e.vnodeSelector,e.properties,e.children]);return o&&e.properties&&e.properties.updateAnimation&&e.properties.updateAnimation(t,e.properties,s.properties),i};let W=(s,e)=>({getLastRender:()=>s,update:r=>{if(s.vnodeSelector!==r.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let t=s;s=r,ee(t,r,e)},domNode:s.domNode});const Wt={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(s,e,r)=>{e.charAt(0)==="-"?s.style.setProperty(e,r):s.style[e]=r}};let J=s=>Ue(Wt,s),G={append:(s,e,r)=>(r=J(r),q(e,s,void 0,r),W(e,r)),insertBefore:(s,e,r)=>(r=J(r),q(e,s.parentNode,s,r),W(e,r)),merge:(s,e,r)=>(r=J(r),e.domNode=s,Ze(s,e,r),W(e,r)),replace:(s,e,r)=>(r=J(r),q(e,s.parentNode,s,r),s.parentNode.removeChild(s),W(e,r))};const Jt={handleInterceptedEvent:(s,e,r,t)=>(s.scheduleRender(),e.properties[`on${t.type}`].apply(e.properties.bind||r,[t]))},Gt={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(s,e,r)=>{e.startsWith("-")?s.style.setProperty(e,r):s.style[e]=r}},Kt=s=>({...Gt,...s}),Yt=(s,e)=>{const r=[];for(;s&&s!==e;)r.push(s),s=s.parentNode;return r},Qt=(s,e)=>s.find(e),Le=(s,e,r=!1)=>{let t=s;return e.forEach((i,o)=>{const a=t?.children?Qt(t.children,h=>h.domNode===i):void 0;r&&!a&&o!==e.length-1||(t=a)}),t},Xt=s=>{let e;const r={...Jt,...s},t=Kt(r),i=t.performanceLogger;let o,a=!0,h=!1;const l=[],n=[],u=(d,p,g)=>{let m;t.eventHandlerInterceptor=(k,v,S,w)=>function(P){let M;i("domEvent",P);const oe=Yt(P.currentTarget,m.domNode),ut=oe.some(E=>customElements.get(E?.tagName?.toLowerCase()));if(P.eventPhase===Event.CAPTURING_PHASE||!ut)oe.reverse(),M=Le(m.getLastRender(),oe);else{const E=P.composedPath(),pt=E.slice(E.indexOf(P.currentTarget),E.indexOf(m.domNode)).reverse();M=Le(m.getLastRender(),pt,!0)}let Te;return M&&(Te=r.handleInterceptedEvent(e,M,this,P)),i("domEventProcessed",P),Te},r.postProcessProjectionOptions?.(t);const y=g();m=d(p,y,t),t.eventHandlerInterceptor=void 0,l.push(m),n.push(g),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(m,y)};let c=()=>{if(o=void 0,a){a=!1,i("renderStart",void 0);for(let d=0;d<l.length;d++){const p=n[d]();i("rendered",void 0);try{l[d].update(p)}catch(g){console.error(g)}i("patched",void 0)}i("renderDone",void 0),a=!0}};return r.modifyDoRenderImplementation&&(c=r.modifyDoRenderImplementation(c,l,n)),e={renderNow:c,scheduleRender:()=>{o||h||(o=requestAnimationFrame(c))},stop:()=>{o&&(cancelAnimationFrame(o),o=void 0),h=!0},resume:()=>{h=!1,a=!0,e.scheduleRender()},append:(d,p)=>{u(G.append,d,p)},insertBefore:(d,p)=>{u(G.insertBefore,d,p)},merge:(d,p)=>{u(G.merge,d,p)},replace:(d,p)=>{u(G.replace,d,p)},detach:d=>{for(let p=0;p<n.length;p++)if(n[p]===d)return n.splice(p,1),l.splice(p,1)[0];throw new Error("renderFunction was not found")}},e};/*! All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://github.com/Esri/calcite-design-system/blob/dev/LICENSE.md for details.
v3.3.3 */let et=!1;const Zt=s=>{et=!0,ft(s)};let tt;function er(){et||Zt(ge(_t(tt)))}function tr(s){const e=[];for(const r of Object.keys(s))customElements.get(`calcite-${r}`)||e.push(s[r]?.());return e.length>0?Promise.all(e):null}tt="components/assets";const rt=Symbol("widget"),st=Symbol("widget-test-data"),rr=[],sr={},te=new WeakMap;function it(s,e){let r=e.children;if(r?.length)for(let i=0;i<r.length;++i)r[i]=it(s,r[i]);else r=rr;const t=e.vnodeSelector;if(re(t)){const i=e.properties||sr,o=i.key||t,a={key:o,afterCreate:ir,afterUpdate:or,afterRemoved:ot,parentWidget:s,widgetConstructor:t,widgetProperties:{...i,key:o,children:r}};return{vnodeSelector:t.vnodeSelector,properties:a,children:void 0,text:void 0,domNode:null}}return e}function ir(s,e,r,{parentWidget:t,widgetConstructor:i,widgetProperties:o}){const a=new i(o);a.container=s,te.set(s,a),a.afterCreate?.(a,s),t.addHandles(Z(()=>ot(s))),queueMicrotask(()=>{a[st].projector?.renderNow()})}function or(s,e,r,{widgetProperties:t}){const i=te.get(s);i&&(i.set(t),i.afterUpdate?.(i,s))}function ot(s){const e=te.get(s);e&&(e.afterRemoved?.(e,s),e.destroy(),te.delete(s))}function re(s){return typeof s=="function"&&s[rt]}const qe=new Set;function nr(s){qe.add(s),s.finally(()=>qe.delete(s))}function ar(s){return Z()}const ie=new Map;function nt(){ie.clear()}function lr(s){return ie.get(s)}function hr(s,e){ie.set(s,e)}function de(s){ie.delete(s)}function dr(...s){const e=xe.acquire();for(let t=0;t<s.length;t++){const i=s[t],o=typeof i;if(o==="string")e.push(i);else if(Array.isArray(i))e.push.apply(e,i);else if(o==="object")for(const a in i)i[a]&&e.push(a)}const r=e.join(" ");return xe.release(e),r}(()=>{const s=new Map,e=new ResizeObserver(t=>{nt();for(const i of t)s.get(i.target)?.(i)}),r=(t,i,o)=>(s.set(t,i),e.observe(t,o),Z(()=>{e.unobserve(t),s.delete(t)}));return(t,i,o)=>{let a=null;return vt([me(()=>typeof t=="function"?t():t,h=>{a?.remove(),h&&(a=r(h,i,o))},Fe),Z(()=>a?.remove())])}})();async function cr(s,e){await gt(mt(e));const r=typeof s=="function"?s():s;r&&("setFocus"in r&&typeof r.setFocus=="function"?await r.setFocus():r instanceof HTMLElement&&r.focus())}var Ve;let ur=0;function at(s,e){const r=Object.prototype.hasOwnProperty;for(const t in e)r.call(e,t)&&r.call(s,t)&&(s[t]!=null&&e[t]!=null&&typeof s[t]=="object"&&typeof e[t]=="object"?at(s[t],e[t]):s[t]=e[t]);return s}const pr=Xt({postProcessProjectionOptions(s){const e=s.eventHandlerInterceptor,r=/capture$/i;s.eventHandlerInterceptor=(t,i,o,a)=>{const h=e?.(t,i,o,a),l=r.test(t);if(!((t=t.replace(r,"")).toLowerCase()in o)||l){const n=t[2].toLowerCase()+t.slice(3),u=p=>h?.call(o,p);o.addEventListener(n,u,l);const c=()=>o.removeEventListener(n,u,l),d=a.afterRemoved;a.afterRemoved=p=>{d?.(p),c()}}return h}},handleInterceptedEvent(s,e,r,t){const{eventPhase:i,type:o}=t,a=i===Event.CAPTURING_PHASE;let h=`on${o}${a?"capture":""}`;const l=e.properties;(l&&h in l||(h=`on${o[0].toUpperCase()}${o.slice(1)}${a?"Capture":""}`,l&&h in l))&&(nt(),s.scheduleRender(),l[h].call(l.bind||r,t))}});let ce=!1;var N;let U=(N=class extends yt(ze){constructor(e,r){super(e,r),this._attached=!1,this._projector=pr,this._readyForTrueRender=!1,this.key=this,this.autoRenderingEnabled=!0,this._loadLocale=wt(async()=>{if(this._messageBundleProps?.length){const l=await Promise.allSettled(this._messageBundleProps.map(async({bundlePath:n,propertyName:u})=>{if(this.destroyed)return;let c=await Ut(n);this.destroyed||(this.uiStrings&&Object.keys(this.uiStrings)&&(c=at(bt(c),this.uiStrings)),this[u]=c)}));if(this.destroyed)return;for(const n of l)n.status==="rejected"&&Pe.getLogger(this).error("widget-intl:locale-error",this.declaredClass,n.reason)}await this.loadLocale()}),this.addHandles(ar()),er();const t="esri-widget-uid-"+Lt(),i=this.render.bind(this);this._trackingTarget=new St(()=>{this.autoRenderingEnabled&&this.scheduleRender()});const o=()=>({vnodeSelector:"div",properties:{key:`${t}-hidden`,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0}),a=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const l=i()??o(),n=l.properties??={};if(n.key??=t,re(l.vnodeSelector)){if(!this.visible)return o()}else this.visible?n.styles||(n.styles={}):(n.class="",n.styles={display:"none"}),n.styles.display??="";let u=0;return l.children?.forEach(c=>{re(c.vnodeSelector)||(c.properties??={},c.properties.key??=`${this.id}--${u++}`)}),it(this,l)};this.render=()=>{if(ce)return a();let l=lr(this)??null;if(l)return l;this._trackingTarget.clear(),ce=!0;try{l=It(this._trackingTarget,a)}catch(n){throw Pe.getLogger(this).error(n),n}finally{ce=!1}return l&&hr(this,l),l};const h=this.beforeFirstRender();h?this._resourcesFetch=h.then(()=>{this.destroyed||(this._readyForTrueRender=!0,this._postInitialize())}):(this._resourcesFetch=Promise.resolve().then(()=>{this.destroyed||this._postInitialize()}),this._readyForTrueRender=!0),this.addResolvingPromise(this._resourcesFetch),nr(this._resourcesFetch)}normalizeCtorArgs(e,r){const t={...e};return r&&(t.container=r),t}postInitialize(){}beforeFirstRender(){const e=this.loadDependencies();return this._messageBundleProps?.length||e?Promise.all([e,this._loadLocale()]).then(()=>{}).catch($e):null}loadDependencies(){return null}loadLocale(){return null}destroy(){this.destroyed||(Oe(this._trackingTarget),Oe(this.viewModel),this._detach(this.container),this._set("container",null),this.render=()=>null,this._projector=null,de(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return qt(e)}get destroyed(){return super.destroyed}get domNode(){return this.container}set domNode(e){this.container=e}get icon(){return null}set icon(e){this._overrideIfSome("icon",e)}get id(){return this._get("id")||this.container?.id||Date.now().toString(16)+"-widget-"+ur++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(Ve=rt,st)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(de(this),this._projector.scheduleRender())}classes(...e){return dr.apply(this,e)}renderNow(){de(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this.addHandles(me(()=>this.viewModel,(r,t)=>{t&&this.removeHandles("delegated-events"),r&&Tt(r)&&this.addHandles(this._delegatedEventNames.map(i=>K(r,i,o=>{this.emit(i,o)})),"delegated-events")},Fe)),this.postInitialize();const e=async()=>{await this._loadLocale().catch($e),this.scheduleRender()};this.addHandles([kt(e),me(()=>this.uiStrings,e)]),this.addHandles(At(()=>this.container,r=>{this.destroyed||this._attach(r)},{initial:!0,once:!0}))}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}},N[Ve]=!0,N.vnodeSelector="div",N);f([_()],U.prototype,"_readyForTrueRender",void 0),f([_({value:null})],U.prototype,"container",null),f([xt("container")],U.prototype,"castContainer",null),f([_()],U.prototype,"icon",null),f([_()],U.prototype,"id",null),f([_()],U.prototype,"label",null),f([_()],U.prototype,"renderable",null),f([_()],U.prototype,"uiStrings",void 0),f([_()],U.prototype,"viewModel",void 0),f([_({value:!0})],U.prototype,"visible",null),f([_()],U.prototype,"key",void 0),f([_()],U.prototype,"children",void 0),f([_()],U.prototype,"afterCreate",void 0),f([_()],U.prototype,"afterUpdate",void 0),f([_()],U.prototype,"afterRemoved",void 0),U=f([V("esri.widgets.Widget")],U);const fr=U;function Me(s){return(e,r)=>{e.hasOwnProperty("_messageBundleProps")||(e._messageBundleProps=e._messageBundleProps?e._messageBundleProps.slice():[]),e._messageBundleProps.push({bundlePath:s,propertyName:r})}}var _r=function(s){return{vnodeSelector:"",properties:void 0,children:void 0,text:s.toString(),domNode:null}},lt=function(s,e){for(var r=0,t=s.length;r<t;r++){var i=s[r];Array.isArray(i)?lt(i,e):i!=null&&i!==!1&&(i.hasOwnProperty("vnodeSelector")||(i=_r(i)),e.push(i))}},gr=function(s,e){for(var r=[],t=2;t<arguments.length;t++)r[t-2]=arguments[t];if(r.length===1&&typeof r[0]=="string")return{vnodeSelector:s,properties:e||void 0,children:void 0,text:r[0],domNode:null};var i=[];return lt(r,i),{vnodeSelector:s,properties:e||void 0,children:i,text:void 0,domNode:null}};function $(s,e,...r){return typeof s!="function"||re(s)?gr(s,e??null,...r):s(e,...r)}const mr="--esri-calcite-mode-name";function vr(){const s=getComputedStyle(document.body).getPropertyValue(mr).replaceAll(/\W/g,"").toLowerCase();return s==="dark"||s==="light"?s:void 0}const yr="calcite-mode-";function wr(s){return vr()??Pt(s??document.body)}function Sr(s){return`${yr}${wr(s)}`}const ue="esri-identity-modal",pe={base:ue,info:`${ue}__info`,notice:`${ue}__notice`},Ir="ArcGIS Online";let T=class extends fr{constructor(s,e){super(s,e),this.container=document.createElement("div"),this.error=null,this.oAuthPrompt=!1,this.open=!1,this.signingIn=!1,this.server=null,this.resource=null,this._usernameInputNode=null,this._passwordInputNode=null,document.body.appendChild(this.container)}loadDependencies(){return tr({button:()=>L(()=>import("./uuid-Cl_eusAm.js").then(s=>s.a),__vite__mapDeps([0,1,2,3,4,5])),dialog:()=>L(()=>import("./index-DgleMY_-.js"),__vite__mapDeps([6,1,2,3,4,5])),input:()=>L(()=>import("./uuid-Cl_eusAm.js").then(s=>s.i),__vite__mapDeps([0,1,2,3,4,5])),label:()=>L(()=>import("./index-jXbTGo3b.js"),__vite__mapDeps([7,1,2,3,4,5])),notice:()=>L(()=>import("./uuid-Cl_eusAm.js").then(s=>s.b),__vite__mapDeps([0,1,2,3,4,5]))})}get title(){return this.commonMessages?.auth.signIn}render(){const{open:s,title:e,messages:r,signingIn:t,oAuthPrompt:i,server:o,resource:a,error:h}=this,{info:l,oAuthInfo:n,lblItem:u,invalidUser:c,noAuthService:d,lblUser:p,lblPwd:g,lblCancel:m,lblSigning:y,lblOk:k}=r;return $("div",{class:this.classes(pe.base,Sr(this.container))},$("form",{bind:this,onsubmit:this._submit},$("calcite-dialog",{bind:this,heading:e,modal:!0,open:s,outsideCloseDisabled:!0,scale:"s",widthScale:"s",onCalciteDialogClose:this._cancel,onCalciteDialogOpen:this._focusUsernameInput},$("div",{class:pe.info},$t(i?n:l,{server:o&&/\.arcgis\.com/i.test(o)?Ir:o,resource:`(${a||u})`})),h?$("calcite-notice",{class:pe.notice,icon:"exclamation-mark-triangle",kind:"danger",open:!0},$("div",{slot:"message"},h.details?.httpStatus?c:d)):null,i?null:[$("calcite-label",null,p,$("calcite-input",{afterCreate:v=>this._usernameInputNode=v,autocomplete:"off",bind:this,name:"username",required:!0,spellcheck:!1,type:"text",value:""})),$("calcite-label",null,g,$("calcite-input",{afterCreate:v=>this._passwordInputNode=v,bind:this,name:"password",required:!0,type:"password",value:""}))],$("calcite-button",{appearance:"outline",bind:this,onclick:this._cancel,slot:"footer-end",type:"button"},m),$("calcite-button",{loading:!!t,slot:"footer-end",type:"submit"},t?y:k))))}_focusUsernameInput(){return cr(()=>this._usernameInputNode)}_cancel(){this._set("signingIn",!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(s){s.preventDefault(),this._set("signingIn",!0);const e=this.oAuthPrompt?{}:{username:this._usernameInputNode?.value,password:this._passwordInputNode?.value};this.emit("submit",e)}};f([_({readOnly:!0})],T.prototype,"container",void 0),f([_(),Me("esri/t9n/common")],T.prototype,"commonMessages",void 0),f([_()],T.prototype,"error",void 0),f([_(),Me("esri/identity/t9n/identity")],T.prototype,"messages",void 0),f([_()],T.prototype,"oAuthPrompt",void 0),f([_()],T.prototype,"open",void 0),f([_()],T.prototype,"signingIn",void 0),f([_()],T.prototype,"server",void 0),f([_({readOnly:!0})],T.prototype,"title",null),f([_()],T.prototype,"resource",void 0),T=f([V("esri.identity.IdentityModal")],T);const Be=T,fe="esriJSAPIOAuth";let Ie=class{constructor(e,r){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=e,this.storage=r,this._init()}isValid(){let e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token)){if(this.expires==null&&this.refreshToken)e=!0;else if(this.expires){const r=Date.now();this.expires>r&&(this.expires-r)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}}return e}save(){if(!this.storage)return!1;const e=this._load(),r=this.oAuthInfo;if(r?.authNamespace&&r.portalUrl){let t=e[r.authNamespace];t||(t=e[r.authNamespace]={}),this.appId||(this.appId=r.appId),t[r.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(fe,JSON.stringify(e))}catch(i){return console.warn(i),!1}return!0}return!1}destroy(){const e=this._load(),r=this.oAuthInfo;if(r?.appId&&r?.portalUrl&&(this.expires==null||this.expires>Date.now())&&(this.refreshToken||this.token)){const t=r.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken";O(t,{authMode:"anonymous",keepAlive:!0,method:"post",query:{f:"json",auth_token:this.refreshToken||this.token,client_id:r.appId,token_type_hint:this.refreshToken?"refresh_token":"access_token"}})}if(r?.authNamespace&&r.portalUrl&&this.storage){const t=e[r.authNamespace];if(t){delete t[r.portalUrl];try{this.storage.setItem(fe,JSON.stringify(e))}catch(i){console.log(i)}}}r&&(r._oAuthCred=null,this.oAuthInfo=null)}_init(){const e=this._load(),r=this.oAuthInfo;if(r?.authNamespace&&r.portalUrl){let t=e[r.authNamespace];t&&(t=t[r.portalUrl],t&&(this.appId=t.appId,this.codeVerifier=t.codeVerifier,this.expires=t.expires,this.refreshToken=t.refreshToken,this.ssl=t.ssl,this.stateUID=t.stateUID,this.token=t.token,this.userId=t.userId))}}_load(){let e={};if(this.storage){const r=this.storage.getItem(fe);if(r)try{e=JSON.parse(r)}catch(t){console.warn(t)}}return e}};Ie.prototype.declaredClass="esri.identity.OAuthCredential";var ke,D;let b=(D=class extends We{constructor(e){super(e),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.flowType="auto",this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return ke.fromJSON(this.toJSON())}},ke=D,D);f([_({json:{write:!0}})],b.prototype,"appId",void 0),f([_({json:{write:!0}})],b.prototype,"authNamespace",void 0),f([_({json:{write:!0}})],b.prototype,"expiration",void 0),f([_({json:{write:!0}})],b.prototype,"flowType",void 0),f([_({json:{write:!0}})],b.prototype,"forceLogin",void 0),f([_({json:{write:!0}})],b.prototype,"forceUserId",void 0),f([_({json:{write:!0}})],b.prototype,"locale",void 0),f([_({json:{write:!0}})],b.prototype,"minTimeUntilExpiration",void 0),f([_({json:{write:!0}})],b.prototype,"popup",void 0),f([_({json:{write:!0}})],b.prototype,"popupCallbackUrl",void 0),f([_({json:{write:!0}})],b.prototype,"popupWindowFeatures",void 0),f([_({json:{write:!0}})],b.prototype,"portalUrl",void 0),f([_({json:{write:!0}})],b.prototype,"preserveUrlHash",void 0),f([_({json:{write:!0}})],b.prototype,"userId",void 0),b=ke=f([V("esri.identity.OAuthInfo")],b);const He=b;let x=class extends We{constructor(s){super(s),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};f([_({json:{write:!0}})],x.prototype,"adminTokenServiceUrl",void 0),f([_({json:{write:!0}})],x.prototype,"currentVersion",void 0),f([_({json:{write:!0}})],x.prototype,"hasPortal",void 0),f([_({json:{write:!0}})],x.prototype,"hasServer",void 0),f([_({json:{write:!0}})],x.prototype,"owningSystemUrl",void 0),f([_({json:{write:!0}})],x.prototype,"owningTenant",void 0),f([_({json:{write:!0}})],x.prototype,"server",void 0),f([_({json:{write:!0}})],x.prototype,"shortLivedTokenValidity",void 0),f([_({json:{write:!0}})],x.prototype,"tokenServiceUrl",void 0),f([_({json:{write:!0}})],x.prototype,"webTierAuth",void 0),x=f([V("esri.identity.ServerInfo")],x);const _e=x,Y={},ht=s=>{const e=new C(s.owningSystemUrl).host,r=new C(s.server).host,t=/.+\.arcgis\.com$/i;return t.test(e)&&t.test(r)},Ae=(s,e)=>!!(ht(s)&&e&&e.some(r=>r.test(s.server)));let Q=null,X=null;try{Q=window.localStorage,X=window.sessionStorage}catch{}class dt extends Ot{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin=window.origin!=="null"?window.origin:window.location.origin,this._appUrlObj=ne(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^/]+\/[^/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^/]+).*/i,this._gwItem=/http.+\/items\/([^/]+).*/i,this._gwGroup=/http.+\/groups\/([^/]+).*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getPlatformSelfError=null,this._getOAuthLocationParams(),window.addEventListener("pageshow",e=>{this._pageShowHandler(e)})}registerServers(e){const r=this.serverInfos;r?(e=e.filter(t=>!this.findServerInfo(t.server)),this.serverInfos=r.concat(e)):this.serverInfos=e,e.forEach(t=>{t.owningSystemUrl&&this._portals.push(t.owningSystemUrl),t.hasPortal&&this._portals.push(t.server)})}registerOAuthInfos(e){const r=this.oAuthInfos;if(r){for(const t of e){const i=this.findOAuthInfo(t.portalUrl);i&&r.splice(r.indexOf(i),1)}this.oAuthInfos=r.concat(e)}else this.oAuthInfos=e}registerToken(e){e={...e};const r=this._sanitizeUrl(e.server),t=this._isServerRsrc(r);let i,o=this.findServerInfo(r),a=!0;o||(o=new _e,o.server=this._getServerInstanceRoot(r),t?o.hasServer=!0:(o.tokenServiceUrl=this._getTokenSvcUrl(r),o.hasPortal=!0),this.registerServers([o])),i=this._findCredential(r),i?(delete e.server,Object.assign(i,e),a=!1):(i=new I({userId:e.userId,server:o.server??void 0,token:e.token,expires:e.expires,ssl:e.ssl,scope:t?"server":"portal"}),i.resources=[r],this.credentials.push(i)),i.emitTokenChange(!1),a||i.refreshServerTokens()}toJSON(){return Je({serverInfos:this.serverInfos.map(e=>e.toJSON()),oAuthInfos:this.oAuthInfos.map(e=>e.toJSON()),credentials:this.credentials.map(e=>e.toJSON())})}initialize(e){if(!e)return;typeof e=="string"&&(e=JSON.parse(e));const r=e.serverInfos,t=e.oAuthInfos,i=e.credentials;if(r){const o=[];r.forEach(a=>{a.server&&a.tokenServiceUrl&&o.push(a.declaredClass?a:new _e(a))}),o.length&&this.registerServers(o)}if(t){const o=[];t.forEach(a=>{a.appId&&o.push(a.declaredClass?a:new He(a))}),o.length&&this.registerOAuthInfos(o)}i&&i.forEach(o=>{o.server&&o.token&&o.expires&&o.expires>Date.now()&&((o=o.declaredClass?o:new I(o)).emitTokenChange(),this.credentials.push(o))})}findServerInfo(e){let r;e=this._sanitizeUrl(e);for(const t of this.serverInfos)if(this._hasSameServerInstance(t.server,e)){r=t;break}return r}findOAuthInfo(e){let r;e=this._sanitizeUrl(e);for(const t of this.oAuthInfos)if(this._hasSameServerInstance(t.portalUrl,e)){r=t;break}return r}findCredential(e,r){if(!e)return;let t;e=this._sanitizeUrl(e);const i=this._isServerRsrc(e)?"server":"portal";if(r){for(const o of this.credentials)if(this._hasSameServerInstance(o.server,e)&&r===o.userId&&o.scope===i){t=o;break}}else for(const o of this.credentials)if(this._hasSameServerInstance(o.server,e)&&this._getIdenticalSvcIdx(e,o)!==-1&&o.scope===i){t=o;break}return t}getCredential(e,r){let t,i=!1,o=!0;r&&(i=!(!r.token&&!r.credential),t=r.error,o=r.prompt!==!1),r={...r},e=this._sanitizeUrl(e);const a=new AbortController,h=B();if(r.signal&&j(r.signal,()=>{a.abort()}),j(a,()=>{h.reject(new A("identity-manager:user-aborted","ABORTED"))}),Rt(a))return h.promise;r.signal=a.signal;const l=this._isAdminResource(e),n=i?this.findCredential(e):null;let u;if(n&&t?.details?.httpStatus===498)n.destroy();else if(n)return u=new A("identity-manager:not-authorized","You are currently signed in as: '"+n.userId+"'. You do not have access to this resource: "+e,{error:t}),h.reject(u),h.promise;const c=this._findCredential(e,r);if(c)return h.resolve(c),h.promise;let d=this.findServerInfo(e);if(d)!d.hasPortal&&d.server&&d.owningSystemUrl&&this._hasSameServerInstance(d.server,d.owningSystemUrl)&&(d.hasPortal=!0),!d.hasServer&&this._isServerRsrc(e)&&(d._restInfoPms=this._getTokenSvcUrl(e),d.hasServer=!0);else{const p=this._getTokenSvcUrl(e);if(!p)return u=new A("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),h.reject(u),h.promise;d=new _e,d.server=this._getServerInstanceRoot(e),typeof p=="string"?(d.tokenServiceUrl=p,d.hasPortal=!0):(d._restInfoPms=p,d.hasServer=!0),this.registerServers([d])}return d.hasPortal&&d._selfReq===void 0&&(o||R(d.tokenServiceUrl,this._appOrigin)||this._gwDomains.some(p=>p.tokenServiceUrl===d.tokenServiceUrl))&&(d._selfReq={owningTenant:r?.owningTenant,selfDfd:this._getPortalSelf(d.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,d,r,h,l)}getResourceName(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""}generateToken(e,r,t){const i=this._rePortalTokenSvc.test(e.tokenServiceUrl),o=new C(this._appOrigin),a=e.shortLivedTokenValidity;let h,l,n,u,c,d,p,g;r&&(g=this.tokenValidity||a||this._defaultTokenValidity,g>a&&a>0&&(g=a)),t&&(h=t.isAdmin,l=t.serverUrl,n=t.token,d=t.signal,p=t.ssl,e.customParameters=t.customParameters),h?u=e.adminTokenServiceUrl:(u=e.tokenServiceUrl,c=new C(u.toLowerCase()),e.webTierAuth&&t?.serverUrl&&!p&&o.scheme==="http"&&(R(o.uri,u,!0)||c.scheme==="https"&&o.host===c.host&&o.port==="7080"&&c.port==="7443")&&(u=u.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const m={query:{request:"getToken",username:r?.username,password:r?.password,serverUrl:l,token:n,expiration:g,referer:h||i?this._appOrigin:null,client:h?"referer":null,f:"json",...e.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(e,t),signal:d};return i||(m.withCredentials=!1),O(u,m).then(y=>{const k=y.data;if(!k?.token)return new A("identity-manager:authentication-failed","Unable to generate token");const v=e.server;return Y[v]||(Y[v]={}),r&&(Y[v][r.username]=r.password),k.validity=g,k})}isBusy(){return!!this._busy}async checkSignInStatus(e){return(await this.checkAppAccess(e,"")).credential}checkAppAccess(e,r,t){let i=!1;return this.getCredential(e,{prompt:!1}).then(o=>{let a;const h={f:"json"};if(o.scope==="portal")if(r&&(this._doPortalSignIn(e)||t?.force))a=o.server+"/sharing/rest/oauth2/validateAppAccess",h.client_id=r;else{if(!o.token)return{credential:o};a=o.server+"/sharing/rest"}else{if(!o.token)return{credential:o};a=o.server+"/rest/services"}return o.token&&(h.token=o.token),O(a,{query:h,authMode:"anonymous"}).then(l=>{if(l.data.valid===!1)throw new A("identity-manager:not-authorized",`You are currently signed in as: '${o.userId}'.`,l.data);return i=!!l.data.viewOnlyUserTypeApp,{credential:o}}).catch(l=>{if(l.name==="identity-manager:not-authorized")throw l;const n=l.details?.httpStatus;if(n===498)throw o.destroy(),new A("identity-manager:not-authenticated","User is not signed in.");if(n===400)throw new A("identity-manager:invalid-request","Bad request");return{credential:o}})}).then(o=>({credential:o.credential,viewOnly:i}))}setOAuthResponseHash(e){e&&(e.startsWith("#")&&(e=e.slice(1)),this._processOAuthPopupParams(H(e)))}setOAuthRedirectionHandler(e){this._oAuthRedirectFunc=e}setProtocolErrorHandler(e){this._protocolFunc=e}signIn(e,r,t={}){const i=B(),o=()=>{l?.remove(),n?.remove(),this.dialog?.destroy(),this.dialog=l=n=null},a=()=>{o(),this._oAuthDfd=null,i.reject(new A("identity-manager:user-aborted","ABORTED"))};t.signal&&j(t.signal,()=>{a()});const h=new Be({open:!0,resource:this.getResourceName(e),server:r.server});this.dialog=h,this.emit("dialog-create");let l=h.on("cancel",a),n=h.on("submit",u=>{this.generateToken(r,u,{isAdmin:t.isAdmin,signal:t.signal}).then(c=>{o();const d=new I({userId:u.username,server:r.server??void 0,token:c.token,expires:c.expires!=null?Number(c.expires):null,ssl:!!c.ssl,isAdmin:t.isAdmin,validity:c.validity});i.resolve(d)}).catch(c=>{h.error=c,h.signingIn=!1})});return i.promise}oAuthSignIn(e,r,t,i){this._oAuthDfd=B();const o=this._oAuthDfd;let a;i?.signal&&j(i.signal,()=>{const d=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;d&&!d.closed?d.close():this.dialog&&u()}),o.resUrl_=e,o.sinfo_=r,o.oinfo_=t;const h=t._oAuthCred;if(h.storage&&(t.flowType==="authorization-code"||t.flowType==="auto"&&r.currentVersion>=8.4)){let d=crypto.getRandomValues(new Uint8Array(32));a=ae(d),h.codeVerifier=a,d=crypto.getRandomValues(new Uint8Array(32)),h.stateUID=ae(d),h.save()||(h.codeVerifier=a=null)}else h.codeVerifier=null;let l,n;this._getCodeChallenge(a).then(d=>{const p=!i||i.oAuthPopupConfirmation!==!1;if(!t.popup||!p)return void this._doOAuthSignIn(e,r,t,d);const g=new Be({oAuthPrompt:!0,server:r.server,open:!0});this.dialog=g,this.emit("dialog-create"),l=g.on("cancel",u),n=g.on("submit",()=>{c(),this._doOAuthSignIn(e,r,t,d)})});const u=()=>{c(),this._oAuthDfd=null,o.reject(new A("identity-manager:user-aborted","ABORTED"))},c=()=>{l?.remove(),n?.remove(),this.dialog?.destroy(),this.dialog=null};return o.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach(e=>{e.destroy()}),this.emit("credentials-destroy")}enablePostMessageAuth(e="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=K(window,"message",r=>{if((r.origin===this._appOrigin||r.origin.endsWith(".arcgis.com"))&&r.data?.type==="arcgis:auth:requestCredential"){const t=r.source;this.getCredential(e).then(i=>{t.postMessage({type:"arcgis:auth:credential",credential:{expires:i.expires,server:i.server,ssl:i.ssl,token:i.token,userId:i.userId}},r.origin)}).catch(i=>{t.postMessage({type:"arcgis:auth:error",error:{name:i.name,message:i.message}},r.origin)})}})}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthLocationParams(){let e=window.location.hash;if(e){e.startsWith("#")&&(e=e.slice(1));const t=H(e);let i=!1;if(t.access_token&&t.expires_in&&t.state&&t.hasOwnProperty("username"))try{t.state=JSON.parse(t.state),t.state.portalUrl&&(this._oAuthLocationParams=t,i=!0)}catch{}else if(t.error&&t.error_description&&(console.log("IdentityManager OAuth Error: ",t.error," - ",t.error_description),t.error==="access_denied"&&(i=!0,t.state)))try{t.state=JSON.parse(t.state)}catch{}i&&(window.location.hash=t.state?.hash||"")}let r=window.location.search;if(r){r.startsWith("?")&&(r=r.slice(1));const t=H(r);let i=!1;if(t.code&&t.state)try{t.state=JSON.parse(t.state),t.state.portalUrl&&t.state.uid&&(this._oAuthLocationParams=t,i=!0)}catch{}else if(t.error&&t.error_description&&(console.log("IdentityManager OAuth Error: ",t.error," - ",t.error_description),t.error==="access_denied"&&(i=!0,t.state)))try{t.state=JSON.parse(t.state)}catch{}if(i){const o={...t};["code","error","error_description","message_code","persist","state"].forEach(l=>{delete o[l]});const a=Re(o),h=window.location.pathname+(a?`?${a}`:"")+(t.state?.hash||"");window.history.replaceState(window.history.state,"",h)}}}_getOAuthToken(e,r,t,i,o){return e=e.replace(/^http:/i,"https:"),O(`${e}/sharing/rest/oauth2/token`,{authMode:"anonymous",method:"post",query:i&&o?{grant_type:"authorization_code",code:r,redirect_uri:i,client_id:t,code_verifier:o}:{grant_type:"refresh_token",refresh_token:r,client_id:t}}).then(a=>a.data)}async _getCodeChallenge(e){if(e&&globalThis.isSecureContext){const r=new TextEncoder().encode(e),t=await crypto.subtle.digest("SHA-256",r);return ae(new Uint8Array(t))}return null}_pageShowHandler(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const r=new A("identity-manager:user-aborted","ABORTED");this._errbackFunc(r)}}_findCredential(e,r){let t,i,o,a,h=-1;const l=r?.token,n=r?.resource,u=this._isServerRsrc(e)?"server":"portal",c=this.credentials.filter(d=>this._hasSameServerInstance(d.server,e)&&d.scope===u);if(e=n||e,c.length)if(c.length===1){if(t=c[0],o=this.findServerInfo(t.server),i=o?.owningSystemUrl,a=i?this.findCredential(i,t.userId):void 0,h=this._getIdenticalSvcIdx(e,t),!l)return h===-1&&t.resources.push(e),this._addResource(e,a),t;h!==-1&&(t.resources.splice(h,1),this._removeResource(e,a))}else{let d,p;if(c.some(g=>(p=this._getIdenticalSvcIdx(e,g),p!==-1&&(d=g,o=this.findServerInfo(d.server),i=o?.owningSystemUrl,a=i?this.findCredential(i,d.userId):void 0,h=p,!0))),l)d&&(d.resources.splice(h,1),this._removeResource(e,a));else if(d)return this._addResource(e,a),d}}_findOAuthInfo(e){let r=this.findOAuthInfo(e);if(!r){for(const t of this.oAuthInfos)if(this._isIdProvider(t.portalUrl,e)){r=t;break}}return r}_addResource(e,r){r&&this._getIdenticalSvcIdx(e,r)===-1&&r.resources.push(e)}_removeResource(e,r){let t=-1;r&&(t=this._getIdenticalSvcIdx(e,r),t>-1&&r.resources.splice(t,1))}_useProxy(e,r){return r?.isAdmin&&!R(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&String(e.currentVersion)==="10.1"&&!R(e.tokenServiceUrl,this._appOrigin)}_getOrigin(e){const r=new C(e);return r.scheme+"://"+r.host+(r.port!=null?":"+r.port:"")}_getServerInstanceRoot(e){const r=e.toLowerCase();let t=r.indexOf(this._agsRest);return t===-1&&this._isAdminResource(e)&&(t=this._agsAdmin.test(e)?e.replace(this._agsAdmin,"$1").length:e.search(this._adminSvcs)),t!==-1||Ct(r)||(t=r.indexOf("/sharing")),t===-1&&r.endsWith("/")&&(t=r.length-1),t>-1?e.slice(0,t):e}_hasSameServerInstance(e,r){return e.endsWith("/")&&(e=e.slice(0,-1)),e=e.toLowerCase(),r=this._getServerInstanceRoot(r).toLowerCase(),e=Ce(e),r=Ce(r),(e=e.slice(Math.max(0,e.indexOf(":"))))===(r=r.slice(Math.max(0,r.indexOf(":"))))}_sanitizeUrl(e){const r=(le.request.proxyUrl||"").toLowerCase(),t=r?e.toLowerCase().indexOf(r+"?"):-1;return t!==-1&&(e=e.slice(t+r.length+1)),e=Nt(e),ne(e).path}_isRESTService(e){return e.includes(this._agsRest)}_isAdminResource(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}_isServerRsrc(e){return this._isRESTService(e)||this._isAdminResource(e)}_isIdenticalService(e,r){let t=!1;if(this._isRESTService(e)&&this._isRESTService(r)){const i=this._getSuffix(e).toLowerCase(),o=this._getSuffix(r).toLowerCase();if(t=i===o,!t){const a=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;t=i.replaceAll(a,"$1")===o.replaceAll(a,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(r)?t=!0:this._isServerRsrc(e)||this._isServerRsrc(r)||!this._isPortalDomain(e)||(t=!0);return t}_isPortalDomain(e){const r=new C(e.toLowerCase()),t=this._portalConfig;let i=this._gwDomains.some(o=>o.regex.test(r.uri));return!i&&t&&(i=this._hasSameServerInstance(this._getServerInstanceRoot(t.restBaseUrl),r.uri)),i||le.portalUrl&&(i=R(r,le.portalUrl,!0)),i||(i=this._portals.some(o=>this._hasSameServerInstance(o,r.uri))),i=i||this._agsPortal.test(r.path),i}_isIdProvider(e,r){let t=-1,i=-1;this._gwDomains.forEach((a,h)=>{t===-1&&a.regex.test(e)&&(t=h),i===-1&&a.regex.test(r)&&(i=h)});let o=!1;if(t>-1&&i>-1&&(t===0||t===4?i!==0&&i!==4||(o=!0):t===1?i!==1&&i!==2||(o=!0):t===2?i===2&&(o=!0):t===3&&i===3&&(o=!0)),!o){const a=this.findServerInfo(r),h=a?.owningSystemUrl;h&&ht(a)&&this._isPortalDomain(h)&&this._isIdProvider(e,h)&&(o=!0)}return o}_getIdenticalSvcIdx(e,r){let t=-1;for(let i=0;i<r.resources.length;i++){const o=r.resources[i];if(this._isIdenticalService(e,o)){t=i;break}}return t}_getSuffix(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(e){let r,t,i;if(this._isRESTService(e)||this._isAdminResource(e)){const o=this._getServerInstanceRoot(e);return r=o+"/admin/generateToken",t=O(e=o+"/rest/info",{query:{f:"json"}}).then(a=>a.data),{adminUrl:r,promise:t}}if(this._isPortalDomain(e)){let o="";if(this._gwDomains.some(a=>(a.regex.test(e)&&(o=a.tokenServiceUrl),!!o)),o||this._portals.some(a=>(this._hasSameServerInstance(a,e)&&(o=a+this._gwTokenUrl),!!o)),o||(i=e.toLowerCase().indexOf("/sharing"),i!==-1&&(o=e.slice(0,i)+this._gwTokenUrl)),o||(o=this._getOrigin(e)+this._gwTokenUrl),o){const a=new C(e).port;/^http:\/\//i.test(e)&&a==="7080"&&(o=o.replace(/:7080/i,":7443")),o=o.replace(/http:/i,"https:")}return o}}_processOAuthResponseParams(e,r,t){const i=r._oAuthCred;if(e.code){const a=i.codeVerifier;return i.codeVerifier=null,i.stateUID=null,i.save(),this._getOAuthToken(t.server,e.code,r.appId,this._getRedirectURI(r,!0),a).then(h=>{const l=new I({userId:h.username,server:t.server??void 0,token:h.access_token,expires:Date.now()+1e3*h.expires_in,ssl:h.ssl,oAuthState:e.state,_oAuthCred:i});return r.userId=l.userId,i.storage=h.persist?Q:X,i.refreshToken=h.refresh_token,i.token=null,i.expires=h.refresh_token_expires_in?Date.now()+1e3*h.refresh_token_expires_in:null,i.userId=l.userId,i.ssl=l.ssl,i.save(),l})}const o=new I({userId:e.username,server:t.server??void 0,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:e.ssl==="true",oAuthState:e.state,_oAuthCred:i});return r.userId=o.userId,i.storage=e.persist?Q:X,i.refreshToken=null,i.token=o.token,i.expires=o.expires,i.userId=o.userId,i.ssl=o.ssl,i.save(),Promise.resolve(o)}_processOAuthPopupParams(e){const r=this._oAuthDfd;if(this._oAuthDfd=null,r)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle?.remove(),e.error){const t=e.error==="access_denied",i=new A(t?"identity-manager:user-aborted":"identity-manager:authentication-failed",t?"ABORTED":"OAuth: "+e.error+" - "+e.error_description);r.reject(i)}else this._processOAuthResponseParams(e,r.oinfo_,r.sinfo_).then(t=>{r.resolve(t)}).catch(t=>{r.reject(t)})}_setOAuthResponseQueryString(e){e&&(e.startsWith("?")&&(e=e.slice(1)),this._processOAuthPopupParams(H(e)))}async _exchangeToken(e,r,t){return(await O(`${e}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:r,token:t}})).data.token}async _getPlatformSelf(e,r){if(this._getPlatformSelfError&&Date.now()-this._getPlatformSelfError[1]<1e3)throw this._getPlatformSelfError[0];e=e.replace(/^http:/i,"https:");try{const t=await O(`${e}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":r,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0});return this._getPlatformSelfError=null,t.data}catch(t){throw t.details?.messageCode==="OAUTH_0066"&&(this._getPlatformSelfError=[t,Date.now()]),t}}_getPortalSelf(e,r){let t;return this._gwDomains.some(i=>(i.regex.test(e)&&(t=i.customBaseUrl),!!t)),t?Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:t,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(r)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),O(e,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(i=>i.data))}_doPortalSignIn(e){const r=this._portalConfig,t=window.location.href,i=this.findServerInfo(e);return!(!r&&!this._isPortalDomain(t)||!(i?i.hasPortal||i.owningSystemUrl&&this._isPortalDomain(i.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(t,e)||r&&(this._hasSameServerInstance(this._getServerInstanceRoot(r.restBaseUrl),e)||this._isIdProvider(r.restBaseUrl,e))||R(t,e,!0)))}_checkProtocol(e,r,t,i){let o=!0;const a=i?r.adminTokenServiceUrl:r.tokenServiceUrl;return a.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&Dt(a)&&(o=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:r}),!o)&&t(new A("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),o}_enqueue(e,r,t,i,o,a){return i||(i=B()),i.resUrl_=e,i.sinfo_=r,i.options_=t,i.admin_=o,i.refresh_=a,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(i)):this._xoReqs.push(i):this._doSignIn(i),i.promise}_doSignIn(e){this._busy=e,this._rejectOnPersistedPageShow=!1;const r=n=>{const u=e.options_?.resource,c=e.resUrl_,d=e.refresh_;let p=!1;this.credentials.includes(n)||(d&&this.credentials.includes(d)?(d.userId=n.userId,d.token=n.token,d.expires=n.expires,d.validity=n.validity,d.ssl=n.ssl,d.creationTime=n.creationTime,p=!0,n=d):this.credentials.push(n)),n.resources||(n.resources=[]),n.resources.includes(u||c)||n.resources.push(u||c),n.scope=this._isServerRsrc(c)?"server":"portal",n.emitTokenChange();const g=this._soReqs,m={};this._soReqs=[],g.forEach(y=>{if(!this._isIdenticalService(c,y.resUrl_)){const k=this._getSuffix(y.resUrl_);m[k]||(m[k]=!0,n.resources.push(y.resUrl_))}}),e.resolve(n),g.forEach(y=>{this._hasSameServerInstance(this._getServerInstanceRoot(c),y.resUrl_)?y.resolve(n):this._soReqs.push(y)}),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,p||this.emit("credential-create",{credential:n}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},t=n=>{e.reject(n),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},i=(n,u,c,d)=>{const p=e.sinfo_,g=!e.options_||e.options_.prompt!==!1,m=p.hasPortal&&this._findOAuthInfo(e.resUrl_);let y,k;if(n)r(new I({userId:n,server:p.server??void 0,token:c??void 0,expires:d!=null?Number(d):null,ssl:!!u}));else if(window!==window.parent&&this._appUrlObj.query?.["arcgis-auth-origin"]&&this._appUrlObj.query?.["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),e.resUrl_)){window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const v=K(window,"message",S=>{S.source===window.parent&&S.data&&(S.data.type==="arcgis:auth:credential"?(v.remove(),S.data.credential.expires<Date.now()?t(new A("identity-manager:credential-request-failed","Parent application's token has expired.")):r(new I(S.data.credential))):S.data.type==="arcgis:auth:error"&&(v.remove(),S.data.error.name==="tokenExpiredError"?t(new A("identity-manager:credential-request-failed","Parent application's token has expired.")):t(A.fromJSON(S.data.error))))});j(e.options_?.signal,()=>{v.remove()})}else if(m){let v=m._oAuthCred;if(!v){const S=new Ie(m,Q),w=new Ie(m,X);S.isValid()&&w.isValid()?S.expires>w.expires?(v=S,w.destroy()):(v=w,S.destroy()):v=S.isValid()?S:w,m._oAuthCred=v}if(v.isValid()){y=new I({userId:v.userId??void 0,server:p.server??void 0,token:v.token??void 0,expires:v.expires,ssl:v.ssl??void 0,_oAuthCred:v});const S=m.appId!==v.appId&&this._doPortalSignIn(e.resUrl_);S||v.refreshToken?(e._pendingDfd=v.refreshToken?this._getOAuthToken(p.server,v.refreshToken,v.appId).then(w=>(y.expires=Date.now()+1e3*w.expires_in,y.token=w.access_token,y)):Promise.resolve(y),e._pendingDfd.then(w=>S?this._exchangeToken(w.server,m.appId,w.token).then(P=>(w.token=P,w)).catch(()=>w):w).then(w=>{r(w)}).catch(w=>{const P=w.details?.httpStatus;P>0&&P!==404?(v.destroy(),i()):t(w)})):r(y)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(m.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===v.stateUID&&v.codeVerifier)){const S=this._oAuthLocationParams;this._oAuthLocationParams=null,e._pendingDfd=this._processOAuthResponseParams(S,m,p).then(w=>{r(w)}).catch(t)}else{const S=()=>{g?e._pendingDfd=this.oAuthSignIn(e.resUrl_,p,m,e.options_).then(r,t):(k=new A("identity-manager:not-authenticated","User is not signed in."),t(k))};this._doPortalSignIn(e.resUrl_)?e._pendingDfd=this._getPlatformSelf(p.server,m.appId).then(w=>{R(w.portalUrl,this._appOrigin,!0)?(y=new I({userId:w.username,server:p.server??void 0,expires:Date.now()+1e3*w.expires_in,token:w.token}),r(y)):S()}).catch(S):S()}}else if(g){if(this._checkProtocol(e.resUrl_,p,t,e.admin_)){let v=e.options_;e.admin_&&(v=v||{},v.isAdmin=!0),e._pendingDfd=this.signIn(e.resUrl_,p,v).then(r,t)}}else k=new A("identity-manager:not-authenticated","User is not signed in."),t(k)},o=()=>{const n=e.sinfo_,u=n.owningSystemUrl,c=e.options_;let d,p,g,m;if(c&&(d=c.token,p=c.error,g=c.prompt),m=this._findCredential(u,{token:d,resource:e.resUrl_}),!m){for(const y of this.credentials)if(this._isIdProvider(u,y.server)){m=y;break}}if(m){const y=this.findCredential(e.resUrl_,m.userId);if(y)r(y);else if(Ae(n,this._legacyFed)){const k=m.toJSON();k.server=n.server,k.resources=null,r(new I(k))}else(e._pendingDfd=this.generateToken(this.findServerInfo(m.server),null,{serverUrl:e.resUrl_,token:m.token,signal:e.options_.signal,ssl:m.ssl})).then(k=>{r(new I({userId:m?.userId,server:n.server??void 0,token:k.token,expires:k.expires!=null?Number(k.expires):null,ssl:!!k.ssl,isAdmin:e.admin_,validity:k.validity}))},t)}else this._busy=null,d&&(e.options_.token=null),(e._pendingDfd=this.getCredential(u.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:n.owningTenant,signal:e.options_.signal,token:d,error:p,prompt:g})).then(()=>{this._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)},y=>{e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(y)})};this._errbackFunc=t;const a=e.sinfo_.owningSystemUrl,h=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then(n=>{const u=e.sinfo_;if(u._restInfoPms){u.adminTokenServiceUrl=u._restInfoPms.adminUrl,u._restInfoPms=null,u.tokenServiceUrl=(F("authInfo.tokenServicesUrl",n)||F("authInfo.tokenServiceUrl",n)||F("tokenServiceUrl",n))??null,u.shortLivedTokenValidity=F("authInfo.shortLivedTokenValidity",n)??null,u.currentVersion=n.currentVersion,u.owningTenant=n.owningTenant;const c=u.owningSystemUrl=n.owningSystemUrl;c&&this._portals.push(c)}h&&u.owningSystemUrl?o():i()},()=>{e.sinfo_._restInfoPms=null;const n=new A("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");t(n)}):h&&a?o():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then(n=>{const u={};let c,d,p,g;return n&&(c=n.user?.username,u.username=c,u.allSSL=n.allSSL,d=n.supportsOAuth,g=parseFloat(n.currentVersion),n.portalMode==="multitenant"&&(p=n.customBaseUrl),e.sinfo_.currentVersion=g),e.sinfo_.webTierAuth=!!c,c&&this.normalizeWebTierAuth?this.generateToken(e.sinfo_,null,{ssl:u.allSSL}).catch(()=>null).then(m=>(u.portalToken=m?.token,u.tokenExpiration=m?.expires,u)):!c&&d&&g>=4.4&&!this._findOAuthInfo(e.resUrl_)?this._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:p,owningTenant:e.sinfo_._selfReq.owningTenant}).catch(()=>null).then(()=>u):u}).catch(()=>null).then(n=>{e.sinfo_._selfReq=null,n?i(n.username,n.allSSL,n.portalToken,n.tokenExpiration):i()}):i()}_generateOAuthInfo(e){let r,t=null,i=e.portalUrl;const o=e.customBaseUrl,a=e.owningTenant,h=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(h){t=this._appUrlObj.path;const l=t.search(/\/(apps|home)\//);t=l>-1?t.slice(0,l):null}return h&&t?(this._hasTestedIfAppIsOnPortal=!0,r=O(t+"/sharing/rest",{query:{f:"json"}}).then(()=>{this._defaultOAuthInfo=new He({appId:"arcgisonline",popupCallbackUrl:t+"/home/oauth-callback.html"})})):r=Promise.resolve(),r.then(()=>{if(this._defaultOAuthInfo)return i=i.replace(/^http:/i,"https:"),O(i+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:a,client_id:this._defaultOAuthInfo.appId,redirect_uri:ge(this._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(l=>{if(l.data.valid){const n=this._defaultOAuthInfo.clone();l.data.urlKey&&o?n.portalUrl="https://"+l.data.urlKey.toLowerCase()+"."+o:n.portalUrl=i,n.popup=window!==window.top||!(R(i,this._appOrigin)||this._gwDomains.some(u=>u.regex.test(i)&&u.regex.test(this._appOrigin))),this.oAuthInfos.push(n)}})})}_doOAuthSignIn(e,r,t,i){const o=t._oAuthCred,a={portalUrl:t.portalUrl};!t.popup&&t.preserveUrlHash&&window.location.hash&&(a.hash=window.location.hash),o.stateUID&&(a.uid=o.stateUID);const h={client_id:t.appId,response_type:o.codeVerifier?"code":"token",state:JSON.stringify(a),expiration:t.expiration,locale:t.locale,redirect_uri:this._getRedirectURI(t,!!o.codeVerifier)};t.forceLogin&&(h.force_login=!0),t.forceUserId&&t.userId&&(h.prepopulatedusername=t.userId),!t.popup&&this._doPortalSignIn(e)&&(h.redirectToUserOrgUrl=!0),o.codeVerifier&&(h.code_challenge=i||o.codeVerifier,h.code_challenge_method=i?"S256":"plain");const l=t.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",n=l+"?"+Re(h);if(t.popup){const u=window.open(n,"esriJSAPIOAuth",t.popupWindowFeatures);if(u)u.focus(),this._oAuthDfd.oAuthWin_=u,this._oAuthIntervalId=setInterval(()=>{if(u.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();const c=this._oAuthDfd;if(c){const d=new A("identity-manager:user-aborted","ABORTED");c.reject(d)}}},500),this._oAuthOnPopupHandle=K(window,["arcgis:auth:hash","arcgis:auth:location:search"],c=>{c.type==="arcgis:auth:hash"?this.setOAuthResponseHash(c.detail):this._setOAuthResponseQueryString(c.detail)});else{const c=new A("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(c)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:h,authorizeUrl:l,resourceUrl:e,serverInfo:r,oAuthInfo:t}):window.location.href=n}_getRedirectURI(e,r){const t=window.location.href.replace(/#.*$/,"");if(e.popup)return ge(e.popupCallbackUrl);if(r){const i=ne(t);return i.query&&["code","error","error_description","message_code","persist","state"].forEach(o=>{delete i.query[o]}),Et(i.path,i.query)}return t}}dt.prototype.declaredClass="esri.identity.IdentityManagerBase";let I=class extends ze{constructor(s){super(s),this._oAuthCred=null,this.tokenRefreshBuffer=2,s?._oAuthCred&&(this._oAuthCred=s._oAuthCred)}initialize(){this.resources=this.resources||[],this.creationTime==null&&(this.creationTime=Date.now())}refreshToken(){const s=z,e=s.findServerInfo(this.server),r=e?.owningSystemUrl,t=!!r&&this.scope==="server",i=t&&Ae(e,s._legacyFed),o=e.webTierAuth,a=o&&s.normalizeWebTierAuth,h=Y[this.server],l=h?.[this.userId];let n,u=this.resources&&this.resources[0],c=t?s.findServerInfo(r):null,d={username:this.userId,password:l};if(o&&!a)return;t&&!c&&s.serverInfos.some(g=>(s._isIdProvider(r,g.server)&&(c=g),!!c));const p=c?s.findCredential(c.server,this.userId):null;if(!t||p){if(!i){if(t)n={serverUrl:u,token:p?.token,ssl:p?.ssl};else if(a)d=null,n={ssl:this.ssl};else{if(!l){let g;return u&&(u=s._sanitizeUrl(u),this._enqueued=1,g=s._enqueue(u,e,null,null,this.isAdmin,this),g.then(()=>{this._enqueued=0,this.refreshServerTokens()}).catch(()=>{this._enqueued=0})),g}this.isAdmin&&(n={isAdmin:!0})}return s.generateToken(t?c:e,t?null:d,n).then(g=>{this.token=g.token,this.expires=g.expires!=null?Number(g.expires):null,this.creationTime=Date.now(),this.validity=g.validity,this.emitTokenChange(),this.refreshServerTokens()}).catch(()=>{})}p?.refreshToken()}}refreshServerTokens(){if(this.scope==="portal"){const s=z;s.credentials.forEach(e=>{const r=s.findServerInfo(e.server),t=r?.owningSystemUrl;e!==this&&e.userId===this.userId&&t&&e.scope==="server"&&(s._hasSameServerInstance(this.server,t)||s._isIdProvider(t,this.server))&&(Ae(r,s._legacyFed)?(e.token=this.token,e.expires=this.expires,e.creationTime=this.creationTime,e.validity=this.validity,e.emitTokenChange()):e.refreshToken())})}}emitTokenChange(s){clearTimeout(this._refreshTimer);const e=z,r=this.server?e.findServerInfo(this.server):null,t=r?.owningSystemUrl,i=t?e.findServerInfo(t):null;s===!1||t&&this.scope!=="portal"&&(!i?.webTierAuth||e.normalizeWebTierAuth)||this.expires==null&&this.validity==null||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const s=z,e=s.credentials.indexOf(this);e>-1&&s.credentials.splice(e,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const s=Je({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),e=this.resources;return e&&e.length>0&&(s.resources=e.slice()),s}_startRefreshTimer(){clearTimeout(this._refreshTimer);const s=6e4*this.tokenRefreshBuffer,e=2**31-1;let r=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();r<0?r=0:r>e&&(r=e),this._refreshTimer=setTimeout(this.refreshToken.bind(this),r>s?r-s:r)}};f([_()],I.prototype,"creationTime",void 0),f([_()],I.prototype,"expires",void 0),f([_()],I.prototype,"isAdmin",void 0),f([_()],I.prototype,"oAuthState",void 0),f([_()],I.prototype,"resources",void 0),f([_()],I.prototype,"scope",void 0),f([_()],I.prototype,"server",void 0),f([_()],I.prototype,"ssl",void 0),f([_()],I.prototype,"token",void 0),f([_()],I.prototype,"tokenRefreshBuffer",void 0),f([_()],I.prototype,"userId",void 0),f([_()],I.prototype,"validity",void 0),I=f([V("esri.identity.Credential")],I);class ct extends dt{}ct.prototype.declaredClass="esri.identity.IdentityManager";const kr=new ct;jt(kr);export{kr as default};
