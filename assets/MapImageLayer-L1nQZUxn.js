const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mapImageLayerUtils-1OQrIbe9.js","assets/utils-CEXuqjP3.js","assets/MapPage-BfoPTtM9.js","assets/index-aygzdjjp.js","assets/index-ChhpDj5l.css","assets/themeLevelStore-Ctx-LCCx.js","assets/MapPage-NuuMBo9V.css","assets/originUtils-CPX8CCAY.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/PortalItem-52Ecjo9l.js","assets/jsonContext-DXrCZRRj.js","assets/portalItemUtils-DS6wmGsF.js","assets/projectionUtils-Ij-OxAGa.js","assets/saveUtils-2_n7zita.js"])))=>i.map(i=>d[i]);
import{_ as L}from"./index-aygzdjjp.js";import{i as w,fb as P,fc as _,_ as a,z as o,A as I,d$ as $,f as E,d0 as g,fd as T,dt as N,em as D,fe as F,H as f,cj as j,c1 as J,s as b,Y as R,cT as M,P as V,N as A,dT as U}from"./MapPage-BfoPTtM9.js";import{l as q}from"./loadAll-lcJQgg3d.js";import{l as H}from"./MultiOriginJSONSupport-DnXi6D8r.js";import{o as k}from"./APIKeyMixin-CULpiF0n.js";import{e as z,m as W,h as C,r as v,l as G}from"./SublayersOwner-CAKFjaRt.js";import{l as Z}from"./ArcGISService-BKry1nnj.js";import{p as B}from"./BlendLayer-7UXRAWhI.js";import{s as K}from"./CustomParametersMixin-B5GgO6qj.js";import{b as Y,c as Q,y as X}from"./OperationalLayer-BG54pBBU.js";import{j as ee}from"./PortalLayer-C2ZKqgY0.js";import{f as re}from"./RefreshableLayer-BHSItzT9.js";import{t as te}from"./ScaleRangeLayer-DUJ66nsl.js";import{l as ie}from"./TemporalLayer-DFA8IGCW.js";import{t as se}from"./imageBitmapUtils-Cf-8iTmQ.js";import{t as ae}from"./versionUtils-BAZecSnU.js";import{a as S}from"./timeZoneUtils-DHTdi3Nx.js";import"./themeLevelStore-Ctx-LCCx.js";import"./asyncUtils-D-trmfSm.js";import"./Version-a_1ikdgt.js";import"./portalItemUtils-DS6wmGsF.js";import"./projectionUtils-Ij-OxAGa.js";import"./CollectionFlattener-kPa74ru7.js";import"./GraphicOrigin-C8iRAnp6.js";import"./QueryTask-D5foBzPF.js";import"./infoFor3D-DhzudQro.js";import"./Query-B0Z-eM20.js";import"./Field-EThtuOM8.js";import"./fieldType-GnLsP98j.js";import"./executeQueryJSON-DLM0XqOm.js";import"./query-7JY0i-aV.js";import"./normalizeUtils-Bw8lQyv9.js";import"./Cyclical-Budqy7wm.js";import"./normalizeUtilsCommon-CenHzOXK.js";import"./pbfQueryUtils-E-JPhLew.js";import"./pbf-C4bBI37A.js";import"./memoryEstimations-CwZI8reE.js";import"./OptimizedFeature-CFFTNp0u.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./queryZScale-B9ciMgV7.js";import"./FeatureSet-CHR82VF1.js";import"./featureConversionUtils-CtS8JKI8.js";import"./OrderedLayer-BNfhlKRC.js";import"./labelingInfo-CB8iwrPR.js";import"./uuid-CvkFFREi.js";import"./SimpleRenderer-C03Fgwp2.js";import"./ClassBreaksRenderer-Bvy7aYLX.js";import"./diffUtils-CfM038ps.js";import"./RendererLegendOptions-DYrUzn8_.js";import"./styleUtils-DT9L5vU7.js";import"./colorRamps-DNtvkHFI.js";import"./jsonUtils-VqsI-mK_.js";import"./defaults-DGu_l9PU.js";import"./defaultsJSON-GKolV7NZ.js";import"./NormalizationBinParametersMixin-D8KQBeF6.js";import"./labelUtils-Dua63Kbw.js";import"./FeatureType-BOOZaVLp.js";import"./FeatureTemplate-BxMSf7HI.js";import"./FieldsIndex-CW9uIUJE.js";import"./UnknownTimeZone-BoZ8EQFQ.js";import"./LayerFloorInfo-rJD1Aepj.js";import"./Relationship-DcSXhI05.js";import"./serviceCapabilitiesUtils-CwJJy4js.js";import"./typeUtils-Cmuz1_Jw.js";import"./LRUCache-CHXeCC2B.js";import"./DictionaryScriptEvaluator-BWJ1vNdZ.js";import"./TimeOnly-DNvkoYlQ.js";import"./enum-CdqcMMIv.js";import"./utils-CNckjA7H.js";import"./heatmapUtils-gT92ClKK.js";import"./vec42-jW_iPzJG.js";import"./vec4f64-CvoGn1-Y.js";import"./popupUtils-UwfdgPsE.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-BQmPsIKa.js";import"./PortalItem-52Ecjo9l.js";import"./TimeInfo-Cx66LPvT.js";function x(e,r){return"floorInfo"in r&&r.floorInfo?.floorField?oe(e,r.floorInfo.floorField):null}function oe(e,r){if(!e?.length)return null;const i=e.filter(t=>t!=="").map(t=>`'${t}'`);return i.push("''"),`${r} IN (${i.join(",")}) OR ${r} IS NULL`}const le={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"};let y=class extends w{constructor(e){super(e),this.floors=null,this.scale=0}destroy(){this.layer=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;const e=this.visibleSublayers.map(r=>{const i=x(this.floors,r);return r.toExportImageJSON(i)});return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&z(this.visibleSublayers,this.layer.serviceSublayers,this.layer.gdbVersion)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.removeHandles("layer"),e&&this.addHandles([e.allSublayers.on("change",()=>this.notifyChange("visibleSublayers")),e.on("sublayer-update",r=>this.notifyChange(le[r.propertyName]))],"layer"))}get layers(){const e=this.visibleSublayers;return e?e.length?"show:"+e.map(r=>r.id).join(","):"show:-1":null}get layerDefs(){const e=!!this.floors?.length,r=this.visibleSublayers.filter(i=>i.definitionExpression!=null||e&&i.floorInfo!=null);return r.length?JSON.stringify(r.reduce((i,t)=>{const l=x(this.floors,t),s=P(l,t.definitionExpression);return s!=null&&(i[t.id]=s),i},{})):null}get version(){this.commitProperty("layers"),this.commitProperty("layerDefs"),this.commitProperty("dynamicLayers");const e=this.layer;return e&&(e.commitProperty("dpi"),e.commitProperty("imageFormat"),e.commitProperty("imageTransparency"),e.commitProperty("gdbVersion")),(this._get("version")||0)+1}get visibleSublayers(){const e=[];if(!this.layer)return e;const r=this.layer.sublayers,i=this.scale,t=s=>{s.visible&&(i===0||_(i,s.minScale,s.maxScale))&&(s.sublayers?s.sublayers.forEach(t):e.unshift(s))};r?.forEach(t);const l=this._get("visibleSublayers");return!l||l.length!==e.length||l.some((s,m)=>e[m]!==s)?e:l}toJSON(){const e=this.layer;let r={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?r.dynamicLayers=this.dynamicLayers:r={...r,layers:this.layers,layerDefs:this.layerDefs},r}};a([o({readOnly:!0})],y.prototype,"dynamicLayers",null),a([o()],y.prototype,"floors",void 0),a([o({readOnly:!0})],y.prototype,"hasDynamicLayers",null),a([o()],y.prototype,"layer",null),a([o({readOnly:!0})],y.prototype,"layers",null),a([o({readOnly:!0})],y.prototype,"layerDefs",null),a([o({type:Number})],y.prototype,"scale",void 0),a([o({readOnly:!0})],y.prototype,"version",null),a([o({readOnly:!0})],y.prototype,"visibleSublayers",null),y=a([I("esri.layers.support.ExportImageParameters")],y);let n=class extends B(ie(te(W(C(Z(Y(ee(H(re(k(K(M)))))))))))){constructor(...e){super(...e),this._exportImageParameters=new y({layer:this}),this.dateFieldsTimeZone=null,this.datesInUnknownTimezone=!1,this.dpi=96,this.elevationInfo=new Q({mode:"on-the-ground"}),this.gdbVersion=null,this.imageFormat="png24",this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.isReference=null,this.labelsVisible=!1,this.operationalLayerType="ArcGISMapServiceLayer",this.preferredTimeZone=null,this.sourceJSON=null,this.sublayers=null,this.type="map-image",this.url=null,this._debouncedSaveOperations=$(async(r,i,t)=>{const{save:l,saveAs:s}=await L(()=>import("./mapImageLayerUtils-1OQrIbe9.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]));switch(r){case 0:return l(this,i);case 1:return s(this,t,i)}})}normalizeCtorArgs(e,r){return typeof e=="string"?{url:e,...r}:e}load(e){const r=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).catch(E).then(()=>this._fetchService(r))),Promise.resolve(this)}destroy(){this._exportImageParameters.destroy()}readImageFormat(e,r){const i=r.supportedImageFormatTypes;return i&&i.includes("PNG32")?"png32":"png24"}get loaded(){return super.loaded}set portalItem(e){super.portalItem=e}writeSublayers(e,r,i,t){if(!this.loaded||!e)return;const l=e.slice().reverse().flatten(({sublayers:p})=>p&&p.toArray().reverse()).toArray();let s=!1;const m=g(t.origin);let u;if(this.capabilities?.operations.supportsExportMap&&this.capabilities?.exportMap?.supportsDynamicLayers){if(m===3){const p=this.createSublayersForOrigin("service").sublayers;s=v(l,p,2)}else if(m>3){const p=this.createSublayersForOrigin("portal-item");s=v(l,p.sublayers,g(p.origin)),u=p.originWithPartialOverrides}}const c=[],d={writeSublayerStructure:s,...t,minimumWritableOrigin:u};let h=s||this.hasVisibleLayersForOrigin(m);l.forEach(p=>{const O=p.write({},d);c.push(O),h=h||p.originOf("visible")==="user"}),c.some(p=>Object.keys(p).length>1)&&(r.layers=c),h&&(r.visibleLayers=l.filter(p=>p.visible).map(p=>p.id))}createExportImageParameters(e,r,i,t){const l=t?.pixelRatio||1;e&&this.version>=10&&(e=e.clone().shiftCentralMeridian()),this._exportImageParameters.floors=t?.floors??null,this._exportImageParameters.scale=t?.scale||T({extent:e,width:r})*l;const s=this._exportImageParameters.toJSON(),m=!t?.rotation||this.version<10.3?{}:{rotation:-t.rotation},u=e?.spatialReference,c=N(u);if(t?.scale&&e){const h=e.width/r*(D(e?.spatialReference)*F);s.dpi=t.scale/h}s.dpi*=l;const d={};if(t?.timeExtent){const{start:h,end:p}=t.timeExtent.toJSON();d.time=h&&p&&h===p?""+h:`${h??"null"},${p??"null"}`}else this.timeInfo&&!this.timeInfo.hasLiveData&&(d.time="null,null");return{bbox:e?e.xmin+","+e.ymin+","+e.xmax+","+e.ymax:void 0,bboxSR:c,imageSR:c,size:r+","+i,...s,...m,...d}}async fetchImage(e,r,i,t){const{data:l}=await this._fetchImage("image",e,r,i,t);return l}async fetchImageBitmap(e,r,i,t){const{data:l,url:s}=await this._fetchImage("blob",e,r,i,t);return se(l,s,t?.signal)}async fetchRecomputedExtents(e={}){const r={...e,query:{returnUpdates:!0,f:"json",...this.customParameters,token:this.apiKey}},{data:i}=await f(this.url,r),{extent:t,fullExtent:l,timeExtent:s}=i,m=t||l;return{fullExtent:m&&J.fromJSON(m),timeExtent:s&&j.fromJSON({start:s[0],end:s[1]})}}loadAll(){return q(this,e=>{e(this.allSublayers),e(this.subtables)})}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,r){return this._debouncedSaveOperations(1,r,e)}serviceSupportsSpatialReference(e){return ae(this,e)}async _fetchImage(e,r,i,t,l){const s={responseType:e,signal:l?.signal??null,query:{...this.parsedUrl.query,...this.createExportImageParameters(r,i,t,l),f:"image",...this.refreshParameters,...this.customParameters,token:this.apiKey}},m=this.parsedUrl.path+"/export";if(s.query?.dynamicLayers!=null&&!this.capabilities?.exportMap?.supportsDynamicLayers)throw new b("mapimagelayer:dynamiclayer-not-supported",`service ${this.url} doesn't support dynamic layers, which is required to be able to change the sublayer's order, rendering, labeling or source.`,{query:s.query});try{const{data:u}=await f(m,s);return{data:u,url:m}}catch(u){throw R(u)?u:new b("mapimagelayer:image-fetch-error",`Unable to load image: ${m}`,{error:u})}}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:r,ssl:i}=await f(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters,token:this.apiKey},signal:e});i&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=r,this.read(r,{origin:"service",url:this.parsedUrl})}hasVisibleLayersForOrigin(e){return!(e==null||!this.sublayersSourceJSON[e]?.visibleLayers)}};a([o(S("dateFieldsTimeReference"))],n.prototype,"dateFieldsTimeZone",void 0),a([o({type:Boolean})],n.prototype,"datesInUnknownTimezone",void 0),a([o()],n.prototype,"dpi",void 0),a([o()],n.prototype,"elevationInfo",void 0),a([o()],n.prototype,"gdbVersion",void 0),a([o()],n.prototype,"imageFormat",void 0),a([V("imageFormat",["supportedImageFormatTypes"])],n.prototype,"readImageFormat",null),a([o({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],n.prototype,"imageMaxHeight",void 0),a([o({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],n.prototype,"imageMaxWidth",void 0),a([o()],n.prototype,"imageTransparency",void 0),a([o({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],n.prototype,"isReference",void 0),a([o({json:{read:!1,write:!1}})],n.prototype,"labelsVisible",void 0),a([o({type:["ArcGISMapServiceLayer"]})],n.prototype,"operationalLayerType",void 0),a([o({json:{read:!1,write:!1}})],n.prototype,"popupEnabled",void 0),a([o(S("preferredTimeReference"))],n.prototype,"preferredTimeZone",void 0),a([o()],n.prototype,"sourceJSON",void 0),a([o({json:{write:{ignoreOrigin:!0}}})],n.prototype,"sublayers",void 0),a([A("sublayers",{layers:{type:[G]},visibleLayers:{type:[U]}})],n.prototype,"writeSublayers",null),a([o({type:["show","hide","hide-children"],json:{origins:{"portal-item":{read:!1,write:!1}}}})],n.prototype,"listMode",void 0),a([o({json:{read:!1},readOnly:!0,value:"map-image"})],n.prototype,"type",void 0),a([o(X)],n.prototype,"url",void 0),n=a([I("esri.layers.MapImageLayer")],n);const Nr=n;export{Nr as default};
