import{e as wt}from"./deduplicate-D2vFQwtF.js";import{Q as U,t as Z}from"./InterleavedLayout-c9VRKbOv.js";import{a as at}from"./VertexAttributeLocations-W6y2attr.js";import{aZ as N,b4 as G,fL as vt,c3 as ct,b8 as $t,bQ as xt}from"./MapPage-D71GL5Tx.js";import{p as At,o as j,s as Y,P as R,c as tt,_ as lt,A as ft,K as Nt,u as yt}from"./vec32-CvVnfuN2.js";const bt=U().vec3f("position").u16("componentIndex").freeze(),It=U().vec2u8("sideness").freeze(),ut=Z(It),pt=U().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),dt=U().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").vec2i16("normal2Compressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),St=Z(pt,1),Mt=Z(dt,1);at([ut,St]);at([ut,Mt]);class Vt{constructor(){this.position0=N(),this.position1=N(),this.faceNormal0=N(),this.faceNormal1=N(),this.componentIndex=0,this.cosAngle=0}}const O=-1;function zt(t,n,s){const r=t.vertices.position,i=t.vertices.componentIndex,c=v.position0,p=v.position1,h=v.faceNormal0,m=v.faceNormal1,{edges:a,normals:u}=Ft(t),g=a.length/4,x=n.allocate(g);let z=0;const k=g,y=s?.allocate(k);let E=0,e=0,o=0;W.length=0;for(let d=0;d<g;++d){const I=4*d;r.getVec(a.data[I],c),r.getVec(a.data[I+1],p);const _=W.pushNew();_.index=4*d,_.length=At(c,p)}W.sort((d,I)=>I.length-d.length);const f=new Array,l=new Array;W.forAll(({length:d,index:I})=>{const _=a.data[I],mt=a.data[I+1],J=a.data[I+2],T=a.data[I+3],X=T===O;if(r.getVec(_,c),r.getVec(mt,p),X){const A=3*J;j(h,u.data[A],u.data[A+1],u.data[A+2]),Y(m,h),v.componentIndex=i.get(_),v.cosAngle=R(h,m)}else{let A=3*J;if(j(h,u.data[A],u.data[A+1],u.data[A+2]),A=3*T,j(m,u.data[A],u.data[A+1],u.data[A+2]),v.componentIndex=i.get(_),v.cosAngle=R(h,m),_t(v,kt))return;v.cosAngle<-.9999&&Y(m,h)}e+=d,o++,X||Bt(v,Wt)?(n.write(x,z++,v),f.push(d)):Ct(v,ht)&&(y&&s&&s.write(y,E++,v),l.push(d))});const $=new Float32Array(f.reverse()),b=new Float32Array(l.reverse()),S=y&&s?{instancesData:y.slice(0,E),lodInfo:{lengths:b}}:void 0;return{regular:{instancesData:x.slice(0,z),lodInfo:{lengths:$}},silhouette:S,averageEdgeLength:e/o}}function Bt(t,n){return t.cosAngle<n}function _t(t,n){return t.cosAngle>n}function Ct(t,n){const s=vt(t.cosAngle);return Nt(et,t.position1,t.position0),s*(R(lt(Ut,t.faceNormal0,t.faceNormal1),et)>0?-1:1)>n}function Ft(t){const n=t.faces.length/3,s=t.faces,r=t.neighbors,i=t.vertices.position;w.length=H.length=0;for(let c=0;c<n;c++){const p=3*c,h=r[p],m=r[p+1],a=r[p+2],u=s[p],g=s[p+1],x=s[p+2];i.getVec(u,B),i.getVec(g,D),i.getVec(x,P),tt(D,D,B),tt(P,P,B),lt(B,D,P),ft(B,B),H.pushArray(B),(h===O||u<g)&&(w.push(u),w.push(g),w.push(c),w.push(h)),(m===O||g<x)&&(w.push(g),w.push(x),w.push(c),w.push(m)),(a===O||x<u)&&(w.push(x),w.push(u),w.push(c),w.push(a))}return{edges:w,normals:H}}class Lt{constructor(){this.index=0,this.length=0}}const W=new G({allocator:t=>t||new Lt,deallocator:null}),w=new G({deallocator:null}),H=new G({deallocator:null}),v=new Vt,Ut=N(),et=N(),B=N(),D=N(),P=N(),ht=ct(4),kt=Math.cos(ht),Et=ct(35),Wt=Math.cos(Et);function nt(t,n,s){const r=n/3,i=new Uint32Array(s+1),c=new Uint32Array(s+1),p=(e,o)=>{e<o?i[e+1]++:c[o+1]++};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],l=t[3*e+2];p(o,f),p(f,l),p(l,o)}let h=0,m=0;for(let e=0;e<s;e++){const o=i[e+1],f=c[e+1];i[e+1]=h,c[e+1]=m,h+=o,m+=f}const a=new Uint32Array(6*r),u=i[s],g=(e,o,f)=>{if(e<o){const l=i[e+1]++;a[2*l]=o,a[2*l+1]=f}else{const l=c[o+1]++;a[2*u+2*l]=e,a[2*u+2*l+1]=f}};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],l=t[3*e+2];g(o,f,e),g(f,l,e),g(l,o,e)}const x=(e,o)=>{const f=2*e,l=o-e;for(let $=1;$<l;$++){const b=a[f+2*$],S=a[f+2*$+1];let d=$-1;for(;d>=0&&a[f+2*d]>b;d--)a[f+2*d+2]=a[f+2*d],a[f+2*d+3]=a[f+2*d+1];a[f+2*d+2]=b,a[f+2*d+3]=S}};for(let e=0;e<s;e++)x(i[e],i[e+1]),x(u+c[e],u+c[e+1]);const z=new Int32Array(3*r),k=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,y=(e,o)=>{const f=k(e,o);z[3*o+f]=-1},E=(e,o,f,l)=>{const $=k(e,o);z[3*o+$]=l;const b=k(f,l);z[3*l+b]=o};for(let e=0;e<s;e++){let o=i[e];const f=i[e+1];let l=c[e];const $=c[e+1];for(;o<f&&l<$;){const b=a[2*o],S=a[2*u+2*l];b===S?(E(e,a[2*o+1],S,a[2*u+2*l+1]),o++,l++):b<S?(y(e,a[2*o+1]),o++):(y(S,a[2*u+2*l+1]),l++)}for(;o<f;)y(e,a[2*o+1]),o++;for(;l<$;)y(a[2*u+2*l],a[2*u+2*l+1]),l++}return z}function K(t,n,s,r,i,c=2){const p=1/(Math.abs(s)+Math.abs(r)+Math.abs(i)),h=s*p,m=r*p,a=i<=0?(h>=0?1:-1)*(1-Math.abs(m)):h,u=i<=0?(m>=0?1:-1)*(1-Math.abs(h)):m,g=n*c;t[g]=st(a),t[g+1]=st(u)}function st(t){return $t(Math.round(32767*t),-32767,32767)}const Q=.7;let gt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Pt:Dt}write(n,s,r){q.seed=this._edgeHashFunction(r);const i=q.getIntRange(0,255),c=q.getIntRange(0,this.settings.variants-1),p=q.getFloat(),h=255*(.5*qt(-(1-Math.min(p/Q,1))+Math.max(0,p-Q)/(1-Q),1.2)+.5);n.position0.setVec(s,r.position0),n.position1.setVec(s,r.position1),n.componentIndex.set(s,r.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,c),n.variantExtension.set(s,h)}};const M=new Float32Array(6),V=new Uint32Array(M.buffer),L=new Uint32Array(1);function Dt(t){return M[0]=t.position0[0],M[1]=t.position0[1],M[2]=t.position0[2],M[3]=t.position1[0],M[4]=t.position1[1],M[5]=t.position1[2],L[0]=31*(31*(31*(31*(31*(166811+V[0])+V[1])+V[2])+V[3])+V[4])+V[5],L[0]}function Pt(t){const n=M;n[0]=C(t.position0[0]),n[1]=C(t.position0[1]),n[2]=C(t.position0[2]),n[3]=C(t.position1[0]),n[4]=C(t.position1[1]),n[5]=C(t.position1[2]),L[0]=5381;for(let s=0;s<V.length;s++)L[0]=31*L[0]+V[s];return L[0]}const ot=1e4;function C(t){return Math.round(t*ot)/ot}function qt(t,n){return Math.abs(t)**n*Math.sign(t)}class Ot{constructor(){this._commonWriter=new gt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return pt.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),yt(F,r.faceNormal0,r.faceNormal1),ft(F,F);const{typedBuffer:i,typedBufferStride:c}=n.normalCompressed;K(i,s,F[0],F[1],F[2],c)}}class jt{constructor(){this._commonWriter=new gt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return dt.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:i,typedBufferStride:c}=n.normalCompressed;K(i,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],c)}{const{typedBuffer:i,typedBufferStride:c}=n.normal2Compressed;K(i,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],c)}}}const F=N(),q=new xt;function Xt(t){const n=Ht(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return rt.updateSettings(t.writerSettings),it.updateSettings(t.writerSettings),zt(n,rt,it)}function Ht(t,n,s,r){if(n){const p=nt(s,r,t.count);return new Qt(s,r,p,t)}const i=wt(t.buffer,t.stride/4,{originalIndices:s}),c=nt(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:c,vertices:bt.createView(i.buffer)}}class Qt{constructor(n,s,r,i){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=i}}const rt=new Ot,it=new jt,Yt=U().vec3f("position0").vec3f("position1"),te=U().vec3f("position0").vec3f("position1").u16("componentIndex");export{Yt as a,Xt as c,zt as d,Ht as f,te as g,bt as t};
