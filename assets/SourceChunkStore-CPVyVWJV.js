import{ir as re,al as Se,am as Fe,an as Pe,bC as ke,ak as Oe,g as ie,is as ze,it as Ce,iu as Ne,b1 as Nt,iv as $e,iw as Ae,U as Be,c as O,ar as gt,b as We,dC as De,az as Ge,S as w,em as Xe,fe as Ye,b2 as ne,cI as je,fg as Ee,cU as Wt,gF as Dt,gs as Re,a_ as Ue}from"./MapPage-aQQPudaX.js";import{Z as Mt}from"./FieldsIndex-jOyJIAg2.js";import{i as ae,n as ct,s as E}from"./memoryEstimations-Bjh7sHKS.js";import{e as x,s as oe,n as Ze,o as L}from"./OptimizedFeature-RQ48H3Jm.js";import{r as Le}from"./parquet-DOgJtZYW.js";import{l as st,d as qe,x as Je,w as Gt,r as Ve,a as Qe,N as He,b as Ke,T as ts,g as j,X as he,R as es}from"./featureConversionUtils-DbZVnUGV.js";import{m as q,r as Xt,i as Yt}from"./TimeOnly-DRwyFfxS.js";import{i as wt,a as Tt,u as yt}from"./quantizationUtils-BqTnQwJl.js";import{t as ss}from"./quickselect-QQC62dOK.js";import"./vec2f64-DCcDeJvX.js";import{g as ht}from"./FixedIntervalBinParameters-Byj4NDMF.js";import{o as jt}from"./definitions-HjZq38Cc.js";let $t=class{static fromOptimized(t,e,s=!1,r=!1,n=1){return new St().initialize(t,e,s,r,n)}static fromJSON(t,e=!1,s=!1){const[r,n]=Et(t);return new Pt().initialize(r,n,e,s,1)}static fromOptimizedCIM(t,e,s=!1,r=!1,n=1){return new Rt().initialize(t,e,s,r,n)}static fromJSONCIM(t,e=!1,s=!1,r=1){const[n,a]=Et(t);return new Ut().initialize(n,a,e,s,r)}static fromFeatureSetReader(t){const e=t.readGeometryForDisplay(),s=t.geometryType;return e&&s?this.fromOptimized(e,s):null}static fromFeatureSetReaderCIM(t){const e=t.readGeometryForDisplay(),s=t.geometryType;return e&&s?this.fromOptimizedCIM(e,s):null}static createEmptyOptimized(t,e=!1,s=!1,r=1){return new St().initialize(new x,t,e,s,r)}static createEmptyJSON(t,e=!1,s=!1){return new Pt().initialize([],t,e,s,1)}static createEmptyOptimizedCIM(t,e=!1,s=!1,r=1){return new Rt().initialize(new x,t,e,s,r)}static createEmptyJSONCIM(t,e=!1,s=!1,r=1){return new Ut().initialize([],t,e,s,r)}asJSON(){const t=re(this);return this.geometryType==="esriGeometryEnvelope"?{xmin:t[0][0][0],ymin:t[0][0][1],xmax:t[0][2][0],ymax:t[0][2][1]}:this.geometryType==="esriGeometryMultipoint"?{points:t.flat()}:this.geometryType==="esriGeometryPoint"?{x:t[0][0][0],y:t[0][0][1]}:this.geometryType==="esriGeometryPolygon"?{rings:t}:{paths:t}}getCurrentRingArea(){if(this.pathSize<3)return 0;let t,e,s=0;if(this.seekPathStart(),!this.nextPoint())return 0;t=this.x,e=this.y;const r=t,n=e;for(;this.nextPoint();)s+=(t-this.x)*(e+this.y),t=this.x,e=this.y;return s+=(t-r)*(e+n),-.5*s}invertY(){this.yFactor*=-1}},St=class Ft extends $t{constructor(){super(...arguments),this._end=-1}initialize(t,e,s,r,n){return this.hasZ=s,this.hasM=r,this.geometryType=e,this._stride=2+Number(s)+Number(r),this._geometry=t,this._pathIndex=-1,this._pathOffset=0,this._pointOffset=-this._stride,this._end=-1,this.yFactor=n,this}reset(){this.initialize(this._geometry,this.geometryType,this.hasZ,this.hasM,this.yFactor)}seekPath(t){if(t>=0&&t<this.totalSize){if(this._pathIndex<t)for(;this._pathIndex<t&&this.nextPath(););else if(this._pathIndex>t)for(;this._pathIndex>t&&this.prevPath(););return!0}return!1}seekPathStart(){this._pointOffset=this._pathOffset-this._stride}seekPathEnd(){this._pointOffset=this._end}seekInPath(t){const e=this._pathOffset+t*this._stride;return e>=0&&e<this._end&&(this._pointOffset=e,!0)}nextPoint(){return(this._pointOffset+=this._stride)<this._end}prevPoint(){return(this._pointOffset-=this._stride)>=this._pathOffset}nextPath(){return!(this.pathIndex>=this.totalSize-1)&&(this._pathIndex>=0&&(this._pathOffset+=this._stride*this.pathSize),this._pathIndex++,this._pointOffset=this._pathOffset-this._stride,this._end=this._pointOffset+this._stride+this._stride*this.pathSize,!0)}prevPath(){return!(this.pathIndex<=0)&&(this._pathIndex--,this._end=this._pathOffset,this._pathOffset-=this._stride*this.pathSize,this._pointOffset=this._pathOffset-this._stride,!0)}getCurrentPath(){const t=this._end,e=this._geometry.coords,s=this._pathOffset;return new Ft().initialize(new x([this.pathSize],e.slice(s,t)),this.geometryType,this.hasZ,this.hasM,this.yFactor)}pathLength(){const t=this._end,e=this._stride,s=this._geometry.coords;let r=0;for(let n=this._pathOffset+e;n<t;n+=e){const a=s[n-e],o=s[n-e+1],h=s[n]-a,u=s[n+1]-o;r+=Math.sqrt(h*h+u*u)}return r}startPath(){this._geometry.lengths.push(0)}pushPath(t){this.startPath(),this.pushPoints(t)}pushPoint(t){for(let e=0;e<this._stride;++e)this._geometry.coords.push(t[e]);this._geometry.lengths[this.totalSize-1]++}pushXY(t,e){this._geometry.coords.push(t,e),this._geometry.lengths[this.totalSize-1]++}pushPoints(t){for(const e of t)for(let s=0;s<this._stride;++s)this._geometry.coords.push(e[s]);this._geometry.lengths[this.totalSize-1]+=t.length}pushCursor(t){const e=t.asOptimized();this._geometry.coords.push(...e.coords),this._geometry.lengths.push(...e.lengths)}asOptimized(){const t=this._geometry.clone();if(this.yFactor!==1)for(let e=1;e<t.coords.length;e+=this._stride)t.coords[e]*=this.yFactor;return this.geometryType==="esriGeometryPoint"&&(t.lengths.length=0),t}isClosed(){const t=this._geometry.coords,e=this._pathOffset,s=this._end-this._stride;for(let r=0;r<this._stride;r++)if(t[e+r]!==t[s+r])return!1;return!0}clone(){return new Ft().initialize(this._geometry.clone(),this.geometryType,this.hasZ,this.hasM,this.yFactor)}get totalPoints(){return this._geometry.isPoint?1:this._geometry.lengths.reduce((t,e)=>t+e)}get pathSize(){const{lengths:t}=this._geometry;return this._geometry.isPoint?1:this._pathIndex<0||this._pathIndex>t.length-1?0:t[this._pathIndex]}get totalSize(){return this._geometry.isPoint?1:this._geometry.lengths.length}get x(){return this._geometry.coords[this._pointOffset]}set x(t){this._geometry.coords[this._pointOffset]=t}get y(){return this.yFactor*this._geometry.coords[this._pointOffset+1]}set y(t){this._geometry.coords[this._pointOffset+1]=this.yFactor*t}get z(){return this._geometry.coords[this._pointOffset+2]}set z(t){this._geometry.coords[this._pointOffset+2]=t}get m(){const t=this.hasZ?3:2;return this._geometry.coords[this._pointOffset+t]}set m(t){this._geometry.coords[this._pointOffset+3]=t}get pathIndex(){return this._pathIndex}get _coordIndex(){return this._pointOffset/this._stride}};function rs(i){const t=[i.x,i.y];return i.z&&t.push(i.z),i.m&&t.push(i.m),t}function Et(i){return Se(i)?[i.rings,"esriGeometryPolygon"]:Fe(i)?[i.paths,"esriGeometryPolyline"]:Pe(i)?[[i.points],"esriGeometryMultipoint"]:ke(i)?[[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]],"esriGeometryEnvelope"]:Oe(i)?[[[rs(i)]],"esriGeometryPoint"]:[[],"esriGeometryPolyline"]}let Pt=class kt extends $t{initialize(t,e,s,r,n){return this._paths=t,this.geometryType=e,this.hasZ=s,this.hasM=r,this._pathIndex=this._pointIndex=-1,this.yFactor=n,this._mIndex=this.hasZ?3:2,this}reset(){this._pathIndex=this._pointIndex=-1}seekPath(t){return this._pathIndex=t,this._pointIndex=-1,t>=0&&t<this.totalSize&&(this._currentPath=this._paths[t],!0)}seekPathStart(){this._pointIndex=-1}seekPathEnd(){this._pointIndex=this._currentPath.length}seekInPath(t){return t>=0&&t<this._currentPath.length&&(this._pointIndex=t,this._currentPoint=this._currentPath[this._pointIndex],!0)}nextPoint(){return this._currentPoint=this._currentPath[++this._pointIndex],this._pointIndex<this._currentPath.length}prevPoint(){return this._currentPoint=this._currentPath[--this._pointIndex],this._pointIndex>=0}nextPath(){return this._pointIndex=-1,this._currentPath=this._paths[++this._pathIndex],this._pathIndex<this.totalSize}prevPath(){return this.pathIndex>0&&(this._pointIndex=-1,this._pathIndex--,this._currentPath=this._paths[this._pathIndex],!0)}pathLength(){const t=this._currentPath.length,e=this._currentPath;let s=0;for(let r=1;r<t;r++){const n=e[r-1],a=e[r],o=n[0],h=n[1],u=a[0]-o,d=a[1]-h;s+=Math.sqrt(u*u+d*d)}return s}startPath(){this._paths.push([])}getCurrentPath(){return new kt().initialize([this._currentPath],this.geometryType,this.hasZ,this.hasM,this.yFactor)}pushPath(t){this._paths.push(t)}pushPoint(t){this._paths[this.totalSize-1].push(t)}pushXY(t,e){this._paths[this.totalSize-1].push([t,e])}pushPoints(t){this._paths[this.totalSize-1].push(...t)}pushCursor(t){const e=re(t);for(const s of e)this.pushPath(s)}asOptimized(){const t=new x;if(this.geometryType==="esriGeometryPoint")t.coords.push(...this._paths[0][0]),t.lengths.length=0;else for(const e of this._paths){for(const s of e)t.coords.push(s[0]),t.coords.push(s[1]*this.yFactor),this.hasZ&&t.coords.push(s[2]),this.hasM&&t.coords.push(s[this._mIndex]);t.lengths.push(e.length)}return t}isClosed(){const t=this._currentPath[0],e=this._currentPath[this._currentPath.length-1];for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}clone(){return new kt().initialize(ie(this._paths),this.geometryType,this.hasZ,this.hasM,this.yFactor)}get totalPoints(){return this._paths.map(t=>t.length).reduce((t,e)=>t+e)}get pathSize(){return this._pathIndex<0||this._pathIndex>this.totalSize-1?-1:this._paths[this._pathIndex].length}get totalSize(){return this._paths.length}get x(){return this._currentPoint[0]}set x(t){this._currentPoint[0]=t}get y(){return this.yFactor*this._currentPoint[1]}set y(t){this._currentPoint[1]=this.yFactor*t}get z(){return this._currentPoint[2]}set z(t){this._currentPoint[2]=t}get m(){return this._currentPoint[this._mIndex]}set m(t){this._currentPoint[this._mIndex]=t}get pathIndex(){return this._pathIndex}};const J=4,V=1;let Rt=class ue extends St{initialize(t,e,s,r,n){return super.initialize(t,e,s,r,n),this._controlPoints||(this._controlPoints=this._controlPoints=new Array(this.totalSize).fill(void 0).map(a=>new Set)),this}startPath(){super.startPath(),this._controlPoints.push(new Set)}clone(){const t=new ue().initialize(this._geometry.clone(),this.geometryType,this.hasZ,this.hasM,this.yFactor);return t._controlPoints=this._controlPoints,t}setControlPoint(){this._controlPoints[this.pathIndex].add(this._coordIndex)}getControlPoint(){return this._controlPoints[this.pathIndex].has(this._coordIndex)}setControlPointAt(t){this._controlPoints[this.pathIndex].add(t)}getControlPointAt(t){return this._controlPoints[this.pathIndex].has(t)}},Ut=class de extends Pt{initialize(t,e,s,r,n){return super.initialize(t,e,s,r,n)}clone(){return new de().initialize(ie(this._paths),this.geometryType,this.hasZ,this.hasM,this.yFactor)}setControlPoint(){this._paths[this.pathIndex][this._pointIndex][J]=V}getControlPoint(){return this._paths[this.pathIndex][this._pointIndex][J]===V}setControlPointAt(t){this._paths[this.pathIndex][t][J]=V}getControlPointAt(t){return this._paths[this.pathIndex][t][J]===V}};const is=100*222045e-21;function ns(i){if(i.totalSize===0)return null;const t=ze(i);if(!t)return null;const e=4*(Math.abs(t[0])+Math.abs(t[2])+Math.abs(t[1])+Math.abs(t[3])+1)*is;let s=0,r=0;i.reset();for(let I=0;i.nextPath();I++){const b=i.getCurrentRingArea();b>r&&(r=b,s=I)}if(i.seekPath(s),i.pathSize===0)return null;i.seekPathStart();const n=Ce(i);if(Math.abs(r)<=2*e*e)return[(n[0]+n[2])/2,(n[1]+n[3])/2];i.seekPathStart();const a=Ne(i,Nt());if(a===null)return null;if(i.totalPoints<4)return a;const o=[[NaN,NaN],[NaN,NaN],[NaN,NaN],[NaN,NaN]],h=[NaN,NaN,NaN,NaN],u=[NaN,NaN,NaN,NaN];let d=!1,l=D(a,i,!0);l.distance===0&&(d=!0,o[0][0]=a[0],o[0][1]=a[1],l=D(a,i,!1)),h[0]=l.distance,u[0]=0;const _=[NaN,NaN];let c=!1,f=.25,p=-1,m=NaN;do if(m=NaN,o[1]=xt(i,It(n[0],n[2],f),e,t),isNaN(o[1][0])||isNaN(o[1][1])||(l=D(o[1],i,!1),m=l.distance),!isNaN(m)&&m>e&&rt(o[1],i))c=!0,h[1]=m,u[1]=P(o[1],a);else if(!isNaN(m)&&m>p&&(p=m,_[0]=o[1][0],_[1]=o[1][1]),f-=.01,f<.1){if(!(p>=0))break;c=!0,h[1]=p,o[1][0]=_[0],o[1][1]=_[1],u[1]=P(o[1],a)}while(!c);c=!1,f=.5,p=-1;let y=.01,v=1;do if(m=NaN,o[2]=xt(i,It(n[0],n[2],f),e,t),isNaN(o[2][0])||isNaN(o[2][1])||(l=D(o[2],i,!1),m=l.distance),!isNaN(m)&&m>e&&rt(o[2],i))c=!0,h[2]=m,u[2]=P(o[2],a);else if(!isNaN(m)&&m>p)p=m,_[0]=o[2][0],_[1]=o[2][1];else if(m>p&&(p=m,_[0]=o[2][0],_[1]=o[2][1]),f=.5+y*v,y+=.01,v*=-1,f<.3||f>.7){if(!(p>=0))break;c=!0,h[2]=p,o[2][0]=_[0],o[2][1]=_[1],u[2]=P(o[2],a)}while(!c);c=!1,f=.75,p=-1;do if(m=NaN,o[3]=xt(i,It(n[0],n[2],f),e,t),isNaN(o[3][0])||isNaN(o[3][1])||(l=D(o[3],i,!1),m=l.distance),!isNaN(m)&&m>e&&rt(o[3],i))c=!0,h[3]=m,u[3]=P(o[3],a);else if(m>p&&(p=m,_[0]=o[3][0],_[1]=o[3][1]),f+=.01,f>.9){if(!(p>=0))break;c=!0,h[3]=p,o[3][0]=_[0],o[3][1]=_[1],u[3]=P(o[3],a)}while(!c);const g=[0,1,2,3],T=d?0:1;let C;for(let I=T;I<4;I++)for(let b=T;b<3;b++){const Z=u[b],F=u[b+1];hs(Z,F)>0&&(C=g[b],g[b]=g[b+1],g[b+1]=C,u[b]=F,u[b+1]=Z)}let R=T,U=0,S=0;for(let I=T;I<4;I++){switch(I){case 0:S=2*h[g[I]];break;case 1:S=1.66666666*h[g[I]];break;case 2:S=1.33333333*h[g[I]];break;case 3:S=h[g[I]]}S>U&&(U=S,R=g[I])}return o[R]}function rt(i,t){let e,s,r,n,a=0;for(t.reset();t.nextPath()&&t.nextPoint();)for(e=t.x,s=t.y;t.nextPoint();e=r,s=n)r=t.x,n=t.y,s>i[1]!=n>i[1]&&((r-e)*(i[1]-s)-(n-s)*(i[0]-e)>0?a++:a--);return a!==0}function D(i,t,e){if(e&&rt(i,t))return{coord:i,distance:0};let s=1/0,r=0,n=0,a=[0,0],o=[0,0];const h=[0,0];for(t.reset();t.nextPath()&&t.nextPoint();)if(!(t.pathSize<2))for(a[0]=t.x,a[1]=t.y;t.nextPoint();a=o){o=[t.x,t.y],$e(h,i,a,o);const u=P(i,h);u<s&&(s=u,r=h[0],n=h[1])}return{coord:[r,n],distance:Math.sqrt(s)}}function xt(i,t,e,s){const r=[t,0];let n=1/0,a=1/0,o=!1,h=!1;const u=[[t,s[1]-1],[t,s[3]+1]],d=[0,0],l=[0,0],_=[0,0],c=[[0,0],[0,0]],f=Nt();for(i.reset();i.nextPath()&&i.nextPoint();)if(!(i.pathSize<2))for(c[0][0]=i.x,c[0][1]=i.y;i.nextPoint();c[0][0]=c[1][0],c[0][1]=c[1][1]){if(c[1][0]=i.x,c[1][1]=i.y,as(f,c)===null||(l[0]=u[0][0],l[1]=u[0][1],_[0]=u[1][0],_[1]=u[1][1],os(f,l,_)===0)||!Ae(u[0],u[1],c[0],c[1],d))continue;const p=d[1];n>a?p<n&&(n=p,o=!0):p<a&&(a=p,h=!0)}return o&&h?r[1]=(n+a)/2:r[0]=r[1]=NaN,r}function as(i,t){if(t.length<2)return null;i||(i=Nt());const[e,s]=t[0],[r,n]=t[1];return i[0]=Math.min(e,r),i[1]=Math.min(s,n),i[2]=Math.max(e,r),i[3]=Math.max(s,n),i}const Q=1,H=4,Zt=3,Lt=12;function os(i,t,e){let s=M(t,i),r=M(e,i);const n=i[0],a=i[1],o=i[2],h=i[3];if(s&r)return 0;if(!(s|r))return 4;const u=(s?1:0)|(r?2:0);do{const d=e[0]-t[0],l=e[1]-t[1];if(d>l)s&Zt?(s&Q?(t[1]+=l*(n-t[0])/d,t[0]=n):(t[1]+=l*(o-t[0])/d,t[0]=o),s=M(t,i)):r&Zt?(r&Q?(e[1]+=l*(n-e[0])/d,e[0]=n):(e[1]+=l*(o-e[0])/d,e[0]=o),r=M(e,i)):s?(s&H?(t[0]+=d*(a-t[1])/l,t[1]=a):(t[0]+=d*(h-t[1])/l,t[1]=h),s=M(t,i)):(r&H?(e[0]+=d*(a-e[1])/l,e[1]=a):(e[0]+=d*(h-e[1])/l,e[1]=h),r=M(e,i));else if(s&Lt?(s&H?(t[0]+=d*(a-t[1])/l,t[1]=a):(t[0]+=d*(h-t[1])/l,t[1]=h),s=M(t,i)):r&Lt?(r&H?(e[0]+=d*(a-e[1])/l,e[1]=a):(e[0]+=d*(h-e[1])/l,e[1]=h),r=M(e,i)):s?(s&Q?(t[1]+=l*(n-t[0])/d,t[0]=n):(t[1]+=l*(o-t[0])/d,t[0]=o),s=M(t,i)):(r&Q?(e[1]+=l*(n-e[0])/d,e[0]=n):(e[1]+=l*(o-e[0])/d,e[0]=o),r=M(e,i)),s&r)return 0}while(s|r);return u}function M(i,t){return(i[0]<t[0]?1:0)|(i[0]>t[2]?1:0)<<1|(i[1]<t[1]?1:0)<<2|(i[1]>t[3]?1:0)<<3}function It(i,t,e){return i+(t-i)*e}function P(i,t){return(i[0]-t[0])*(i[0]-t[0])+(i[1]-t[1])*(i[1]-t[1])}function hs(i,t){if(i<t)return-1;if(i>t)return 1;if(i===t)return 0;const e=isNaN(i),s=isNaN(t);return e<s?-1:e>s?1:0}function nr(i,t,e){if(i==null)return null;const s=t.readArcadeFeature();t.contextTimeZone=e.$view?.timeZone;try{return i.evaluate(s,e)}catch(r){return Be.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",r),null}}function le(i){return i==null||i===1/0||i===-1/0||typeof i=="number"&&isNaN(i)}function ar(i,t,e,s){if(i==null)return s??null;const r=t.readArcadeFeature();t.contextTimeZone=e.$view?.timeZone;const n=i.evaluate(r,e);return le(n)?s??null:n}let us=class it{static fromBuffer(t,e){return new it(t,e)}static create(t,e=4294967295){const s=new Uint32Array(Math.ceil(t/32));return new it(s,e)}constructor(t,e){this._mask=0,this._buf=t,this._mask=e}_getIndex(t){return Math.floor(t/32)}get usedMemory(){return ae(this._buf)}has(t){const e=this._mask&t;return!!(this._buf[this._getIndex(e)]&1<<e%32)}hasRange(t,e){let s=t,r=e;for(;s%32&&s!==r;){if(this.has(s))return!0;s++}for(;r%32&&s!==r;){if(this.has(s))return!0;r--}if(s===r)return!1;for(let n=s/32;n!==r/32;n++)if(this._buf[n])return!0;return!1}set(t){const e=this._mask&t,s=this._getIndex(e),r=1<<e%32;this._buf[s]|=r}setRange(t,e){let s=t,r=e;for(;s%32&&s!==r;)this.set(s++);for(;r%32&&s!==r;)this.set(r--);if(s!==r)for(let n=s/32;n!==r/32;n++)this._buf[n]=4294967295}unset(t){const e=this._mask&t,s=this._getIndex(e),r=1<<e%32;this._buf[s]&=4294967295^r}resize(t){const e=this._buf,s=new Uint32Array(Math.ceil(t/32));s.set(e),this._buf=s}or(t){for(let e=0;e<this._buf.length;e++)this._buf[e]|=t._buf[e];return this}and(t){for(let e=0;e<this._buf.length;e++)this._buf[e]&=t._buf[e];return this}xor(t){for(let e=0;e<this._buf.length;e++)this._buf[e]^=t._buf[e];return this}ior(t){for(let e=0;e<this._buf.length;e++)this._buf[e]|=~t._buf[e];return this}iand(t){for(let e=0;e<this._buf.length;e++)this._buf[e]&=~t._buf[e];return this}ixor(t){for(let e=0;e<this._buf.length;e++)this._buf[e]^=~t._buf[e];return this}any(){for(let t=0;t<this._buf.length;t++)if(this._buf[t])return!0;return!1}copy(t){for(let e=0;e<this._buf.length;e++)this._buf[e]=t._buf[e];return this}clone(){return new it(this._buf.slice(),this._mask)}clear(){for(let t=0;t<this._buf.length;t++)this._buf[t]=0;return this}forEachSet(t){for(let e=0;e<this._buf.length;e++){let s=this._buf[e],r=32*e;if(s)for(;s;)1&s&&t(r),s>>>=1,r++}}countSet(){let t=0;return this.forEachSet(e=>{t++}),t}},ds=class{constructor(t){this._valid=us.create(t),this._data=new Array(t)}get usedMemory(){let t=this._valid.usedMemory;if(this._data.length>0){const e=typeof this._data[0]=="string"?64:ct;t+=this._data.length*e}return t}has(t){return this._valid.has(t)}set(t,e){this._valid.set(t),this._data[t]=e}get(t){return this._data[t]}};const ft=O("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],ls=ft[0],cs=ft[1],fs=ft[2],_s=ft[3],At=O("featurelayer-simplify-payload-size-factors")??[1,2,4],ms=At[0],ps=At[1],gs=At[2],ys=O("featurelayer-simplify-mobile-factor")??2,xs=O("esri-mobile"),qt=4294967295;function Is(i,t,e){if(!(i.length>t))for(;i.length<=t;)i.push(e)}class Bt{constructor(t){this.metadata=t,this.type="FeatureSetReader",this._overrides=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}destroy(){}[Symbol.dispose](){this.destroy()}getAreaSimplificationThreshold(t,e){let s=1;const r=xs?ys:1;e>4e6?s=gs*r:e>1e6?s=ps*r:e>5e5?s=ms*r:e>1e5&&(s=r);let n=0;return t>4e3?n=_s*s:t>2e3?n=fs*s:t>100?n=cs:t>15&&(n=ls),n}getBounds(t){Is(this._boundsBuffer,4*this.getIndex()+4,0);const e=this.getBoundsXMin();if(e===qt||!isFinite(e))return!1;if(this.getBoundsXMin()===0){const o=this.readGeometryWorldSpace();if(o?.isPoint&&o.coords[0]===0&&o.coords[1]===0)return gt(t,0,0,0,0),!0;if(!o)return this.setBoundsXMin(qt),!1;let h=1/0,u=1/0,d=-1/0,l=-1/0;return o.forEachVertex((_,c)=>{h=Math.min(h,_),u=Math.min(u,c),d=Math.max(d,_),l=Math.max(l,c)}),this.setBoundsXMin(h),this.setBoundsYMin(u),this.setBoundsXMax(d),this.setBoundsYMax(l),gt(t,h,u,d,l),!0}const s=this.getBoundsXMin(),r=this.getBoundsYMin(),n=this.getBoundsXMax(),a=this.getBoundsYMax();return gt(t,s,r,n,a),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(t){this._boundsBuffer[4*this.getIndex()]=t}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(t){this._boundsBuffer[4*this.getIndex()+1]=t}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(t){this._boundsBuffer[4*this.getIndex()+2]=t}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(t){this._boundsBuffer[4*this.getIndex()+3]=t}readAttributeAsTimestamp(t){const e=this.readAttribute(t);return typeof e=="string"?new Date(e).getTime():typeof e=="number"||e==null?e:null}readAttribute(t,e=!1){const s=this._readAttribute(t,e);if(s!==void 0)return s;for(const r of this._joined){r.setIndex(this.getIndex());const n=r._readAttribute(t,e);if(n!==void 0)return n}}readAttributes(){const t=this._readAttributes();for(const e of this._joined){e.setIndex(this.getIndex());const s=e._readAttributes();for(const r of Object.keys(s))t[r]=s[r]}return t}joinAttributes(t){this._joined.push(t)}registerOverrides(t){this._overrides=t}withoutOverrides(){const t=this.copy();return t._overrides=null,t}readOptimizedFeatureWorldSpace(){const t=this.readGeometryWorldSpace(),e=this.readAttributes(),s=this.readCentroidWorldSpace();return new oe(t,e,s,this.getObjectId(),this.getDisplayId())}readLegacyFeatureForDisplay(){const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(t&&{x:t.coords[0],y:t.coords[1]})??null}}readLegacyFeatureWorldSpace(){const t=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:(t&&{x:t.coords[0],y:t.coords[1]})??null}}readLegacyGeometryForDisplay(){const t=this.readGeometryForDisplay();return st(t,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){const t=this._readX(),e=this.getInTransform();return e==null?t:t*e.scale[0]+e.translate[0]}readYWorldSpace(){const t=this._readY(),e=this.getInTransform();return e==null?t:e.translate[1]-t*e.scale[1]}readGeometryForDisplay(){const t=this._readGeometryDeltaDecoded(!0);if(!t){const e=this._createDeltaQuantizedGeometryFromServerCentroid();return e?e.deltaDecode():null}return t}readGeometryForDisplayTransformed(t){let e=this.readGeometryForDisplay();if(e&&this.metadata.geometryType==="esriGeometryPolyline"&&(e=qe(new x,e,this.hasZ,this.hasM,this.metadata.geometryType,t.scale[0])),e&&(e=Je(e,t,this.metadata.geometryType,this.hasZ,this.hasM)),!e){const s=this.readCentroidForDisplay();if(!s)return null;const r=wt(t,s.coords[0]),n=Tt(t,s.coords[1]);return this._createDeltaQuantizedExtrudedGeometry(r,n).deltaDecode()}return e}readGeometryWorldSpace(){let t=this._readGeometry();if(t||(t=this._createDeltaQuantizedGeometryFromServerCentroid()),!t)return null;const e=t.clone(),s=this.getInTransform();return s!=null&&Gt(e,e,this.hasZ,this.hasM,s),e}readCentroidForDisplay(){const t=this.readGeometryForDisplay();return t?this._computeDisplayCentroid(t):this._readServerCentroid()}readCentroidWorldSpace(){const t=this.readGeometryForDisplay(),e=t?this._computeDisplayCentroid(t):this._readServerCentroid();if(!e)return null;const s=e.clone(),r=this.getInTransform();return r!=null&&Gt(s,s,this.hasZ,this.hasM,r),s}setCache(t){let e=this._caches.get(t);e==null&&(e=new ds(this.getSize()),this._caches.set(t,e)),this._activeCache=e}setCachedValue(t){this._activeCache.set(this.getIndex(),t)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}get underlyingMemory(){let t=0;t+=ae(this._boundsBuffer);for(const e of this._caches.values())t+=e.usedMemory;return t}_readGeometryDeltaDecoded(t){const e=this._readGeometry(t);return this.geometryType!=="esriGeometryPoint"&&e&&this.getInTransform()?e.deltaDecode():e}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(t){this._contextTimeZone=t}readArcadeFeature(){return this}hasField(t){return this.fields.has(t)||this._joined.some(e=>e.hasField(t))}geometry(){const t=this.readGeometryWorldSpace(),e=st(t,this.geometryType,this.hasZ,this.hasM),s=We(e);if(s){if(!this.metadata.outSpatialReference)throw new Error("InternalError: Expected spatial reference to be defined");s.spatialReference=this.metadata.outSpatialReference}return s}autocastArcadeDate(t,e){return e&&e instanceof Date?this.isUnknownDateTimeField(t)?q.unknownDateJSToArcadeDate(e):q.dateJSAndZoneToArcadeDate(e,this.contextTimeZone??De):e}isUnknownDateTimeField(t){return this.metadata.fieldsIndex.getTimeZone(t)===Ge}field(t){let e=this.fields.get(t);if(e)switch(e.type){case"date-only":case"esriFieldTypeDateOnly":return Yt.fromReader(this.readAttribute(t,!1));case"time-only":case"esriFieldTypeTimeOnly":return Xt.fromReader(this.readAttribute(t,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return q.fromReaderAsTimeStampOffset(this.readAttribute(t,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(t,this.readAttribute(t,!0));default:return this.readAttribute(t,!1)}for(const s of this._joined)if(s.setIndex(this.getIndex()),e=s.fields.get(t),e)switch(e.type){case"date-only":case"esriFieldTypeDateOnly":return Yt.fromReader(s._readAttribute(t,!1));case"time-only":case"esriFieldTypeTimeOnly":return Xt.fromReader(s._readAttribute(t,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return q.fromReaderAsTimeStampOffset(s._readAttribute(t,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(t,s._readAttribute(t,!0));default:return this.readAttribute(t,!1)}throw new Error(`Field ${t} does not exist`)}setField(t,e){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.fields.fields.map(t=>t.name)}isEmpty(){return this.fields.fields.length<=0&&this.geometry()==null}castToText(t=!1){if(!t)return JSON.stringify(this.readLegacyFeatureForDisplay());const e=this.readLegacyFeatureForDisplay();if(!e)return JSON.stringify(null);const s={geometry:e.geometry,attributes:{...e.attributes}};for(const r in s.attributes){const n=s.attributes[r];n instanceof Date&&(s.attributes[r]=n.getTime())}return JSON.stringify(s)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(t=null){return{attributes:this._readAttributes(),geometry:t?.keepGeometryType===!0?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(t=null,e=null){return Promise.resolve(this.castAsJson(e))}_getExists(){if(this._overrides){const t=this.getObjectId();return!this._overrides.hasOverride(t)}return!0}_computeDisplayCentroid(t){if(this.getInTransform()==null)return Ze(new x,t,this.hasM,this.hasZ);const e=$t.fromOptimized(t,this.geometryType);e.yFactor*=-1;const s=ns(e);return s?(s[1]*=-1,new x([],s)):null}copyInto(t){t._joined=this._joined,t._overrides=this._overrides,t._objectIdToIndex=this._objectIdToIndex,t._boundsBuffer=this._boundsBuffer,t._activeCache=this._activeCache,t._caches=this._caches,t._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){const t=this.readGeometryWorldSpace();return st(t,this.geometryType,!1,!1)}_createDeltaQuantizedGeometryFromServerCentroid(){const t=this._readServerCentroid();if(!t)return null;const[e,s]=t.coords;return this._createDeltaQuantizedExtrudedGeometry(e,s)}_createDeltaQuantizedExtrudedGeometry(t,e){return this.geometryType==="esriGeometryPolyline"?this._createDeltaQuantizedExtrudedLine(t,e):this._createDeltaQuantizedExtrudedQuad(t,e)}_createDeltaQuantizedExtrudedQuad(t,e){return new x([5],[t-1,e,1,-1,1,1,-1,1,-1,-1])}_createDeltaQuantizedExtrudedLine(t,e){return new x([2],[t-1,e+1,1,-1])}}let ce=class k extends Bt{static fromFeatures(t,e){const{geometryType:s}=e,r=Ve([],t,s,!1,!1,e.featureIdInfo);for(let n=0;n<r.length;n++)r[n].displayId=t[n].displayId;return k.fromOptimizedFeatures(r,e)}static fromFeatureSet(t,e){const s=Qe(t,e.featureIdInfo);return k.fromOptimizedFeatureSet(s,e)}static fromOptimizedFeatureSet(t,e){const s=k.fromOptimizedFeatures(t.features,e);return s._exceededTransferLimit=t.exceededTransferLimit,s._transform=t.transform,s._fieldsIndex=new Mt(t.fields),s}static fromOptimizedFeatures(t,e,s){const r=new k(t,e);return r._fieldsIndex=e.fieldsIndex,r._transform=s,r}static empty(t){return new k([],t)}constructor(t,e){super(e),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=e.geometryType,this._features=t}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}get usedMemory(){return this._current.usedMemory}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let t="";for(const e in this._current.attributes)t+=this._current.attributes[e];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t}copy(){const t=new k(this._features,this.metadata);return this.copyInto(t),t}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return L(this._current)?He(this._current.geometry,2):0}_readX(){return L(this._current)?this._current.geometry.coords[0]:0}_readY(){return L(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return L(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(t,e){if(!this._fieldsIndex){const n=this._current.attributes[t];if(n!==void 0)return n;const a=t.toLowerCase();for(const o in this._current.attributes)if(o.toLowerCase()===a)return this._current.attributes[o];return}const s=this._fieldsIndex.get(t);if(!s)return;const r=this._current.attributes[s.name];return r==null?r:e&&this.fields.isDateField(t)?new Date(r):r}_readAttributes(){return this._current.attributes}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._fieldsIndex=this._fieldsIndex}};var z;let bs=(z=class{getObjectId(t){return t.getObjectId()}getAttributes(t){return t.readAttributes()}getAttribute(t,e){return t.readAttribute(e)}getAttributeAsTimestamp(t,e){return t.readAttributeAsTimestamp(e)}cloneWithGeometry(t,e){const s=t.readAttributes(),r=new oe(e,s,null,t.getObjectId(),t.getDisplayId()),n=ce.fromOptimizedFeatures([r],t.metadata);return n.setIndex(0),n}getGeometry(t){return t.readGeometryWorldSpace()}getCentroid(t,e){return t.readCentroidForDisplay()}},z.Shared=new z,z),hr=class nt{static minimal(t,e,s=[]){return new nt({geometryType:t,fieldsIndex:new Mt(s).toJSON(),featureIdInfo:{type:"object-id",fieldName:e},subtypes:null,subtypeField:null,types:null,globalIdField:null,spatialReference:null,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null})}static createFeature(t){return new nt(t)}constructor(t){let e;this._options=t,this._fieldsIndex=Mt.fromJSON(t.fieldsIndex),t.spatialReference&&(t.spatialReference instanceof w?this._spatialReference=t.spatialReference:this._spatialReference=w.fromJSON(t.spatialReference)),t.outSpatialReference&&(t.outSpatialReference instanceof w?this._outSpatialReference=t.outSpatialReference:this._outSpatialReference=w.fromJSON(t.outSpatialReference)),t.featureIdInfo.type==="object-id"&&(e=t.featureIdInfo.fieldName),this._arcadeSchema={fields:this.fieldsIndex.fields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,objectIdField:e,globalIdField:this._options.globalIdField,spatialReference:this._spatialReference,timeInfo:this._options.timeInfo,typeIdField:this._options.typeIdField??void 0,types:this._options.types??void 0,subtypeField:this._options.subtypeField,subtypes:this._options.subtypes??void 0,datesInUnknownTimezone:this._options.timeReferenceUnknownClient??void 0,dateFieldsTimeZone:this._options.dateFieldsTimeZone??void 0}}get fieldsIndex(){return this._fieldsIndex}get geometryType(){return this._options.geometryType==="esriGeometryMultiPatch"?"esriGeometryPolygon":this._options.geometryType}get serviceGeometryType(){return this._options.geometryType}get subtypeField(){return this._options.subtypeField}get timeInfo(){return this._options.timeInfo}get featureIdInfo(){return this._options.featureIdInfo}get globalIdField(){return this._options.globalIdField}get arcadeSchema(){return this._arcadeSchema}get spatialReference(){return this._spatialReference}get outSpatialReference(){return this._outSpatialReference}get timeReferenceUnknownClient(){return this._options.timeReferenceUnknownClient}weakCloneWithAdditionalFields(t){return new nt({fieldsIndex:{fields:[...this._fieldsIndex.fields,...t],timeZoneByFieldName:null},geometryType:this.geometryType,globalIdField:this.globalIdField,featureIdInfo:this.featureIdInfo,spatialReference:this.spatialReference,outSpatialReference:this.outSpatialReference,subtypeField:this.subtypeField,subtypes:this._options.subtypes,timeInfo:this.timeInfo,timeReferenceUnknownClient:this.timeReferenceUnknownClient,dateFieldsTimeZone:this._options.dateFieldsTimeZone,typeIdField:this._options.typeIdField,types:this._options.types})}},fe=class{constructor(t){this._statistics=t}get statistics(){return this._statistics}};const Jt=Math.PI/180;let Ot=class zt{static create(t){return new zt(t.map(e=>vs(e)))}constructor(t){this._statistics=t}static get estimatedMemory(){return E+4*E}values(){return this._statistics.values()}insert(t,e){for(const s of this._statistics)s.insert(t,e)}merge(t){for(let e=0;e<this._statistics.length;e++){const s=this._statistics[e],r=t._statistics[e];if(s.field.name!==r.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");s.merge(r)}}clone(){return new zt(this._statistics.map(t=>t.clone()))}};function vs(i){switch(i.statisticType){case"min":return new Ms(i);case"max":return new ws(i);case"avg":return new Ss(i);case"avg_angle":return new Fs(i);case"sum":case"count":return new Ts(i);case"mode":return new Ps(i)}}let B=class{constructor(t){this.field=t}insert(t,e){if(!this.field.computed)return;const s=this.field.computed.read(t,e);le(s)||this._insertValue(s)}},Ms=class _e extends B{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(t){this.value=Math.min(this.value,t)}merge(t){this.value=Math.min(this.value,t.value)}clone(){const t=new _e(this.field);return t.value=this.value,t}},ws=class me extends B{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(t){this.value=Math.max(this.value,t)}merge(t){this.value=Math.max(this.value,t.value)}clone(){const t=new me(this.field);return t.value=this.value,t}},Ts=class pe extends B{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(t){this.value+=t}merge(t){this.value+=t.value}clone(){const t=new pe(this.field);return t.value=this.value,t}},Ss=class ge extends B{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(t){this._total+=t,this._count+=1}merge(t){this._total+=t._total,this._count+=t._count}clone(){const t=new ge(this.field);return t._total=this._total,t._count=this._count,t}},Fs=class ye extends B{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const t=this._x/this._count,e=this._y/this._count,s=180/Math.PI;return Math.atan2(e,t)*s}_insertValue(t){this._x=this._x+Math.cos(t*Jt),this._y=this._y+Math.sin(t*Jt),this._count+=1}merge(t){this._x+=t._x,this._y+=t._y,this._count+=t._count}clone(){const t=new ye(this.field);return t._x=this._x,t._y=this._y,t._count=this._count,t}},Ps=class xe extends B{constructor(){super(...arguments),this._frequencies=new Map}get value(){let t,e=0;for(const[s,r]of this._frequencies.entries())r>e&&(e=r,t=s);return t}_insertValue(t){const e=this._frequencies.get(t);e!=null?this._frequencies.set(t,e+1):this._frequencies.set(t,1)}merge(t){for(const[e,s]of t._frequencies.entries()){const r=this._frequencies.get(e);r!=null?this._frequencies.set(e,r+s):this._frequencies.set(e,s)}}clone(){const t=new xe(this.field);return t._frequencies=new Map(this._frequencies),t}},Vt=class at extends fe{static createId(t,e){return`${t}.${e}`}static create(t,e,s,r){return new at(t,e,Ot.create(s),r)}constructor(t,e,s,r){super(s),this.gridX=t,this.gridY=e,this._worldUnitsPerCell=r,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return at.createId(this.gridX,this.gridY)}get containedObjectIds(){return this._objectIds}get count(){return this._count}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}get usedMemory(){return 48}clone(){const t=new at(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._firstFeatureAttributes=this._firstFeatureAttributes,t._objectIds=new Set(this._objectIds),t}insert(t,e,s,r){this._count===0?this._firstFeatureAttributes=t.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=s,this._yWorldTotal+=r,this._statistics.insert(t,e),this._objectIds.add(t.getObjectId())}merge(t){if(t._count!==0){this._count+=t._count,this._firstFeatureAttributes=t._firstFeatureAttributes,this._xWorldTotal+=t._xWorldTotal,this._yWorldTotal+=t._yWorldTotal,this._statistics.merge(t._statistics);for(const e of t._objectIds.values())this._objectIds.add(e)}}getCentroidX(t){return t==null?this.centroidXWorld:Ke(t,this.centroidXWorld)}getCentroidY(t){return t==null?this.centroidYWorld:ts(t,this.centroidYWorld)}getGeometry(t,e){const s=this.gridX*this._worldUnitsPerCell,r=this.gridY*this._worldUnitsPerCell,n=new x([4],[s,r,s+this._worldUnitsPerCell,r,s+this._worldUnitsPerCell,r+this._worldUnitsPerCell,s,r+this._worldUnitsPerCell]);if(e!=null){const a=new x;return j(a,n,!1,!1,"esriGeometryPolygon",e)}return n}getCentroid(t){const e=new x([],[this.centroidXWorld,this.centroidYWorld]);if(t!=null){const s=new x;return j(s,e,!1,!1,"esriGeometryPoint",t)}return e}getGeometricCentroid(t,e){const s=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,r=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,n=new x([],[s,r]);if(e!=null){const a=new x;return j(a,n,!1,!1,"esriGeometryPoint",e)}return n}getAttributes(){const t={aggregateId:this.id};for(const e of this._statistics.values())t[e.field.name]=e.value;return this._firstFeatureAttributes!=null?{...t,...this._firstFeatureAttributes}:t}};function ks(i,{timeZone:t,timeExtent:e}){return{$view:{scale:i,timeZone:t,timeProperties:{currentStart:e?.start,currentEnd:e?.end}}}}let Ie=class{constructor(t){this._options=t}insert(t,e){const s=t.getCursor(),{arcadeContextInfo:r,scale:n}=this._options,a=ks(n,r);for(;s.next();)this._insertFeature(s,a,this._options.sqlOptions,e)}_insertFeature(t,e,s,r){const{featureFilter:n}=this._options;if(n!==null&&!n.check(t,s))return;let a=0,o=0;if(t.geometryType==="esriGeometryPoint")a=t.readXWorldSpace(),o=t.readYWorldSpace();else{if(r){const u=t.readCentroidForDisplay();if(u==null)return;const[d,l]=u.coords;if(d<0||d>jt||l<0||l>jt)return}const h=t.readCentroidWorldSpace();if(h==null)return;a=h.coords[0],o=h.coords[1]}this._insert(t,a,o,e)}};const Os=96;function zs(i,t){return Xe(i)*Ye*Os/t}let Cs=class extends Ie{constructor(t){super(t),this._cells=new Map,this._pixelsPerMapUnit=zs(t.spatialReference,t.scale)}get usedMemory(){const t=this._cells.values().next().value;return t?(ct+t.usedMemory)*this._cells.size:0}put(t){for(const e of this._cells.values()){const s=t.get(e.id);s?s.merge(e):t.set(e.id,e.clone())}}putBounded(t,e,s){const r=[e.xmin,e.ymin,e.xmax,e.ymax],[n,a,o,h]=r,u=Math.floor(n*this._pixelsPerMapUnit/this._options.cellSize),d=Math.floor(a*this._pixelsPerMapUnit/this._options.cellSize),l=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize),_=Math.ceil(h*this._pixelsPerMapUnit/this._options.cellSize);for(let c=d;c<=_;c++)for(let f=u;f<=l;f++){const p=`${f}.${c}`,m=this._cells.get(p);if(!m)continue;const y=t.get(m.id);y?m&&!t.has(m.id)&&y.merge(m):t.set(m.id,m.clone())}}_insert(t,e,s,r){const n=e*this._pixelsPerMapUnit,a=s*this._pixelsPerMapUnit,o=Math.floor(n/this._options.cellSize),h=Math.floor(a/this._options.cellSize);this._getCellOrCreate(o,h).insert(t,r,e,s)}_getCellOrCreate(t,e){const s=Vt.createId(t,e);let r=this._cells.get(s);if(!r){const n=1*this._options.cellSize/this._pixelsPerMapUnit;r=Vt.create(t,e,this._options.fields,n),this._cells.set(s,r)}return r}};function ut(i,t){if(!(this instanceof ut))return new ut(i,t);this._maxEntries=Math.max(4,i||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&(typeof t=="function"?this.toBBox=t:this._initFormat(t)),this.clear()}function Ns(i,t,e){if(!e)return t.indexOf(i);for(var s=0;s<t.length;s++)if(e(i,t[s]))return s;return-1}function N(i,t){X(i,0,i.children.length,t,i)}function X(i,t,e,s,r){r||(r=$(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var n,a=t;a<e;a++)n=i.children[a],Y(r,i.leaf?s(n):n);return r}function Y(i,t){return i.minX=Math.min(i.minX,t.minX),i.minY=Math.min(i.minY,t.minY),i.maxX=Math.max(i.maxX,t.maxX),i.maxY=Math.max(i.maxY,t.maxY),i}function Qt(i,t){return i.minX-t.minX}function Ht(i,t){return i.minY-t.minY}function bt(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function K(i){return i.maxX-i.minX+(i.maxY-i.minY)}function $s(i,t){return(Math.max(t.maxX,i.maxX)-Math.min(t.minX,i.minX))*(Math.max(t.maxY,i.maxY)-Math.min(t.minY,i.minY))}function As(i,t){var e=Math.max(i.minX,t.minX),s=Math.max(i.minY,t.minY),r=Math.min(i.maxX,t.maxX),n=Math.min(i.maxY,t.maxY);return Math.max(0,r-e)*Math.max(0,n-s)}function vt(i,t){return i.minX<=t.minX&&i.minY<=t.minY&&t.maxX<=i.maxX&&t.maxY<=i.maxY}function tt(i,t){return t.minX<=i.maxX&&t.minY<=i.maxY&&t.maxX>=i.minX&&t.maxY>=i.minY}function $(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Kt(i,t,e,s,r){for(var n,a=[t,e];a.length;)(e=a.pop())-(t=a.pop())<=s||(n=t+Math.ceil((e-t)/s/2)*s,ss(i,n,t,e,r),a.push(t,n,n,e))}ut.prototype={all:function(){return this._all(this.data,[])},search:function(i){var t=this.data,e=[],s=this.toBBox;if(!tt(i,t))return e;for(var r,n,a,o,h=[];t;){for(r=0,n=t.children.length;r<n;r++)a=t.children[r],tt(i,o=t.leaf?s(a):a)&&(t.leaf?e.push(a):vt(i,o)?this._all(a,e):h.push(a));t=h.pop()}return e},collides:function(i){var t=this.data,e=this.toBBox;if(!tt(i,t))return!1;for(var s,r,n,a,o=[];t;){for(s=0,r=t.children.length;s<r;s++)if(n=t.children[s],tt(i,a=t.leaf?e(n):n)){if(t.leaf||vt(i,a))return!0;o.push(n)}t=o.pop()}return!1},load:function(i){if(!i||!i.length)return this;if(i.length<this._minEntries){for(var t=0,e=i.length;t<e;t++)this.insert(i[t]);return this}var s=this._build(i.slice(),0,i.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var r=this.data;this.data=s,s=r}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(i){return i!=null&&this._insert(i,this.data.height-1),this},clear:function(){return this.data=$([]),this},remove:function(i,t){if(i==null)return this;for(var e,s,r,n,a=this.data,o=this.toBBox(i),h=[],u=[];a||h.length;){if(a||(a=h.pop(),s=h[h.length-1],e=u.pop(),n=!0),a.leaf&&(r=Ns(i,a.children,t))!==-1)return a.children.splice(r,1),h.push(a),this._condense(h),this;n||a.leaf||!vt(a,o)?s?(e++,a=s.children[e],n=!1):a=null:(h.push(a),u.push(e),e=0,s=a,a=a.children[0])}return this},toBBox:function(i){return i},compareMinX:Qt,compareMinY:Ht,toJSON:function(){return this.data},fromJSON:function(i){return this.data=i,this},_all:function(i,t){for(var e=[];i;)i.leaf?t.push.apply(t,i.children):e.push.apply(e,i.children),i=e.pop();return t},_build:function(i,t,e,s){var r,n=e-t+1,a=this._maxEntries;if(n<=a)return N(r=$(i.slice(t,e+1)),this.toBBox),r;s||(s=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/Math.pow(a,s-1))),(r=$([])).leaf=!1,r.height=s;var o,h,u,d,l=Math.ceil(n/a),_=l*Math.ceil(Math.sqrt(a));for(Kt(i,t,e,_,this.compareMinX),o=t;o<=e;o+=_)for(Kt(i,o,u=Math.min(o+_-1,e),l,this.compareMinY),h=o;h<=u;h+=l)d=Math.min(h+l-1,u),r.children.push(this._build(i,h,d,s-1));return N(r,this.toBBox),r},_chooseSubtree:function(i,t,e,s){for(var r,n,a,o,h,u,d,l;s.push(t),!t.leaf&&s.length-1!==e;){for(d=l=1/0,r=0,n=t.children.length;r<n;r++)h=bt(a=t.children[r]),(u=$s(i,a)-h)<l?(l=u,d=h<d?h:d,o=a):u===l&&h<d&&(d=h,o=a);t=o||t.children[0]}return t},_insert:function(i,t,e){var s=this.toBBox,r=e?i:s(i),n=[],a=this._chooseSubtree(r,this.data,t,n);for(a.children.push(i),Y(a,r);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(r,n,t)},_split:function(i,t){var e=i[t],s=e.children.length,r=this._minEntries;this._chooseSplitAxis(e,r,s);var n=this._chooseSplitIndex(e,r,s),a=$(e.children.splice(n,e.children.length-n));a.height=e.height,a.leaf=e.leaf,N(e,this.toBBox),N(a,this.toBBox),t?i[t-1].children.push(a):this._splitRoot(e,a)},_splitRoot:function(i,t){this.data=$([i,t]),this.data.height=i.height+1,this.data.leaf=!1,N(this.data,this.toBBox)},_chooseSplitIndex:function(i,t,e){var s,r,n,a,o,h,u,d;for(h=u=1/0,s=t;s<=e-t;s++)a=As(r=X(i,0,s,this.toBBox),n=X(i,s,e,this.toBBox)),o=bt(r)+bt(n),a<h?(h=a,d=s,u=o<u?o:u):a===h&&o<u&&(u=o,d=s);return d},_chooseSplitAxis:function(i,t,e){var s=i.leaf?this.compareMinX:Qt,r=i.leaf?this.compareMinY:Ht;this._allDistMargin(i,t,e,s)<this._allDistMargin(i,t,e,r)&&i.children.sort(s)},_allDistMargin:function(i,t,e,s){i.children.sort(s);var r,n,a=this.toBBox,o=X(i,0,t,a),h=X(i,e-t,e,a),u=K(o)+K(h);for(r=t;r<e-t;r++)n=i.children[r],Y(o,i.leaf?a(n):n),u+=K(o);for(r=e-t-1;r>=t;r--)n=i.children[r],Y(h,i.leaf?a(n):n),u+=K(h);return u},_adjustParentBBoxes:function(i,t,e){for(var s=e;s>=0;s--)Y(t[s],i)},_condense:function(i){for(var t,e=i.length-1;e>=0;e--)i[e].children.length===0?e>0?(t=i[e-1].children).splice(t.indexOf(i[e]),1):this.clear():N(i[e],this.toBBox)},_initFormat:function(i){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(i[0])),this.compareMinY=new Function("a","b",t.join(i[1])),this.toBBox=new Function("a","return {minX: a"+i[0]+", minY: a"+i[1]+", maxX: a"+i[2]+", maxY: a"+i[3]+"};")}};let Bs=class be{static fromReader(t){const e=[],s=t.copy(),r=ne();for(;s.next();)s.getBounds(r)&&e.push(s.getIndex());const n=ut(9,a=>(s.setIndex(a),{minX:s.getBoundsXMin(),minY:s.getBoundsYMin(),maxX:s.getBoundsXMax(),maxY:s.getBoundsYMax()}));return n.load(e),new be(n,e.length)}constructor(t,e){this._index=t,this._size=e}get usedMemory(){return this._size*ct}search(t){const e={minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]};return this._index.search(e)}};const Ws=64;function Ds(i,t,e,s){const r=[i.xmin,i.ymin,i.xmax,i.ymax],n=je.fromExtent(Ee(r,s)),a=ht(n,s,w.WGS84,{extendedParams:{densificationStep:t*Ws}});if(!a)return null;const o=he(new x,a,!1,!1),h=o.coords.filter((m,y)=>!(y%2)),u=o.coords.filter((m,y)=>y%2),d=Math.min(...h),l=Math.min(...u),_=Math.max(...h),c=Math.max(...u),f=Ct(d,l,e,w.WGS84),p=Ct(_,c,e,w.WGS84);return f&&p?{bounds:r,geohashBounds:{xLL:f[0],yLL:f[1],xTR:p[0],yTR:p[1]},level:e}:null}function Ct(i,t,e,s){if(s.isWebMercator){const a=Wt(i/Dt.radius),o=a-360*Math.floor((a+180)/360),h=[0,0];return te(h,0,Wt(Math.PI/2-2*Math.atan(Math.exp(-t/Dt.radius))),o,e),h}const r=ht({x:i,y:t},s,w.WGS84);if(!r)return null;const n=[0,0];return te(n,0,r.y,r.x,e),n}function Gs(i,t){let e=-90,s=90,r=-180,n=180;for(let a=0;a<t;a++){const o=Math.ceil((a+1)/2),h=Math.floor((a+1)/2),u=1-a%2,d=30-(3*o+2*h),l=30-(2*o+3*h),_=3*u+2*(1-u),c=2*u+3*(1-u),f=3*u+7*(1-u)<<l,p=(7*u+3*(1-u)<<d&i.geohashX)>>d,m=(f&i.geohashY)>>l;for(let y=_-1;y>=0;y--){const v=(r+n)/2,g=p&1<<y?1:0;r=(1-g)*r+g*v,n=(1-g)*v+g*n}for(let y=c-1;y>=0;y--){const v=(e+s)/2,g=m&1<<y?1:0;e=(1-g)*e+g*v,s=(1-g)*v+g*s}}return[r,e,n,s]}function te(i,t,e,s,r){r%2&&(r+=1);let n=0,a=0,o=-90,h=90,u=-180,d=180;for(let l=0;l<r/2;l++){for(let _=0;_<5;_++){const c=(u+d)/2,f=s>c?1:0;n|=f<<29-(_+5*l),u=(1-f)*u+f*c,d=(1-f)*c+f*d}for(let _=0;_<5;_++){const c=(o+h)/2,f=e>c?1:0;a|=f<<29-(_+5*l),o=(1-f)*o+f*c,h=(1-f)*c+f*h}}i[2*t]=n,i[2*t+1]=a}const ee=32;class A extends fe{static create(t,e,s,r){const n=Ot.create(t),a=new Array(ee);for(let o=0;o<a.length;o++)a[o]=null;return new A(n,e,s,r,a)}constructor(t,e,s,r,n){super(t),this.xNode=e,this.yNode=s,this.depth=r,this.children=n,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}static get estimatedMemory(){let t=0;return t+=2*E,t+=ct*ee,t+=Ot.estimatedMemory,t}get id(){return`${this.xNode}.${this.yNode}`}get containedObjectIds(){return this._objectIds}get count(){return this._count}clone(){const t=new A(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._xGeohashTotal=this._xGeohashTotal,t._yGeohashTotal=this._yGeohashTotal,t.next=this.next,t._objectIds=new Set(this._objectIds),t}insert(t,e,s,r,n,a){this._count+=1,this._xWorldTotal+=e,this._yWorldTotal+=s,this._xGeohashTotal+=r,this._yGeohashTotal+=n,this._statistics.insert(t,a),this._objectIds.add(t.getObjectId())}merge(t){if(t._count!==0){this._count+=t._count,this._xWorldTotal+=t._xWorldTotal,this._yWorldTotal+=t._yWorldTotal,this._xGeohashTotal+=t._xWorldTotal,this._yGeohashTotal+=t._yWorldTotal,this._statistics.merge(t._statistics);for(const e of t._objectIds.values())this._objectIds.add(e)}}getCentroid(t){throw new Error("getCentroid not supported for GeohashNode")}getGeometry(t,e){const s=this._getLngLatBounds(),[r,n,a,o]=s,h=ht({rings:[[[r,n],[r,o],[a,o],[a,n],[r,n]]]},w.WGS84,t),u=he(new x,h,!1,!1);return e!=null?j(new x,u,!1,!1,"esriGeometryPolygon",e,!1,!1):u}getGeometricCentroid(t,e){const s=this._getLngLatBounds(),[r,n,a,o]=s,h=ht({x:(r+a)/2,y:(n+o)/2},w.WGS84,t),u=es(new x,h);return e!=null?j(new x,u,!1,!1,"esriGeometryPoint",e,!1,!1):u}getAttributes(){const t={aggregateId:this.id};for(const e of this._statistics.values())t[e.field.name]=e.value;return t.aggregateCount=this._count,t}find(t,e,s,r,n,a){if(r>=s)return this;const o=1-r%2,h=3*o+2*(1-o),u=2*o+3*(1-o),d=30-n-h,l=30-a-u,_=((t&7*o+3*(1-o)<<d)>>d)+((e&3*o+7*(1-o)<<l)>>l)*(8*o+4*(1-o)),c=this.children[_];return c==null?null:c.find(t,e,s,r+1,n+h,a+u)}_getLngLatBounds(){const t=this.depth,e=Math.ceil(t/2),s=Math.floor(t/2),r=30-(3*e+2*s),n=30-(2*e+3*s),a=this.xNode<<r,o=this.yNode<<n;return Gs({geohashX:a,geohashY:o},this.depth)}}class Xs{constructor(t){this._fields=t,this._size=0,this._depth=0,this._root=A.create(this._fields,0,0,0)}destroy(){}get size(){return this._size}get depth(){return this._depth}get usedMemory(){return this._size*A.estimatedMemory}find(t,e,s){return this._root.find(t,e,s,0,0,0)}insert(t,e,s,r,n,a,o){let h=this._root,u=0,d=0,l=0;for(;h!==null;){if(h.insert(t,e,s,r,n,o),u>=a)return;const _=Math.ceil((u+1)/2),c=Math.floor((u+1)/2),f=1-u%2,p=30-(3*_+2*c),m=30-(2*_+3*c),y=(r&7*f+3*(1-f)<<p)>>p,v=(n&3*f+7*(1-f)<<m)>>m,g=y+v*(8*f+4*(1-f));d=d<<3*f+2*(1-f)|y,l=l<<2*f+3*(1-f)|v,h.children[g]==null&&(h.children[g]=A.create(this._fields,d,l,u+1),this._depth=Math.max(this._depth,u+1),this._size+=1),u+=1,h=h.children[g]}}putBins(t,e){for(const s of this.getNodes(e)){const r=t.get(s.id);r?r.merge(s):t.set(s.id,s.clone())}}getNodes(t){const e=[],{geohashBounds:s,level:r}=t;let n=this._root;for(;n!==null;){const a=n.depth,o=n.xNode,h=n.yNode;if(a>=r){e.push(n),n=n.next;continue}const u=Math.ceil((a+1)/2),d=Math.floor((a+1)/2),l=1-a%2,_=30-(3*u+2*d),c=30-(2*u+3*d),f=~((1<<_)-1),p=~((1<<c)-1),m=(s.xLL&f)>>_,y=(s.yLL&p)>>c,v=(s.xTR&f)>>_,g=(s.yTR&p)>>c,T=o<<3*l+2*(1-l),C=h<<2*l+3*(1-l),R=T+8*l+4*(1-l),U=C+4*l+8*(1-l),S=Math.max(T,m),I=Math.max(C,y),b=Math.min(R,v),Z=Math.min(U,g);let F=null,_t=null;for(let mt=I;mt<=Z;mt++)for(let pt=S;pt<=b;pt++){const Te=pt-T+(mt-C)*(8*l+4*(1-l)),W=n.children[Te];W&&(F||(F=W,F.next=n.next),_t&&(_t.next=W),_t=W,W.next=n.next)}n=F||n.next}return e}}let Ys=class extends Ie{constructor(t){super(t),this._tree=new Xs(this._options.fields)}get usedMemory(){return this._tree.usedMemory}put(t){throw new Error("Geohash tree does not support put")}putBounded(t,e,s){const{geohashLevel:r,spatialReference:n}=this._options,a=Ds(e,s,r,n);a!=null&&this._tree.putBins(t,a)}_insert(t,e,s,r){const{geohashLevel:n,spatialReference:a}=this._options,o=Ct(e,s,n,a);o&&this._tree.insert(t,e,s,o[0],o[1],n,r)}},js=class ot extends Bt{static from(t,e){if(t instanceof this){const s=new Set(e),r=t._indices.filter(n=>s.has(n));return new ot(t._reader,r)}return new ot(t.copy(),e)}constructor(t,e){super(t.metadata),this._currentIndex=-1,this._displayTransform=null,this._reader=t,this._indices=e}setTransformForDisplay(t){const e=this._reader.getInTransform();if(e==null)return void(this._displayTransform=yt(t));const s=yt(e),r=yt(t),[n,a]=s.scale,[o,h]=s.translate,[u,d]=r.scale,[l,_]=r.translate,c=n/u,f=a/d,p=(o-l)/u,m=(h-_)/d;this._displayTransform={originPosition:"lowerLeft",scale:[1/c,1/f,1,1],translate:[-p/c,-m/f,0,0]}}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const t=new ot(this._reader.copy(),this._indices);return t._currentIndex=this._currentIndex,t._displayTransform=this._displayTransform,t._processorAttributes=this._processorAttributes,t}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(t){this._reader.contextTimeZone=t}get usedMemory(){return E+this._reader.usedMemory}setProcessorAttributes(t){this._processorAttributes=Object.assign(this._processorAttributes??{},t)}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._displayTransform?wt(this._displayTransform,this._reader.readXForDisplay()):this._reader.readXForDisplay()}readYForDisplay(){return this._displayTransform?Tt(this._displayTransform,this._reader.readYForDisplay()):this._reader.readYForDisplay()}readGeometryForDisplay(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform):this._reader.readGeometryForDisplay()}readCentroidForDisplay(){const t=this._reader.readCentroidForDisplay()?.clone();if(t){const[e,s]=t.coords;this._displayTransform?(t.coords[0]=wt(this._displayTransform,e),t.coords[1]=Tt(this._displayTransform,s)):(t.coords[0]=e,t.coords[1]=s)}return t}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(t,e=!1){const s=this._reader.readAttribute(t,e);return s==null&&this._processorAttributes?this._processorAttributes[t]:s}readAttributes(){return{...this._processorAttributes,...this._reader.readAttributes()}}joinAttributes(t){return this._reader.joinAttributes(t)}getBounds(t){return this._reader.getBounds(t)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(t){return this._reader.setDisplayId(t)}setIndex(t){return this._reader.setIndex(t)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(t&&{x:t.coords[0],y:t.coords[1]})??null}}readLegacyGeometryForDisplay(){const t=this.readGeometryForDisplay();return st(t,this.geometryType,!1,!1)}readGeometryArea(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform)?.area()??0:this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(t,e){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(t){return this._reader.field(t)}hasField(t){return this._reader.hasField(t)}setField(t,e){return this._reader.setField(t,e)}keys(){return this._reader.keys()}castToText(t=!1){return this._reader.castToText(t)}},ve=class{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._aggregateIndex=null,this._aggregateIndexHash=null,this._spatialIndex=null}get usedMemory(){let t=0;return t+=this.reader.underlyingMemory,this._aggregateIndex&&(t+=this._aggregateIndex.usedMemory),this._spatialIndex&&(t+=this._spatialIndex.usedMemory),t}registerOverrides(t){this.reader.registerOverrides(t),this.invalidate()}queryFeaturesInBounds(t){const e=this._getSpatialIndex().search(t);return js.from(this.reader,e)}getAggregateIndex(t){const e=JSON.stringify(t);if(e!==this._aggregateIndexHash){switch(this._aggregateIndexHash=e,t.type){case"grid":this._aggregateIndex=new Cs(t);break;case"geohash":this._aggregateIndex=new Ys(t)}this._aggregateIndex.insert(this.reader,this.isTiled)}return this._aggregateIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=Bs.fromReader(this.reader)),this._spatialIndex}};const se=1e4,Es=1e3;class dt{static async create(t){const{metadata:e,definitionExpression:s}=t,r=s?await Re(s,e.fieldsIndex):null;return new dt(e,r,s)}constructor(t,e,s){this.metadata=t,this._clause=e,this._definitionExpression=s}get hash(){return this._definitionExpression}testFeature(t){return this._clause==null||this._clause.testFeature(t)}}class lt{constructor(){this.modified=new Map,this.removed=new Set}modify(t){this.modified.set(t.objectId,t),this.removed.has(t.objectId)&&this.removed.delete(t.objectId)}remove(t){this.modified.delete(t),this.removed.add(t)}get isEmpty(){return this.modified.size===0&&this.removed.size===0}applyWhereClause(t){const e=new lt;for(const[s,r]of this.modified)t.testFeature(r)?e.modified.set(s,r):e.removed.add(r.objectId);for(const s of this.removed)e.removed.add(s);return e}}let Rs=class Me extends ve{constructor(t){super(),this._reader=t,this.chunkId="override",this.normalizedChunkId="override"}static fromFeatures(t,e){const s=ce.fromOptimizedFeatures(t,e);return new Me(s)}get reader(){return this._reader}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}getTileReader(t){if(!this._reader.getSize())return null;const e=this.queryFeaturesInBounds(t.bounds);return e.setTransformForDisplay(t.transform),e}};class et{constructor(t,e){this.inner=t,this.isWeak=e,this.lastWeak=null}get isStrong(){return!this.isWeak}}class Us{constructor(t){this._parameters=t,this._overrides=new Map,this._update=new lt,this._lastCleanup=0}update(t){this._parameters=t}hasOverride(t){return this._overrides.has(t)}onChunkInsert(t){if(this._overrides.size){const e=t.reader.getCursor();for(;e.next();){const s=e.getObjectId(),r=this._overrides.get(s);if(r?.lastWeak&&(r.lastWeak=null),r?.isWeak){const n=e.readOptimizedFeatureWorldSpace(),a=r.inner?.attributes??{};n.attributes={...a,...n.attributes},r.inner=n,this._update.modify(n),this.invalidate()}}}t.registerOverrides(this)}apply(t,e){const{updateWeak:s,removeWeak:r,update:n,remove:a,release:o}=t.commands;this.invalidate();for(const h of s){const u=new et(h,!0),d=this._overrides.get(h.objectId);d?.isStrong?d.lastWeak=u:(this._overrides.set(h.objectId,u),this._update.modify(h))}for(const h of n){const u=new et(h,!1),d=this._overrides.get(h.objectId);u.lastWeak=d?.isWeak?d:d?.lastWeak??null,this._overrides.set(h.objectId,u),this._update.modify(h)}for(const h of r){const u=new et(null,!0),d=this._overrides.get(h);d?.isStrong?d.lastWeak=u:(this._overrides.set(h,u),this._update.remove(h))}for(const h of a){const u=new et(null,!1),d=this._overrides.get(h);u.lastWeak=d?.isWeak?d:d?.lastWeak??null,this._overrides.set(h,u),this._update.remove(h)}if(o.length){const h=new Set;for(const u of o){const d=this._overrides.get(u);d?.lastWeak?(this._overrides.set(u,d.lastWeak),d.lastWeak.inner==null?this._update.remove(u):this._update.modify(d.lastWeak.inner)):d&&!d.isWeak&&(this._overrides.delete(u),h.add(u))}e.forEachUnsafe(u=>{const d=u.getObjectId();h.has(d)&&(this._update.modify(u.readOptimizedFeatureWorldSpace()),h.delete(d))});for(const u of h.values())this._update.remove(u)}}clearWeakOverrides(){for(const[t,e]of this._overrides.entries())e.isWeak&&this._overrides.delete(t);this.invalidate()}cleanup(t){if(this._overrides.size<se)return;const e=performance.now();if(e-this._lastCleanup<Es)return;this._lastCleanup=e;const s=this._getWeakDeletions();if(!(s.size<se)){for(const r of t){const n=r.reader.withoutOverrides().getCursor();for(;n.next();){const a=n.getObjectId();s.delete(a)}}for(const r of s)this._overrides.delete(r);s.size&&this.invalidate()}}takeOverrideUpdate(){const t=this._update;return t.isEmpty?null:(this._update=new lt,t.applyWhereClause(this._parameters))}asChunk(){const t=this._parameters;if(this._lastOverrideParametersHash!==t.hash&&(this._lastOverrideParametersHash=t.hash,this._chunk=null),!this._chunk){const e=[];for(const s of this._overrides.values())s.inner!=null&&t.testFeature(s.inner)&&e.push(s.inner);this._chunk=Rs.fromFeatures(e,t.metadata)}return this._chunk}invalidate(){this._chunk=null}putWeakObjectIdsFromGlobalIds(t,e,s){for(const[r,n]of this._overrides.entries()){if(n.isWeak&&n.inner!=null){const a=n.inner.attributes[s];a&&e.has(a)&&!t.has(a)&&t.set(a,r);continue}if(n.lastWeak!=null&&n.lastWeak.inner!=null){const a=n.lastWeak.inner.attributes[s];a&&e.has(a)&&!t.has(a)&&t.set(a,r)}}}_getWeakDeletions(){const t=new Set;for(const[e,s]of this._overrides.entries())s.isWeak&&s.inner==null&&t.add(e);return t}}class mr extends ve{constructor(t,e,s,r,n=0){super(),this._reader=t,this._queryJSON=e,this._page=s,this._end=r,this._fileIndex=n,this.chunkId=`${this._fileIndex}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(t){const e=this.queryFeaturesInBounds(t.bounds);return e.setTransformForDisplay(t.transform),e}}let G;class we extends Bt{constructor(t,e,s,r,n,a=new Uint32Array(s.size())){super(t),this._fields=e,this._inner=s,this._chunkId=r,this._fileIndex=n,this._displayIds=a,this._index=-1,this.usedMemory=E,this._size=this._inner.size(),t.featureIdInfo.type,this._chunkId>65535&&console.error("Exceeded max allowed parquet reader size")}destroy(){super.destroy(),this._inner.free()}get fields(){return this._fields}get geometryType(){return this.metadata.geometryType}get hasFeatures(){return!0}get hasNext(){throw new Error("Method not implemented.")}get exceededTransferLimit(){return!1}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return null}getSize(){return this._size}getCursor(){return this.copy()}getAttributeHash(){let t="";for(const e of this.fields.fields)t+=this._readAttribute(e.name,!1)+".";return t}getObjectId(){return this._fileIndex<<24|this._inner.rowId(this._index)}getDisplayId(){return this._displayIds[this._index]}setDisplayId(t){this._displayIds[this._index]=t}setIndex(t){this._index=t}getBoundsXMin(){return this._inner.boundsXMin(this._index)}getBoundsYMin(){return this._inner.boundsYMin(this._index)}getBoundsXMax(){return this._inner.boundsXMax(this._index)}getBoundsYMax(){return this._inner.boundsYMax(this._index)}setBoundsXMin(t){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMin(t){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsXMax(t){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMax(t){throw new Error("InternalError: Setting bounds is unsupported")}getIndex(){return this._index}next(){for(;++this._index<this._size&&!this._getExists(););return this._index<this._size}readGeometryArea(){return this.readGeometryForDisplay()?.area()??0}copy(){const t=new we(this.metadata,this._fields,this._inner,this._chunkId,this._fileIndex,this._displayIds);return this.copyInto(t),t}copyInto(t){super.copyInto(t),t._index=this._index}readGeometryForDisplayTransformed(t){const[e,s]=t.translate,[r,n]=t.scale;return G||(G=Le.new()),this._inner.transformGeometry(G,e,s,r,n,this._index)?new x(G.readLengthsUnsafe(),G.readCoordsUnsafe()):null}_readGeometry(t){const e=this._inner.readCoords(this._index),s=this._inner.readLengths(this._index);return e&&s?new x(s,e):null}_readX(){return this._inner.readX(this._index)}_readY(){return this._inner.readY(this._index)}_readServerCentroid(){return null}_readAttribute(t,e){const s=this.fields.get(t);if(!s)return;if(s.column==null)return this.getObjectId();const r=this._inner.readAttribute(this._index,s.column);if(r==null)return r;const n=this.fields.isDateField(s.name);return e?r==null?r:n?new Date(r):r:r}_readAttributes(){const t={};for(const e of this._fields.fields)e.column!=null&&(this._inner.isEmpty(e.column)||(t[e.name]=this._readAttribute(e.name,!1)));return t.__OBJECTID=this.getObjectId(),t}}class pr{constructor(){this._chunks=new Map,this._chunksToRemove=[],this.events=new Ue,this.featureAdapter=new bs}destroy(){this.clear()}clear(){for(const t of this._chunks.values())this._chunksToRemove.push(t);this._chunks.clear(),this._overrides?.clearWeakOverrides()}get usedMemory(){let t=0;for(const e of this._chunks.values())t+=e.usedMemory;return t}async update(t){if(this._overrides){const e=await dt.create(t);this._overrides.update(e)}this._schema=t}*chunks(){this._overrides&&(yield this._overrides.asChunk()),yield*this._chunks.values()}insert(t){O("esri-2d-update-debug")&&console.debug(`Chunk[${t.chunkId}] SourceChunkStore.insert`),this._overrides?.onChunkInsert(t),this._chunks.set(t.chunkId,t),this.events.emit("changed")}remove(t){O("esri-2d-update-debug")&&console.debug(`Chunk[${t.chunkId}] SourceChunkStore.remove`),this._chunks.delete(t.chunkId),this._chunksToRemove.push(t)}removeById(t){O("esri-2d-update-debug")&&console.debug(`Chunk[${t}] SourceChunkStore.remove`);const e=this._chunks.get(t);this._chunks.delete(t),e&&this._chunksToRemove.push(e)}cleanup(){const t=this._chunksToRemove;return this._chunksToRemove=[],this._overrides?.cleanup(this._chunks.values()),t}async applyOverride(t){if(this._overrides==null){const e=await dt.create(this._schema);this._overrides=new Us(e);for(const s of this._chunks.values())this._overrides.onChunkInsert(s)}this._overrides.apply(t,this),this.events.emit("changed");for(const e of this._chunks.values())e.invalidate()}takeOverrideUpdate(){return this._overrides?.takeOverrideUpdate()}refresh(){this.events.emit("refresh")}forEach(t){const e=new Set;for(const s of this.chunks()){const r=s.reader.getCursor();for(;r.next();){const n=r.getObjectId();e.has(n)||(t(r.copy()),e.add(n))}}}forEachUnsafe(t){const e=new Set;for(const s of this.chunks()){const r=s.reader.getCursor();for(;r.next();){const n=r.getObjectId();e.has(n)||(t(r),e.add(n))}}}mapObjectIdsFromGlobalIds(t,e){const s=new Map,r=new Set(t);return this._overrides?.putWeakObjectIdsFromGlobalIds(s,r,e),this._forEachUnsafeIgnoreOverrides(n=>{const a=n.readAttribute(e);if(a&&r.has(a)&&!s.has(a)){const o=n.getObjectId();s.set(a,o)}}),s}forEachInBounds(t,e){const s=new Set;for(const r of this.chunks()){const n=r.queryFeaturesInBounds(t);for(;n.next();){const a=n.getObjectId();s.has(a)||(e(n.copy()),s.add(a))}}}forEachBounds(t,e){const s=ne();for(const r of t)r.getBounds(s)&&e(s)}_forEachUnsafeIgnoreOverrides(t){const e=new Set;for(const s of this._chunks.values()){const r=s.reader.withoutOverrides().getCursor();for(;r.next();){const n=r.getObjectId();e.has(n)||(t(r),e.add(n))}}}}export{Bt as O,we as a,$t as b,nr as c,ar as d,le as e,us as f,zs as g,Vt as h,hr as i,ks as j,Rs as k,ns as l,js as m,pr as n,Ot as o,ds as p,ve as q,bs as r,mr as t,ce as u};
